# Server-Side Request Forgery

[![ssrfqi](../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![testingforssrf](../../../_badges/owasp/testingforssrf.svg)](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery)
[![server_side_request_forgery](../../../_badges/poat/server_side_request_forgery.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)

<div class="row row-cols-md-2"><div>

Server-Side Request Forgery (**SSRF**) is possible when a server "A" is making a request to a server "B" while creating a request using input that can be injected by the user.

It could be 

* a website using an internal/external API
* a website using resources located on another machine
* ...

There are two kinds of SSRF

* **Regular/in-band SSRF**: the client will see the result
* **Blind/out-band SSRF**: nothing is returned to the client
  * You can use [Burp Collaborator client](https://portswigger.net/burp/documentation/desktop/tools/collaborator-client)
  * You can use [requestbin](https://requestbin.com/)
</div><div>

SSRF can be used by hackers to

* map an internal network (ports/...)
* steal API credentials
* steal files
* ...

A vulnerable entry point to this attack could be

* a URL <small>(is there a route/path/partial path looking like an API call?)</small>
* a form <small>(a normal field such as a form in which we need to pick an avatar in a list of images, a hidden field...)</small>
* a script
* a header
* ...
</div></div>

<hr class="sep-both">

## Some examples

<div class="row row-cols-md-2"><div>

**Access another untended path** ‚úÇ<br> `a?api=path` $\to$ `b/path`

In that case, you could guess that the first server A is mapping the value given to `api` to the server b. You may try to inject the path, and see if you can access other API routes.

**Phishing** üé£<br> `a?url=some_url` $\to$ `a?url=malicious_url`

An **open redirect** endpoint is redirecting every user to another URL. For instance, in emails, tools such as HubSpot, replace every link in a mail with another one that will redirect to the original one, but it records that the user opened the link at XXX, so that the company will understand their users behaviors. Well, if a website doing this redirect does not check the URL the user is redirected to, then a hacker may be able to use a trusted website (a trusted URL) to redirect targets (fishes üêü) to a malicious website.

</div><div>

**Steal API credentials** üóùÔ∏è<br> `a?api=xxx&r=path` $\to$ `xxx.b/path`

If the programmer is using user input to determine which server will be queried, then the hacker may try to send the request to their servers instead, and get the API credentials inside the headers. For instance, with the `api=xxx`, a normal request is intended to be sent to `xxx.thebestapi.com/path`. But, if a hacker uses `api=malicious_website.com&ignore=`, then the URL crafted is `malicious_website.com&ignore=.thebestapi.com/path`. Notice that the request is now sent to another website, and the concatenated domain name is now the value of `ignore`.

**Mapping ports/services** üó∫Ô∏è

You could enter a URL such as `http://localhost:22` to test if the port `22` is open. You could also make the server call `http://ifconfig.pro/` to get some information (IP, DNS...).

**Steal files** üí∞

You might be able to steal files too, using URLs such as `file://some/file/on/the/target`.
</div></div>

<hr class="sep-both">

## Mitigations

<div class="row row-cols-md-2"><div>

**Allow List/Whitelist**

It's usually the better way. But, if there is a condition like `the URL must start with https://example.com`, then it can be bypassed with `https://example.com.malicious.website`.

**Others**

* Check that the resource type is what was expected
* ...

</div><div>

**Deny list/Blacklist**

You may allow every IP aside from some such as localhost (127.0.0.1), or 169.254.169.254 in a cloud environment, but there are usually a lot of ways to bypass such filters. For instance, `0`, `00`, `000[...]0`, `0.0.0.0`, `127.1` (IP shortening), `2130706433` (decimal), `017700000001` (octal), and many more such as [127.0.0.1.nip.io](http://127.0.0.1.nip.io)/[localtest.me](http://localtest.me) are all resolving to `127.0.0.1`.
</div></div>