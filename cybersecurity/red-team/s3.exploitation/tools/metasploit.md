# Metasploit framework

[![metasploitintro](../../../_badges/thm/metasploitintro.svg)](https://tryhackme.com/room/metasploitintro)
[![rpmetasploit](../../../_badges/thm/rpmetasploit.svg)](https://tryhackme.com/room/rpmetasploit)
[![metasploitexploitation](../../../_badges/thmp/metasploitexploitation.svg)](https://tryhackme.com/room/metasploitexploitation)
[![meterpreter](../../../_badges/thmp/meterpreter.svg)](https://tryhackme.com/room/meterpreter)

<div class="row row-cols-md-2"><div>

The [Metasploit Framework](https://github.com/rapid7/metasploit-framework) is a penetration testing framework that you can use to test a system.

Scripts to exploit vulnerabilities are written in Ruby ðŸ’Ž. There are many scripts already available.

**Learn** ðŸŽ“

* [Metasploit Documentation](https://docs.metasploit.com/)
* [Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/) ðŸ“Œ
</div><div>

Scripts are divided into **modules** ðŸ“Œ

* **Auxiliary**: test the availability of an exploit
* **Payloads**: the data sent to perform the attack
    * Single/inline/stageless payloads <small>(1 exchange)</small>
    * Staged payloads <small>(2 exchanges)</small>
* **Exploits**: code exploiting a vulnerability
* Encoders/Evasion/NOPs
* **Post**: scripts that you can use once on the target
</div></div>

<hr class="sep-both">

## msfconsole

<div class="row row-cols-md-2"><div>

The `msfconsole` is a component of the metasploit framework used to search and  configure modules to exploit a vulnerability, and eventually, spawn a remote shell, which may be a meterpreter shell.

```shell!
$ msfconsole -q
msf6> help
msf6> help <command>
msf6> help help # example
```

You can see every command you used with `history`.
</div><div>

* [Searching exploits](files/msf_search.md) (`search`)
* [Learn about an exploit](files/msf_info.md) (`info`)
* [Select an exploit](files/msf_use.md) (`use`, `back`)
* [Configure an exploit](files/msf_configuration.md) (`options`, `show`, `set`, `setg`, `unset`)
* [Execute an exploit](files/msf_exploit.md) (`run`/`exploit`, `check`)

Each remote access is wrapped in a [session](files/msf_session.md).
</div></div>

<hr class="sep-both">

## meterpreter

<div class="row row-cols-md-2"><div>

The meterpreter is one of the components of the metasploit framework. It's a reverse shell with common scripts loaded to make [Privilege escalation](/cybersecurity/red-team/s4.privesc/index.md) and [Post-exploitation](/cybersecurity/red-team/s5.post-exploitation/index.md) easier.

It's an  **in-memory** reverse shell using encrypted communications. To upgrade a normal shell <small>(note down the sid when using `background`)</small>, use:

```ps
# upgrade
msf6 exploit('module_used')> sessions -u -1
# kill the non-meterpreter session
msf6 exploit('module_used')> sessions -k old_session_id
# move to the meterpreter session
msf6 exploit('module_used')> sessions -i new_session_id
# done
meterpreter>
```
</div><div>

**Commands that you can use in the meterpreter are different based on the payload that you used.**

Call `help` to see what you can use given the current payload.

```bash
meterpreter > help # list commands that you can use
```

<br>

**Common commands** ðŸª´

* [General commands](files/msf_common.md)
* [Linux payloads](files/msf_linux.md)
* [Windows payloads](files/msf_windows.md)

</div></div>

<hr class="sep-both">

## Uncommon usages

<div class="row row-cols-md-2"><div>

#### port scanner

The command `db_nmap` is the same as `nmap`. You will have to first set up metasploit database.

```ps
msf6> db_nmap -sV -p- IP
```

<br>

#### banner grabbing

```ps
msf6> use auxiliary/scanner/http/http_version # HTTP
```

<br>

#### SQL utility

```ps
msf6> use auxiliary/scanner/mysql/mysql_schemadump # dump cols+tables
msf6> use auxiliary/scanner/mysql/mysql_hashdump # dump dump users+hash
msf6> use mysql_sql # send SQL queries
```
</div><div>

#### nessus

The msfconsole can be used along [Nessus](/cybersecurity/red-team/s2.discovery/tools/nessus.md). See [this tutorial](https://scubarda.com/2015/11/16/launching-nessus-scans-inside-metasploit/) and [these tips](https://www.offensive-security.com/metasploit-unleashed/working-with-nessus/). Note that you need to start metasploit database first.

```bash
msf6 > load nessus
# Connect
msf6 > nessus_connect user:pass@localhost:8834
# List the scans that you did
msf6 > nessus_scan_list
# Import the result of a scan
msf6 > nessus_db_import id_you_found_in_the_list
```
</div></div>

<hr class="sep-both">

## ðŸ‘» To-do ðŸ‘»

Stuff that I found, but never read/used yet.

<div class="row row-cols-md-2"><div>

* Commands:
  * `run -j`
  * `jobs`
  * `jobs -i 0`
  * `exploit -k -z`

<details class="details-n">
<summary>metasploit database</summary>

<div class="row row-cols-md-2"><div>

First, start msf database

```bash!
$ sudo systemctl start postgresql
$ sudo msfdb init
# I got some errors, but it still works
```

Then in your msfconsole

```bash!
$ msfconsole -q
msf6 > db_status # check if connected
[*] Connected to msf. Connection type: postgresql.
```

To keep things clean and tidy, it's better to create a workspace, so that results from other scans don't get mixed up.

```bash!
msf6 > workspace # list workspaces
msf6 > workspace -a xxx # create xxx
msf6 > workspace xxx # move to xxx
msf6 > workspace -d xxx # delete xxx
```
</div><div>

* âž¡ï¸ You can start a scan and store results inside the database

For instance, a scan from [nmap](/_cybersecurity/discovery/nmap/index.md#-metasploit-and-nmap-) or [nessus](/_cybersecurity/discovery/nessus/index.md#-metasploit-and-nessus-).

* âž¡ï¸ Once you got your scan in, here are some commands

```bash!
msf6 > help hosts
# list hosts
msf6 > hosts
# add all to RHOSTS
msf6 exploit('module_used') > hosts -R
```

```bash!
msf6 > help services
# list hosts with an ftp port open
msf6 > services -S ftp
```

If you detected vulnerabilities too

```bash!
msf6 > help vulns
# hosts with a vulnerable ftp service
msf6 > vulns -s ftp
# hosts having <keyword> in a vulnerability
msf6 > vulns -S keyboard
# vulnerabilities on a port
msf6 > vulns -p port
```
</div></div>

Although Metasploit has modules to scan (`search portscan`), brute force services... They won't be listed as other existing tools are more useful.
</details>
</div><div>


* [Web delivery](https://www.offsec.com/metasploit-unleashed/web-delivery/)
* [MSF Guide](https://gitlab.com/goron/security_whitepapers/-/blob/f2e1a7a522240ad3cd9e238237342b328b1fd162/the-easiest-metasploit-guide-youll-ever-read.pdf)
* [Multiple Ways to Bypass UAC using Metasploit](https://www.hackingarticles.in/multiple-ways-to-bypass-uac-using-metasploit/)
</div></div>