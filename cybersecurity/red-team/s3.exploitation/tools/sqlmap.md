# SQLMap

[![sqlilab](../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![sqlmapessentials](../../../_badges/htb/sqlmapessentials.svg)](https://academy.hackthebox.com/course/preview/sqlmap-essentials)

<div class="row row-cols-md-2"><div>

[sqlmap](https://github.com/sqlmapproject/sqlmap) (29.4k ⭐) is a tool to detect and automatically exploit SQLi. While it may perform just fine out of the box, we will have to configure it adequately for complex targets to avoid false negatives.

To ensure the request <small>(GET/POST/PUT/...)</small> is correct, we usually capture it using a tool such as [Burp Intruder](burp.md) or from a web browser network tab, by right-clicking on the request and selecting `Copy value as cURL`.  This ensures headers and cookies are properly configured.
</div><div>

**Where to learn?** 🎓

* [Official Documentation](https://github.com/sqlmapproject/sqlmap/wiki/Usage) (📚)
* [SQLMap CheatSheet](https://www.daronwolff.com/sqlmap-cheetsheet/) (2020)
* [SQLMap CheatSheet](https://www.security-sleuth.com/sleuth-blog/2017/1/3/sqlmap-cheat-sheet) (2017)
</div></div>

<hr class="sep-both">

## Basic Overview

<div class="row row-cols-lg-2"><div>

To use the tool, we must first find a potentially vulnerable form/URL.

```ps
$ sqlmap -u example.com/?id=1 [...]              # GET
$ sqlmap -u example.com --data="id=1&p=0" [...]  # POST
$ sqlmap -u example.com --data-raw "id=1" [...]  # POST (cURL)
$ sqlmap -u URL --data="id=1" --method PUT [...] # PUT
$ sqlmap [...] -H 'Cookie: id=1' # add a header
$ sqlmap [...] --cookie='id=1'   # add a cookie
# see also: --host, --referer, -A/--user-agent, --mobile
```

After that, the tool will ask us a few questions to configure itself. We can skip them and use default values using `--batch`.

```ps
$ sqlmap [...] --batch
```

If there is a SQLi vulnerability, you can [try to exploit it](#sqlmap-exploitation).
</div><div>

**Configuration** 🐍️

**Operations** ⚒️

* `--parse-errors`: display DBMS errors in sqlmap output
* `-t /tmp/log.txt`: save sqlmap traffic to a file
* `-v n`: set the verbosity (0-6)
* `--flush-session`: clear cache

**Security by-pass** 🔏

* `--random-agent`: by-pass some WAF/...
</div></div>

<hr class="sep-both">

## SQLMap Exploitation

<div class="row row-cols-lg-2"><div>

#### Dumping Information

The may want to get some data before dumping the database.

```ps
$ sqlmap [...] --dump [...]
```

We also have switches for [well-known queries](https://github.com/sqlmapproject/sqlmap/blob/master/data/xml/queries.xml):

* `--banner`, `--hostname`: host information
* `--dbs`, `--current-db`: display all databases
* `--schema`: database schema
* `--column`: display columns
* `--column`: display columns
* See also: `--passwords`, `--is-dba`, `--current-user`

We can search for tables/columns using `--search`:

```ps
$ sqlmap [...] --search -T user # tables "*user*"
$ sqlmap [...] --search -C pass # columns "*pass*"
```

📚 See also the switch `--all`.
</div><div>

#### Dumping Records

The most common usage is to dump data.

```ps
$ sqlmap [...] --dump [...]
```

As this may involve a lot of data, we often fine-tune the extraction:

* `-D xxx`: only keep database `xxx`
* `-T xxx`: only keep table `xxx`
* `-C xx, yy`: only keep columns `xx`, and `yy`
* `--start=n`/`--stop=m`: rows to select (`[n,m]`)
* `--where="attr LIKE '%'"`: filter rows

👉 You can use `--dump-all` to dump everything in the database, but you might also want to use `--exclude-sysdbs`.

⚠️ Add `--no-cast` to ensure the values are the correct ones.

📚 You can select the dump format using `--dump-format`.
</div></div>

<hr class="sep-both">

## SQLMap Tuning

<div class="row row-cols-lg-2"><div>

#### Vulnerable Parameters

You can specify which parameters are likely to be vulnerable using `-p` or by adding `*` after the parameter value.

```
$ sqlmap [...] -p id
$ sqlmap [...] --data "id=1*" # same
```
</div><div>
</div></div>

<hr class="sep-both">

## Random Notes

<div class="row row-cols-lg-2"><div>

#### Load Request From A File

Assuming you caught a request, such as below:

```ps
$ cat request1.req
HTTP / HTTP/1.0
Host: www.example.com

{
  "id": 1
}
```

You can load it inside sqlmap using `-r`:

```ps
$ sqlmap -r /path/to/request.req [...]
```

👉 See also: [Burp Intruder](burp.md) <small>(save a request using "Save Item")</small>.
</div><div>
</div></div>

<hr class="sep-both">

## 👻 To-do 👻

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Automatic parameter finding

* `--crawl`
* `--forms`
* `-g`

XXX

* `--dbms=some_dbms`: sqlite...

Configuration 🐍️

* `--technique`: `=b`
  * `--level`:
  * `--risk`:
  * `--threads n`: use $n$ threads, work faster the more there are.

Operations ⚒️

* `--dump`:
</div><div>

* XXX
  * `--time-sec timeout`: specify a timeout
  * `--dump`: save current data
  * `--dump-all`: save all data
</div></div>