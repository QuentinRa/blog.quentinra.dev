# Third step - Exploitation

[![vulnerabilities101](../../_badges/thm/vulnerabilities101.svg)](https://tryhackme.com/room/vulnerabilities101)
[![exploitingavulnerabilityv2](../../_badges/thmp/exploitingavulnerabilityv2.svg)](https://tryhackme.com/room/exploitingavulnerabilityv2)
[![vulnerabilitycapstone](../../_badges/thmp/vulnerabilitycapstone.svg)](https://tryhackme.com/room/vulnerabilitycapstone)

<div class="row row-cols-lg-2"><div>

Exploitation ğŸ’¥ is the third step of the pentester activities. We attempt to exploit a vulnerability discovered during investigation.

Some activities are:

* ğŸ”‘ Brute forcing credentials
* ğŸ’€ Exploiting a known (unpatched) vulnerability
  * in a service
  * in an application
  * in a website/an api
  * ...
* ...

ğŸ“Œ The goal is to get **remote access to the target**.
</div><div>

You will usually look for an unpatched vulnerability, and try to exploit it to upload or run commands to create a remote shell.

Vulnerabilities can be categorized in 5 categories:

* ğŸª¸ Operating System
* ğŸ”¥ Misconfigurations <small>(Version Disclosure, Sensitive Data Exposure, Security Misconfigurations)</small>
* ğŸ” Weak credentials
* ğŸ˜ Logic flaws <small>(Insecure Deserialization)</small>
* ğŸ§‘ Human errors

Note that not all vulnerabilities are exploitable, and not all vulnerabilities have a public exploit to exploit them.
</div></div>

<hr class="sep-both">

## Exploiting Developer Files

<div class="row row-cols-lg-2"><div>

#### Version Control Files Disclosure âœï¸

Developers commonly use [version control system](/tools-and-frameworks/vcs/_general/index.md) to back up and manage the changes in the code. These may be exposed.

* [Exposed GIT Folder](/cybersecurity/red-team/s3.exploitation/vulns/disclosure/git/README.md) `[.git]` `[.gitignore]`
* Exposed SVN Folder `[.svn]`

âš ï¸ We are downloading potentially harmful files. This may lead to your host being compromised <small>(RCE, path traversal, etc.)</small>.
</div><div>
</div></div>

<hr class="sep-both">

## Exploiting Exposed Header

<div class="row row-cols-lg-2"><div>

#### Cross-Origin Resource Sharing (CORS)

CORS is a security mechanism implemented by web browsers. It prevents websites from making requests <small>(aside from GET)</small> to other websites, unless `Access-Control-Allow-Origin` allows it.

The origin is set by `fetch`/`xhr` <small>(or can be modified from Burp for tests)</small>.

```yaml!
# Ex: Access to /getToken.php (GET)
Host: vulnerable.com
Origin: https://example.com
```

If servers respond with any of these headers, verify if it was intended.

```yaml!
Access-Control-Allow-Origin: *
Access-Control-Allow-Origin: https://example.com
```

The latter may be dangerous when used with `Access-Control-Allow-Credentials: true` as the client cookie from `vulnerable.com` will be sent along the request to `/getToken.php` <small>(and example gets the token)</small>.

âš ï¸ This vulnerability doesn't seem to work in modern browsers.

ğŸ›¡ï¸ Only allow trusted origins to access your API.
</div><div>
</div></div>

<hr class="sep-both">

## Exploiting Query Parameters

<div class="row row-cols-lg-2"><div>

#### Open Redirect

[![unvalidated_redirects](../../_badges/owasp/unvalidated_redirects.svg)](https://cheatsheetseries.owasp.org/cheatsheets/Unvalidated_Redirects_and_Forwards_Cheat_Sheet.html)
[![session_security](../../_badges/htb/session_security.svg)](https://academy.hackthebox.com/course/preview/session-security)
[![http_open_redirect](../../_badges/rootme/web_server/http_open_redirect.svg)](https://www.root-me.org/en/Challenges/Web-Server/HTTP-Open-redirect)

Many pages within an application are redirecting the user. This is commonly the case with the `login` and `logout` pages.

```html!
<a href="/logout?path=/home">Logout</a>
```

If the input is not validated enough, we may be able to redirect the user to another website. It can be used for phishing attacks.

Common bypasses are: `//example.com` or `/%2f%2fexample.com`.

ğŸ›¡ï¸ Use an allow list or disable this feature.
</div><div>
</div></div>

<hr class="sep-both">
<hr class="sep-both">
<hr class="sep-both">
<hr class="sep-both">

## Remote shell âš“

[![shells_and_payloads](../../_badges/htb/shells_and_payloads.svg)](https://academy.hackthebox.com/course/preview/shells--payloads)
[![introtoshells](../../_badges/thmp/introtoshells.svg)](https://tryhackme.com/room/introtoshells)
[![Reverse Shell](../../_badges/poat/reverse_shell.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md)

<div class="row row-cols-lg-2"><div>

In CTFs, you will most of the time be able to get a remote shell access to the target, similarily to a SSH access. There is a need for a 

* **server** which is accepting connections <small>(most likely the hacker host)</small> 
* **client** which is connecting to the server <small>(most likely the victim)</small>

There are 3 kind of ways to get a remote shell:

* [Web shell](shell/web_shell.md)
* [Reverse shell](shell/reverse_shell.md)
* [Bind shell](shell/bind_shell.md)

â¡ï¸ To avoid alerting IDS, a bind/reverse shell should use a protocol that would not be suspected such as HTTPS (`443`). 

â˜ ï¸ Most of the time, bind/reverse shells are blocked by firewalls.

ğŸ¸ See [msfvenom](/cybersecurity/red-team/tools/frameworks/metasploit/msfvenom.md) to generate shells, and [msfconsole](/cybersecurity/red-team/tools/frameworks/metasploit/_files/msf_handler.md) to catch them.
</div><div>

Most remote shells that we create are instable:

* ğŸ˜¥ you can't use commands requiring user input <small>(ex: `sudo`)</small>
* ğŸƒ You can't clear nor resize your terminal
* ğŸ¦¥ There is no auto-completion, you can't use arrows...
* â›” CTRL+C kill the shell, not the command

We can use a wrapper for the client/server <small>(the one on your machine)</small> to make things really nice, or we can [try to manually patch the shell](shell/manual.md).

* [Penelope wrapper](shell/tools/penelope.md)
* [pwncat wrapper](shell/tools/pwncat.md)
* [rlwrap wrapper](shell/tools/rlwrap.md)
* [socat wrapper](shell/tools/socat.md)

Not every shell can be upgraded <small>(test another client...)</small>. A wrapper, may be available both as client or server depending on what you do.
</div></div>

<hr class="sep-both">

## Vulnerability databases

<div class="row row-cols-md-2 mt-4"><div>

#### Vulnerabilities identifiers

To identify and classify vulnerabilities, you can use:

* ğŸ“Œ **CVE** <small>(Common Vulnerabilities and Exposures)</small> is a dictionary of every known vulnerability. The format is **CVE-YEAR-ID**.

* ğŸ“ **CWE** <small>(Common Weakness Enumeration)</small> is a list of common weaknesses in applications, grouped in categories.

* See also: [CAPEC](https://capec.mitre.org/), [ATT&CK](https://attack.mitre.org/tactics/enterprise/), CCE, CPE

<br>

#### Vulnerability scoring

There are 2 well-known systems to rank vulnerabilities.

* ğŸ€ **CVSS** <small>(Common Vulnerability Scoring System)</small> which was released in 2005, and is free and open-source. It calculated from 3 factors: Base, Temporal, and Environmental. Only the base is shown for a CVE. Use the [calculator](https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator) to compute your company-specific value.

* ğŸ’µ **VPR** <small>(Vulnerability Priority Rating)</small> is a modern way based on the risk for the organization that uses it. It ranges from 0 to 100.

<br>

#### Proof Of Concept

When a vulnerability is discovered, a proof of concept (**PoC**) may be written to demonstrate that the vulnerability is exploitable. As a pentester, you may look for them to exploit a vulnerability.

â¡ï¸ Use GitHub, GitLab, and Google to look for them...
</div><div>

There are **many** vulnerability databases. You should use 2-3 as they may have different information <small>(community info, list of exploits...)</small>.

* [**Exploit DB**](db/exploit_db.md) - CVE with exploits
* [Attacker KB](db/attacker_kb.md) - community reviews
* [**CVE details**](db/cve_details.md) - every CVE
* [CVE.ORG (MITRE)](db/cve_org.md) - every CVE
* [Snyk](db/snyk.md) - focus on web applications
* [Rapid7](db/rapid7.md) - a bit of focus on metasploit
* [Circl](db/circl.md) - simplified information for each CVE
* [**NVD**](db/nvd.md) - NIST vulnerability database (NVD)
* [MSRC](db/msrc.md) - Microsoft CVEs
* [vulners](db/vulners.md) - Vulnerabilty search engine
* [Trickest/CVE](db/trickest_cve.md) - CVE + PoC
* [CVEList](db/cvelist.md) - GIT with every CVE
* [InTheWild](db/inthewild.md) - CVE used in the "wild"
* [cxsecurity](https://cxsecurity.com/) - CVE with exploits
* [packetstormsecurity](https://packetstormsecurity.com/files/tags/exploit/) - CVE with exploits
* [GitHub Advisory Database](https://github.com/advisories) - GitHub CVE Database
* [vulnerability-lab](https://www.vulnerability-lab.com/) - Vulnerability Labs List of CVEs
* [0day.today](https://www.0day.today/) - find or purchase exploits ğŸ’µ
* [opencve](https://www.opencve.io/welcome) - CVE database aggregator

Use the [Metasploit Framework](/cybersecurity/red-team/tools/frameworks/metasploit/index.md) to use pre-written exploits usually leading to an enhanced reverse shell called meterpreter.
</div></div>

<hr class="sep-both">

## Common vulnerabilities ğŸª¦

<div class="row row-cols-md-2 mt-4"><div>

Websites ğŸŒ

* [Cross-site Scripting](vulns/web/xss.md) (XSS)
* [Cross-Site Request Forgery](vulns/web/csrf.md) (CSRF)
* [Server-Site Request Forgery](vulns/web/ssrf.md) (SSRF)
* [Command injection](vulns/injection/command.md)
* [Path traversal](vulns/web/path_traversal.md)
* [File inclusion](vulns/web/file_inclusion.md) (LFI/RFI)
* [Open Redirect](vulns/web/open_redirect.md) and [Session Fixation](vulns/web/session_fixation.md)
* [File upload](vulns/web/file_upload.md)
* [Server-Side Template Injection](vulns/injection/ssti.md) (SSTI)
* [HTTP Attacks](vulns/web/http_attacks.md) (CRLF, Verb Tampering, Request Smuggling)
* [Server Side Includes/Edge Side Includes](vulns/web/ssi_esi.md) (ESI/SSI)

Databases ğŸ’°

* [Access the file system](vulns/others/database/filesystem.md)
* [SQL injection](vulns/injection/sqli.md) (SQLi)
* [NoSQL injection](vulns/injection/nosqli.md) (NoSQLi)
* [SQL truncation](vulns/others/database/truncation.md)
* [KeePass](/cybersecurity/blue-team/tools/passwords/keepass.md) (KbDx)
</div><div>

Serialization ğŸ§ª

* [XML External Entity](vulns/serialization/xxe.md) (XXE)
* [Insecure Deserialization](vulns/serialization/insecure_deserialization.md)
* Recursive Regular Expression DoS

Memory ğŸ¥”

* [Video Game Cheating](vulns/memory/cheating.md)
* [Buffer Overflow](vulns/memory/buffer_overflow.md)
* [Format Strings](vulns/memory/format_strings.md)
* Memory leaks
* Race condition

Network ğŸŒ

* [M-I-T-M](vulns/others/network/mitm.md)

If you gain access to the source code, look back for [logic flaws](/cybersecurity/red-team/s2.discovery/techniques/websites/logic_flaws.md).
</div></div>

<hr class="sep-both">

## Common Failures

<div class="row row-cols-lg-2"><div>

**Identification and Authentication Failure** ğŸ”‘

* The website does not prevent brute force
* The website allows users to use weak passwords
* The website does not encrypt passwords

<br>

**Broken Access Control** ğŸ“­ <small>(users can access files/URLs they shouldn't)</small>

* The principle of the least privilege is not applied correctly
* Someone can use someone else token/ID to do something
* A user can access "logged-only" pages/features without logging in
</div><div>

**Injections** ğŸª¤

* There is insufficient or no validation at all
* There is insufficient or no sanitization at all

<p>&nbsp;</p>

**Cryptographic Failures** ğŸ”“

* The server is using clear text
* The server allows/uses HTTP instead of HTTPS
* The server uses a weak cryptographic algorithm
</div></div>

<hr class="sep-both">

## ğŸ‘» To-do ğŸ‘»

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Websites

* Same-Site Attacks: [CanITakeYourSubDomain](https://canitakeyoursubdomain.name/)
* [Session_fixation](https://en.wikipedia.org/wiki/Session_fixation)
</div><div>
</div></div>