# File upload Filter Bypass

<div class="row row-cols-md-2 mt-4"><div>

#### File upload Filter Bypass — Alternative Extension

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![adventofcyber2](../../../../../_badges/thm/adventofcyber2/day2.svg)](https://tryhackme.com/room/adventofcyber2)
[![adventofcyber2](../../../../../_badges/thm/adventofcyber2/day24.svg)](https://tryhackme.com/room/adventofcyber2)

The most common method is to test every extension. Please note that most extensions shown in cheatsheet are **unlikely** to be enabled.

```text!
Common: .php,.html,.js,.svg
Rare: .phar
Uncommon: .php5,.phtml,.php2,.php3,.php4,.php7,.pht,.phps,.inc
```

✅ On Windows, try `.pHp`, `.PHP`, etc.

#### File upload Filter Bypass — Null Byte

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![null_byte](../../../../../_badges/rootme/web_server/null_byte.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Null-byte)

The null byte <small>(PHP < 5.3.4)</small> could be used to bypass filters:

```text!
malicious.php%00.png -> malicious.php
malicious.php\x00.png -> malicious.php
```

On Windows, `file.php:.jpg` becomes `file.php`.
</div><div>

#### File upload Filter Bypass — Reverse Extension

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![double_extensions](../../../../../_badges/rootme/web_server/double_extensions.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Double-extensions)

When the webserver is misconfigured <small>(unrealistic, missing `$` on regex)</small> or we managed to upload a "faulty" configuration file.

```text!
malicious.php.jpg
```

#### File upload Filter Bypass — Characters

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)

* `%20` (space)
* `%0a`/`%0d%0a`/`%0d%0d%0a` (line breaks)
* `/`, `.\`, `.`, `…`

#### File Content Filter Bypass

[![uploadvulns](../../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)

If there is a filter checking for the `<?php` tag, you can try:

* testing if the filter is case-sensitive: `<?PHP`, `<?pHP`...
* testing  with another variant: `<?="xxx"?>`...
</div></div>

<hr class="sep-both">

## File spoofing

<div class="row row-cols-lg-2"><div>

#### Bypass Using Metadata

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![file_upload_zip](../../../../../_badges/rootme/web_server/file_upload_zip.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-ZIP)

We can inject code in a valid image metadata, such as with:

```ps
$ exiftool -comment="<?php phpinfo(); ?>" file.png
$ exiftool -Comment='<xss payload here>' file.png
```

#### Polyglot File

[![file_upload_polyglot](../../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)

In some scenarios, the only way to bypass mitigations is to hide two files in one, with both of them valid. It's not always possible.

Due to how a [phar](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#phar) works, it's possible to add an image such as JPG, inside the stub, before the php code.
</div><div>

#### MIME-type Filter Bypass

[![fileuploadattacks](../../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![bypassdisablefunctions](../../../../../_badges/thm-p/bypassdisablefunctions.svg)](https://tryhackme.com/r/room/bypassdisablefunctions)

[MIME-type](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types) filters may use the user content-type header send with the request, that we can easily spoof.

```text!
Content-Type: application/php -> image/png
```

If the application checks the MIME-type itself, we can spoof the file magic number. Using a command such as `file xxx`, you can see the current infered MIME-type. This is done by checking the first bytes of the file for a value called [magic numbers](https://en.wikipedia.org/wiki/List_of_file_signatures).

* Metadata - no need to use a fake mimetype

```ps
$ convert hello.jpg -set comment "<php content here>" script.jpg
```

* Fake GIF

```ps
$ echo 'GIF8<php content here>' > script.php
```

* Fake JPG

```ps
$ mv script.php script.jpg
$ file script.jpg # ASCII text
$ cat script.jpg
xxxx[...] # added 4 dummy characters at the start
$ hexeditor script.jpg # FF D8 FF E0 then CTRL+X
$ file script.jpg # JPG
```
</div></div>