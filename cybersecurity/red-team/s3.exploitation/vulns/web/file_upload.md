# File upload

[![uploadvulns](../../../../_badges/thmp/uploadvulns.svg)](https://tryhackme.com/room/uploadvulns)
[![vulnversity](../../../../_badges/thm-p/vulnversity.svg)](https://tryhackme.com/room/vulnversity)
[![rrootme](../../../../_badges/thm-p/rrootme.svg)](https://tryhackme.com/room/rrootme)
[![startup](../../../../_badges/thm-p/startup.svg)](https://tryhackme.com/room/startup)
[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)
![nibbles](../../../../_badges/htb-p/nibbles.svg)

<div class="row row-cols-md-2"><div>

It's common for websites to allow users to upload files such as an avatar. Unfortunately, in some cases, a hacker can upload malicious files such as a script leading to **Remote Code Execution** (RCE).

Usually, most websites have filters, but there are often logic flaws in the filtering, leading to malicious files successfully uploaded.
</div><div>

There may be JavaScript filters, and to be more efficient while making requests, we usually use tools such as:

* [Burp Suite](../../tools/burp.md) Repeater
* [uffuf](/cybersecurity/red-team/tools/enumeration/web/uffuf/README.md) / [uffuf](https://github.com/quentinra/blog.quentinra.dev/cybersecurity/red-team/tools/enumeration/web/uffuf/README.md)
* [curl](/operating-systems/linux/commands/list.md#command-curl)

```ps
# submit a file with name=file and value=path/to/file
$ curl -X POST -F "submit:value" -F "file:@path/to/file" URL
```

‚û°Ô∏è Refer to [File Upload Wordlists](/cybersecurity/red-team/_knowledge/topics/wordlists.md#file-upload).
</div></div>

<hr class="sep-both">

## Theoretical Process

<div class="row row-cols-md-2 mt-4"><div>

1. ‚úÖ Upload a valid file<br><span>&nbsp;</span>
2. üîç Look for the folder where the file was uploaded.

<br>

* Try to determine the naming scheme <small>(ex: {time}-{filename}.png)</small>. You may have to use [forced browsing tools](/cybersecurity/red-team/s2.discovery/techniques/forced_browsing.md) if indexing was turned off.
* Try to see the behavior if uploading a file with the same name

<br>

3. ‚õî Try to upload a file that may be rejected<br><span>&nbsp;</span>
</div><div>

4. üîì If it was rejected, try a lot of payloads to see what the filter is using to assess whether a file can/can't be accepted. See the filter evasion section below. **Test your valid file with**:

* the extension of the one that was rejected
* the MIME type of the one that was rejected
* the magic number of the one that was rejected
* ...<br><span>&nbsp;</span>

5. üí£ Try testing different file sizes to find the maximum upload size
</div></div>

<hr class="sep-both">

## Filter evasion

*PHP functions that may be involved: `pathinfo`...*

<div class="row row-cols-md-2 mt-4"><div>

* ‚û°Ô∏è The filter may uses "contains" instead of "ends with", which is often present due to the usage of a regex while missing a `$`.

```text!
malicious.png.php
```

* ‚û°Ô∏è bypass blacklists/deny list

  * Other extensions that may have been enabled: `.php5`, `.phtml`, `.php2`, `.php3`, `.php4`,`.php7`, `.pht`, `.phps`, `.phar`, `.inc`...
  * Bypass case-sensitive filters, but Linux servers will not execute them: `.pHp`, `.PHP`, `.PHTML`...<small>&nbsp;</small><br><br>

* ‚û°Ô∏è Try injecting characters

For instance, the null byte <small>(PHP < 5.3.4)</small>:

```text!
malicious.php%00.png -> malicious.php
malicious.php\x00.png -> malicious.php
```

Other characters:

* `%20` (space)
* `%0a`/`%0d%0a`/`%0d%0d%0a` (line breaks)
* `/`, `.\`, `.`, `‚Ä¶`, 
* On Windows, `file.php:.jpg` becomes `file.php`


</div><div>

* ‚û°Ô∏è If there is a filter checking for the `<?php` tag, you can try
  * testing if the filter is case-sensitive: `<?PHP`, `<?pHP`...
  * testing  with another variant: `<?="xxx"?>`...

<p></p>

* ‚û°Ô∏è bypass  [MIME-type](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types) checks by manually editing the `Content-Type` header of the request. This won't work if the server uses the magic number <small>(`mime_content_type`, etc.)</small>

```text!
Content-Type: application/php -> image/png
```

* ‚û°Ô∏è An alternative to editing MIME-type is spoofing the file magic number. Using a command such as `file xxx`, you can see the type of your file. This is done by checking the first bytes of the file for a value called [magic numbers](https://en.wikipedia.org/wiki/List_of_file_signatures)/[Apple Reference](https://opensource.apple.com/source/file/file-23/file/magic/magic.mime).

```ps
$ echo 'GIF8<content here>' > script.php # ex: fake GIF
# Ex: use JPG magic number (4 bytes: FF D8 FF E0)
$ mv script.php script.jpg
$ file script.jpg # ASCII text
$ cat script.jpg
xxxx[...] # added 4 dummy characters at the start
$ hexeditor script.jpg 
# replace the first four with the magic number
# FF D8 FF E0
# CTRL+X
$ file script.jpg # JPG
```
</div></div>

<hr class="sep-both">

## Other techniques

<div class="row row-cols-lg-2"><div>

#### Reverse Double Extension

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)

It's possible that the website administrator had misconfigured the web server, allowing files such as `script.php.jpg` to be executed.

As regexes are used to define which files can be executed, if the `$` is missing, then the server is misconfigured.

As this is not common to edit this kind of setting, it's unlikely to occur.
</div><div>

#### Side Attacks

[![fileuploadattacks](../../../../_badges/htb/fileuploadattacks.svg)](https://academy.hackthebox.com/course/preview/file-upload-attacks)

Even if the upload is not vulnerable and we can't upload a webshell, we may still be able to perform other attacks:

* Use the filename for injections <small>(command, XML, SQL, etc.)</small>

```shell!
$ file$(whoami).jpg
$ file`whoami`.jpg
$ file.jpg||whoami
```

* Using a overly long filename to try to force an error

* If we can upload a SVG, we can try a [XXE](/cybersecurity/red-team/s3.exploitation/vulns/serialization/xxe.md) attack to read the source code <small>(disclose the upload directory, etc.)</small>.

* If the websites display the metadata, we may be able to perform an [XSS](/cybersecurity/red-team/s3.exploitation/vulns/web/xss.md) attack. For instance,

```ps
$ exiftool -Comment='<xss payload here>' file.php
```
</div></div>

<hr class="sep-both">

## Mitigation üõ°Ô∏è

<div class="row row-cols-lg-2"><div>

* **Extension Validation** üîí: both blacklist and whitelist extensions. Ensure the logic checks the last extension.

* **Filetype Validation** üîë: do not use the client Content-Type/MIME type. Use the magic number to check the file type.

* **Upload Folder Disclosure** üìÅ: hide the upload folder, especially if users are not supposed to access uploaded files. If possible, ensure it is not accessible from the web <small>(see also: web root, .htaccess, etc.)</small>.

* **Server-side Validation** üìö: client-side validations are nice for normal users but not enough as they can be disabled or ignored.
</div><div>

* **Upload File(s) Disclosure** üìÑ: if the folder is accessible, access to uploaded files must be restricted based on whether should be able to access them or not. Randomize the names or avoid using user-input to name the file <small>(ex: append the extension)</small>. Disable indexing.

* Add **Upload Size** üé° restrictions and use a **WAF** üßØ

As always, we can configure the server to block some functions or disable access to folders outside the application directories.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-md-2"><div>

* [Exif Data](https://null-byte.wonderhowto.com/how-to/bypass-file-upload-restrictions-web-apps-get-shell-0323454/)
* [Disable php extension](https://stackoverflow.com/questions/1271899/disable-php-in-directory-including-all-sub-directories-with-htaccess)
* [motasem-notes](https://motasem-notes.net/bypassing-php-disable-functions-and-upload-filters-tryhackme/)
* [File Magic Numbers](https://gist.github.com/leommoore/f9e57ba2aa4bf197ebc5)
</div><div>

* FTP, if it's linked to the website folder, and we can upload files
* Decompression Bomb, Pixel Flood
* Windows specific attacks with invalid filename `(CON, COM1, LPT1, or NUL)` or reserved characters `(|, <, >, *, or ?)`
</div></div>