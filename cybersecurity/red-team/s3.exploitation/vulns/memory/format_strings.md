# Format Strings

<div class="row row-cols-lg-2"><div>

Format Strings is a bug in which user input is passed to a formatting function such as `printf` or `scanf` as the input format.

```c
printf(format, user_input); // not vulnerable
printf(user_input);         // vulnerable
```

üìö They could allow a malicious user to read/write variables, which may lead to sensitive data exposure.
</div><div>

ü™¶ Format String bugs are uncommon nowadays, mostly due to compilers notifying the developer.
</div></div>

<hr class="sep-both">

## C printf() function

<div class="row row-cols-lg-2"><div>

When a function is called, its parameters are stored in memory at a location called the stack. Given `printf("%s", str)`:

* ...
* `0x00002`: address of the `"%s"` string parameter
* `0x00003`: address of the `str` string parameter
* ...

The `printf` function is a variadic function. It will know how many parameters it has from the format string <small>(e.g., `%s`=>`n=1`)</small>.

‚úçÔ∏è If we have the following code: `printf("%s")`, the function will still try to read one string from the stack, which may crash the program.
</div><div>

We can use that to read arbitrary values. Refer to [C Types](/programming-languages/low-level/c/general/index.md#types).

* `%c`: arbitrary read a char
* `%s`: arbitrary read a string
* `%x`: arbitrary read an integer and display it as hexadecimal
* `%p`: arbitrary expose an address

üìö To read the n-th parameter that is a char `%c`, we would use: `%nth$c`. 

ü§ñ You can use `rax2 0xFFFF` to convert from hexa to decimal. You can write a number with `$n`/`$hn` like `Hello%nth$n`, `%4294967295x%nth$n` or `%65535d%nth$hn`. The number is equals to the number of written chars.
</div></div>

<hr class="sep-both">

## Python format() function

[![python_format_string](../../../../_badges/hacktricks/generic_methodologies_and_resources/python/bypass_python_sandboxes/python_format_string.svg)](https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#python-format-string)
[![python_format_string](../../../../_badges/rootme/app_script/python_format_string.svg)](https://www.root-me.org/en/Challenges/App-Script/Python-format-string)

<div class="row row-cols-lg-2"><div>

The python format function may be exploited to access variables from the code and display them. In the example below, we access the method `__init__` while any methods of the class would work. We can then relatively access other members of the class, or move up and access members of the parent `global` namespace.

```py
from secret import X # in another file
X = "xxx"            # in the same file

class X:
   pass

instance = X()
"{0.__init__}".format(x)
"{x.__init__}".format(x=x)
"{x.__init__.__globals__}".format(x=x)
"{x.__init__.__globals__[X]}".format(x=x)
"{x.__init__.__globals__[X][index]}".format(x=x) # one by one
```
</div><div>

We can alternatively use error messages.

* Since Python `3.10`, an additional message body was added when using an invalid string after "`:`".

```py
>>> "{x:toto}".format(x=5)
# ValueError: Invalid format specifier 'toto' for object of type 'int'
```

* For every version of python, an exception is raised when we use an unknown format code <small>(extraction letter by letter)</small>.

```py
>>> "{x:s}".format(x=5)
# ValueError: Unknown format code 's' for object of type 'int'
```

üìö Refer to [my cheatsheet](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#python) for more payloads.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* [axcheron](https://axcheron.github.io/exploit-101-format-strings/), [codearcana](https://codearcana.com/posts/2013/05/02/introduction-to-format-string-exploits.html), [learn-cyber](https://learn-cyber.net/article/Format-String-Vulnerabilities)
* <code>for i in `seq 1 1000`; do ./example "%$i\$s" 2> /dev/null | grep -v "Segmentation fault"; done</code>.
* `./xxx $(python2 -c 'print "A" * 400 + "%145$p"')`: found where my string is stored
</div><div>

CTFs

* [guyinatuxedo](https://guyinatuxedo.github.io/fmt.html)
</div></div>