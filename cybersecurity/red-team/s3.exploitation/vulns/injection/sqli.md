# SQL injection (SQLi)

[![sqlinjectionfundamentals](../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![SQL Injection](../../../../_badges/poat/sql_injection.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
[![sql-injection-payload-list](../../../../_badges/payloadbox/sql_injection.svg)](https://github.com/payloadbox/sql-injection-payload-list)
[![sqlinjectionlm](../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)
[![ccpentesting](../../../../_badges/thm-p/ccpentesting.svg)](https://tryhackme.com/room/ccpentesting)
[![validation](../../../../_badges/htb-p/validation.svg)](https://app.hackthebox.com/machines/Validation)
[![sql_injection_authentication](../../../../_badges/rootme/web_server/sql_injection_authentication.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-authentication)
[![sql_injection_string](../../../../_badges/rootme/web_server/sql_injection_string.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-String)
[![sql_injection_numeric](../../../../_badges/rootme/web_server/sql_injection_numeric.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Numeric)
[![sql_injection_routed](../../../../_badges/rootme/web_server/sql_injection_routed.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-Injection-Routed)
[![sql_injection_error](../../../../_badges/rootme/web_server/sql_injection_error.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Error)

<div class="row row-cols-lg-2"><div>

Most websites are using a [relational database](/programming-languages/databases/relational/_knowledge/index.md) to store data, and the [SQL](/programming-languages/databases/relational/sql/index.md) query language to query the database.

When making a SQL request, a programmer may use the user input. For instance, a product name for a query to search a product.

A vulnerable [PHP](/programming-languages/web/php/_general/index.md) code use the user input directly in the SQL request:

```php!
$name = $_GET['name']; // filled by the user
$sql = "Select name from product where name LIKE '%$name%'";
```

There is a SQL injection when a user inputs SQL code, and the request interpret the user input as SQL code.

‚úÖ If the user enters the product name "`yummy`"


```sql!
Select name from product where name LIKE '%yummy%'";
```
</div><div>

‚ùå But, with the product name "`' UNION SELECT "hacked"-- -`", the injected SQL code is executed just fine.

```sql!
Select name from product where name LIKE '%' UNION SELECT "hacked"-- -%'
```

‚û°Ô∏è A hacker may be able to fetch/create/update/delete records!

üî• While SQL injections are known since 1998, they are still a frequent vulnerability found in applications. They are found in every language.

<br>

**Tools** ü§ñ

* [sqlmap](/cybersecurity/red-team/s3.exploitation/tools/sqlmap.md) (discovery+exploitation)
</div></div>

<hr class="sep-both">

## SQLi categories

<div class="row row-cols-lg-2"><div>

**In-band SQLi** üé∏ is a category of SQLi attacks for those using the same channel to attack and to gather results.

* [Error-based](files/error_sqli.md)
* [Union-based](files/union_sqli.md)

</div><div>

**Blind/inferential SQLi** üó∫Ô∏è is a category of SQLi attacks for which we observe the application response to infer results.

* [Boolean-based](files/boolean_sqli.md)
* [Time-based](files/time_sqli.md)
* Out-of-band-based
* Voice-based
* Stacked queries-based (`req1 ; req2`)
</div></div>

<hr class="sep-both">

## SQLi payloads

[![sqlinjectionfundamentals](../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![sqlinjectionlm](../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)

<table class="table table-bordered border-dark table-dark bg-transparent mt-3">
<thead>
<tr><th>Name</th><th>Expected SQL</th><th>Payload</th></tr>
</thead>
<tbody>

<tr><td>Usual PoC</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>'</code><br><small>The query will fail as there would be 3 quotes,<br> and that would confirm that an injection is possible.</small></td></tr>

<tr><td>NoPassword</td><td><code>Select [...] where username='here' AND password='...' [...]</code></td><td><code>' OR 1=1 -- -</code><br><small>The query will bypass the check of the password,<br>if it was made in the query.<br>We use 1=1 for maximum compatibility.</small></td></tr>

<tr><td>Input box String</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>' code -- -</code></td></tr>

<tr><td>Input box Non-String</td><td><code>Select [...] where xxx=here [...]</code></td><td><code>'' code -- -</code></td></tr>

<tr><td>Update</td><td><code>Update [...] set x='here',y=[...]</code></td><td><code>',x=(code),y='</code></td></tr>
</tbody></table>

Other characters such as `"`, `)`, `#`, `;`, and their URL-encoded versions can be used to detect a SQL injection.

üêà As [Union-based](files/union_sqli.md) are used in most other techniques, many payloads are here too.

<hr class="sep-both">

## SQLi Filesystem Attacks

<div class="row row-cols-lg-2"><div>

SQL injections can be used to read/write files if the user as sufficient permissions. Aside from root, it's not common.

[This section was moved here](/cybersecurity/red-team/s3.exploitation/vulns/others/database/filesystem.md).
</div><div>
</div></div>

<hr class="sep-both">

## SQLi mitigations üõ°Ô∏è

<div class="row row-cols-md-2 mt-3"><div>

* Use **prepared requests** (statements), they are ensuring that the parameters of your queries are not interpreted as SQL code

* **Input validation** or **escaping user input**: You can filter and validate input, but you CAN'T rely on it, as your filter will _most likely_ be bypassed. Front-end validations are not enough.

* **Do not trust anyone** üìå. SQL injections may be delayed. For instance, one may have protected the login queries, but if someone submitted SQL code as their username, then any other request using the username may interpret it.

* **Keep quiet about errors** ü™≤. Do not display SQL/DBMS errors. Do not be too specific either. For instance, some use `invalid credentials` instead of `invalid password` to prevent mappings.
</div><div>

* **Apply the least privilege principle** üî´. Use accounts with the least permission. Restrict/Revoke file permissions.

Some network security devices such as a WAF may be configured to detect/block SQLi attacks and other common attacks.

<br>

**Pentester By-pass/notes** üîè

* You can bypass client side verifications by manually sending the form or directly interacting with the API (if any).

* For manual SQLi, you may use the HTML tags "names" in the form first, as they may be the name of the attributes in the database.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* [sqlinjection.net](https://www.sqlinjection.net/)
* Inline queries: a query in a query
* `/* */` is not often used in injections. Foolish example: `u=admin'/*` and `p=*/ OR ''='`
* Routed SQL Injection. Can use `"0x" + "-1' union <payload>-- -".encode().hex()` then `select 0x<...>`. [![sql_injection_routed](../../../../_badges/rootme/web_server/sql_injection_routed.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-Injection-Routed)
* `select xxx,yyy,zzz [...] where [...] union select 'xxx','yyy','zzz'`: auth bypass by hard-coded user creation
* A program creating a file then deleting it => `Disable inheritance, Convert to explicit, Select user > Edit > Show advanced permissions, uncheck both 'delete'` to prevent them from removing the file and allow us to read it.
</div><div>
</div></div>