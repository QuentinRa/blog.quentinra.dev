<hr class="sep-both">

## Knowledge about Windows

*It will, most likely, not change your life much if you know this, but, it's interesting I think.*

<div class="row row-cols-md-2"><div>

**File system**

Modern versions of Windows are using the New Technology File System (**NTFS**). Before, FAT16/32, and HPFS were used. FAT is still used for stuff like USB keys. NTFS is a file system that can repair itself in case of failure, using logs. It's known as a journaling file system.

**Task Manager** (`taskmgr`)

* Shortcut: <kbd>CTRL+SHIFT+ESC</kbd>
* List running processes
* This guide is quite complete [Windows Task Manager](https://www.howtogeek.com/405806/windows-task-manager-the-complete-guide/)

**Control panel** (`control`)

* This is the entry point to most settings
* In the top-right corner, it's possible to switch to another view <small>(ex: small icons)</small>, in which you may discover menus that you never opened before, but may but useful one way or another.

**Windows Update** (`control /name Microsoft.WindowsUpdate`)

A service looking for updates, downloading them, and asking <small>(or, forcing since Windows 10)</small> the user to install them. They are typically released on the 2nd Tuesday of each month (Patch Tuesday), unless there is an important patch.

**Windows security** / **Windows defender**

A set of tools to protect your Windows. There is an antivirus, which has a "ransomware protection" feature. There is a firewall to set rules for your network traffic. [SmartScreen](https://learn.microsoft.com/en-us/windows/security/threat-protection/microsoft-defender-smartscreen/microsoft-defender-smartscreen-overview) was design to protects against phishing or malware, and there is a tab with security features such as Core isolation.
</div><div>

**Users**

* `Administrator`: manage users, apps, groups, system-wide settings...
* `Standard User`: can use apps, can access their files

When there is a need for a user to elevate, Windows will show the User Account Control (UAC), in which a root user can press "yes", and a non-root user will have to log in using an account having sufficient privileges to do the requested action.

There is one funny/easy exploit using UAC to get root: [CVE-2019-1388](https://github.com/nobodyatall648/CVE-2019-1388).

**Permissions**

Windows has 7 categories of permissions: Read, Write, Read & Execute, List Folder Contents, Modify, Full Control. You can learn more about them in this [article](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/bb727008(v=technet.10)#understanding-file-and-folder-permissions). Permissions are controlled by Discretionary Access Control List (DACLs), see the `icacls` command.

The administrator can set permissions for a group, and users may be in multiple groups.

**BitLocker**

The Trusted Platform Module (TPM) hardware component providing security against tampering, or many other things. BitLocker was designed "to help protect user data, and to ensure that a computer has not been tampered with while the system was offline", as per [Microsoft](https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-overview).
</div></div>

<hr class="sep-both">

## Windows handy commands

*For a complete list of commands, you may check [Windows server shell reference](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands).*

<div class="row row-cols-md-2"><div>

Most Linux commands are available, although they are aliases to Windows commands

* `cd`: move to another folder
* `ls`: list files in a folder
* `pwd`: path to the current directory
* `cat`: print (usually small) files
* `find`: find a file/folder
* `wget`: download something
* `clear`: clear the terminal
* `gcm command`: find the executable given a command ([source](https://stackoverflow.com/questions/304319/is-there-an-equivalent-of-which-on-the-windows-command-line))

cmd commands

* `cd` / `find`
* `dir`: same as ls
* `type`: same as cat
* `cls`: same as clear

Open a Windows shell

* `powershell`: Linux-friendly console
* `cmd`: The traditional Windows console. Most commands in this course won't work on it. CMD options are usually like `/xxx`.
* `wmic` ([doc](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/wmic)): a deprecated console since Windows 10 21H1
</div><div>

Learn more about your environment

* `ver` (cmd): see Windows version
* `whoami`: see your username, or `NT AUTHORITY\SYSTEM` (root)
* `whoami /groups`: see your groups
* `hostname`: see hostname
* `ipconfig`: network configuration
* `netstat`: monitor network traffic
* `systeminfo`: see infos about the system
* `Get-ChildItem -Path Env:`: see environment variables
* `$Env:windir`: print the value of one environment variable
* `$Env:xxx = 'yyy'`: set an environment variable

Infos on a Local Machine

* `Get-LocalGroup`: list groups (users, administrators...)
* `Get-LocalUser`:list users
* `net localgroup users`:list users in the group "users"
* `net localgroup administrators`: list administrators
* `net user username`: infos about an user

> **Get help**: `help command`, `command help`, `command /?`, or `command /help`.
</div></div>

<hr class="sep-both">

## Windows environment

*Note that you may not be able to use Linux paths such as `/` instead of `c:\\`, as I'm using bellow.*

<div class="row row-cols-md-2"><div>

**Look for (sensitive?) information** üîë

* `cd /`: the root, maybe you will find something interesting?
* `/Users`: usually, each folder is associated with a user
  * `/Users/xxx/Desktop`
  * `/Users/xxx/Documents`
  * You should also check the trash-box
  * Check browser history / credentials...
* Maybe check `%appdata%`

<br>

**Windows files** <small>(it may not be `/Windows`, see `$Env:windir`/`$Env:systemroot`)</small>

* in a file explore, enter `%windir%` (or `%systemroot%`)
* `/Windows/System32/config/`: location where the **Security Account Manager** (**SAM**) database file is stored. This file is used to store users, their passwords, their groups... Modern versions of Windows use the NT hash format, commonly referred as NTLM, as the previous format was LM.
</div><div>

**Windows services** <small>(usually use "Win‚úñÔ∏èR" to open one)</small>. These are shortcuts to find in one action the menu you are looking for. Note that extension such as ".exe", or ".msc" are optional.

* `lusrmgr.msc`: list of users/groups
* `msconfig`: see services, manage system configurations
* `lsass` is responsible for authentication within Windows. There is [mimikatz/kiwi](https://github.com/gentilkiwi/mimikatz) (16.2k ‚≠ê) to extract passwords from the memory. For instance, if there is a task running belonging to a user, even if they are not logged in, we can get their password.
* `winver`: show Windows version+build, and licence holder.
* `control system`: open system info (Device/Windows specifications)
* `msinfo32`: system info (raw, can search) + hardware and services
* `UserAccountControlSettings`: change UAC settings
* `compmgmt` is responsable for managing **shares**, **running tasks**, **listing events** ([doc](https://learn.microsoft.com/en-us/windows/win32/eventlog/event-types), monitor performance (`perfmon`/`resmon`), or even manage device hardware/services.
* `regedt32/regedit`: open Windows registry, a database used to store information needed to configure the system for users/applications/devices <small>(ports in use, applications...)</small>. See the [doc](https://learn.microsoft.com/en-us/troubleshoot/windows-server/performance/windows-registry-advanced-users).
</div></div>

<hr class="sep-both">

## Windows privilege escalation

<div class="row row-cols-md-2"><div>

Privilege escalation refer to a process of obtaining super-administrator (a.k.a. Administrator) privileges, starting from a regular user.

* [LOLBAS](https://github.com/LOLBAS-Project/LOLBAS) (4.8k ‚≠ê): similar to GTFOBins on Linux, exploit the Windows executables



<hr class="sep-both">

## Volume Shadow Copy Service (VSS)

<div class="row row-cols-md-2"><div>

The Volume Shadow Copy Service (VSS) is handling the creation, and management of **shadow copies**/**snapshot** of the data backed up.  They are stored in the volume information of each drive that has the feature enabled.

They may allow a system admin to restore the system after an attack. So, hackers will most likely check them, and delete them. There may exist a "offline" version of these shadow copies.
</div><div>

To manage them

* Right-click on a hard-drive
* Select Shadow copies

> See [Volume Shadow Copy Service](https://learn.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service)
</div></div>

<hr class="sep-both">

## Alternate Data Streams (ADS)

<div class="row row-cols-md-2"><div>

On a file system using NTFS, ADS allow files to have more than one stream (`flux`) of data. By default, every file has only one stream: **:$DATA**. You can inspect a file using

```powershell
> Get-Item -Path SomeFile -Stream *

PSPath        : Microsoft.PowerShell.Core\FileSystem::XXX\toto.pdf::$DATA
PSParentPath  : Microsoft.PowerShell.Core\FileSystem::XXX
PSChildName   : toto.pdf::$DATA
PSDrive       : XXX
PSProvider    : Microsoft.PowerShell.Core\FileSystem
PSIsContainer : False
FileName      : XXX\toto.pdf
Stream        : :$DATA
Length        : 0
```
</div><div>

They can be used by Windows to store data, such as identifier on a file telling the operating system that this file was download from the Internet.

Hackers can use that to store malicious code inside a file. They can execute it like this later, for instance using a legit/non-malicious application

```powershell
> $(Resolve-Path .\file.exe:stream)
```

More about it:

* [Introduction to Alternate Data Streams](https://www.malwarebytes.com/blog/news/2015/07/introduction-to-alternate-data-streams)
</div></div>

<hr class="sep-both">

## Active directory (AD)

[![winadbasics](../../_badges/thm/winadbasics.svg)](https://tryhackme.com/room/winadbasics)

[Active Directory Exploitation Cheat Sheet](https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet) (3.4k ‚≠ê)

<div class="row row-cols-md-2"><div>

Microsoft Active Directory (**AD**) is used by organisations to manage their computers, users, groups, privileges of every entity... from one computer called **Domain Controller (DC)**.

From the Domain Controller, we can open the **Active Directory Domain Service** (AD DS) from the search bar, to manage entities such as computers/users/... referred within the application as **objects**.

Objects are organised into **Organizational Units (OUs)** which are folders or containers. You have some default one such as `Builtin` <small>(default groups...)</small>; `Computers`; `Domain Controllers`; `Users` and some others.

> Computers include Workstations <small>(usual computer that the user will use to log in to the Windows domain: `DomainName\Username`)</small> and Servers.

**Delegate control**

The main use of OUs is to apply policies. For instance, you may want the user XXX to be able to perform the operation YYY on any object of a category, such as a staff being able to reset passwords of any client. This is called **delegating control**.

* Right-click on an organisation unit (ex: regular-users)
* Select "Delegate control"
* Add users that will be able to use the new privilege
* Then, press next, and select what the selected users will be able to do on the objects contained in this OU.

> **Note** that policies are applied to the OU, and on any nested OU.

**Create/Delete OUs**

* You can easily create an OUs with the Right-click menu. Usually, we create a OU matching an existing service such as `Sales`, in which we add the users in the said service.
* But, to delete an OUs, you first need to disable the protection against accidental removal. Click on View > Advanced Features. Then Edit the properties of your OUs, and in Objects, uncheck the protection. Then, you can remove it.
</div><div>

**Security Principals** ([doc](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-principals))

This is objects that can be authenticated. This includes users, and computers. For the latter, an account is automatically created with a username corresponding to the machine name appended with a dollar (`$`), while the password is a randomly generated string of 120 characters. A computer account is the local administrator of the machine.

**Group Policy Management**

This is another service that can be used to manage **Security Groups**. They are used for convenience, as instead of assigning permissions to each user, we can assign permission to groups, and give groups to users.

**Group Policy Objects (GPO)** are a set of policies/rules that can be applied to an OU. For instance, we may want to force every user to have a password of a least $n$ characters. Inside the GPO OU, we can create our policies. The **Scope** determine where the GPO will be applied. Simply drag and drop the policies to an OU, and the OU along every child will have the GPO applied to them. Changes are distributed to the network via a network share called SYSVOL (`C:\Windows\SYSVOL\sysvol\`). It may take time for the changes to applies, but they can be forced with `gpupdate /force`.

**Kerberos**

This is the authentication system in Windows domains, replacing NetNTLM. Users will log in to the Kerberos service and receive a ticket called **Ticket Granting Ticket (TGT)**. They will use this ticket when requesting access to a share/database/... If the request is accepted, Kerberos will give them a **Ticket Granting Service (TGS)** allowing them to access the service. Then, they will use the TGS to login to the service. No credentials are sent over the network.

**Namespace**

It's possible to fragment the Windows domain into sections. We refer to the whole Windows domain as a Tree. It's possible to use multiple Windows domain, in which case the whole is called a Forest. We can establish Trust Relationships
 between them, allowing them to interact with each other.
</div></div>