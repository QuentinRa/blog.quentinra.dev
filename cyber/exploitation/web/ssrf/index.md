# Server-Side Request Forgery

[![ssrfqi](../../../_badges/thmp/ssrfqi.svg)](https://tryhackme.com/room/ssrfqi)
[![testingforssrf](../../../_badges/owasp/testingforssrf.svg)](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery)

<div class="row row-cols-md-2"><div>

Server-Side Request Forgery (**SSRF**) is possible when a server A is making a request to a server B while creating the request using input that can be injected by the user.

It could be 

* a website using an internal/external API
* a website using resources located on another machine
* ...

There are two kind of SSRF

* **Regular SSRF**: the client will see the result
* **Blind SSRF**: nothing is returned to the client
  * You can use [Burp Collaborator client](https://portswigger.net/burp/documentation/desktop/tools/collaborator-client)
  * You can use [requestbin](https://requestbin.com/)
</div><div>

It uses for a hacker are

* mapping an internal network (ports/...)
* stealing API credentials
* stealing files
* ...

A vulnerable entrypoint to this attack could be

* an URL <small>(is there a route/path/partial path looking like an API call?)</small>
* a form <small>(a normal field such as a form in which we need to pick an avatar in a list of images, an hidden field...)</small>
* a script
* ...
</div></div>

<hr class="sep-both">

## Some examples

*See [PayloadsAllTheThings/SSRF](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Request%20Forgery)*

<div class="row row-cols-md-2"><div>

**Access another untended path** ‚úÇ<br> `a?api=path` $\to$ `b/path`

In that case, you could guess that the first server A is mapping the value given to `api` to the server b. You may try to inject the path, and see if you can access other API routes.

**Phishing** üé£<br> `a?url=some_url` $\to$ `a?url=malicious_url`

An **open redirect** endpoint is redirecting every user to another URL. For instance, in mails, tools such as HubSpot, replace every link in a mail with another one that will redirect to the original one, but record that the user opened the link at XXX, so that the company will understand their users behaviors. Well, if a website doing this redirect do not check the URL the user is redirected to, then a hacker may be able to use a trusted website (a trusted URL) to redirect targets (fishes üêü) to a malicious website.

</div><div>

**Steal API credentials** üóùÔ∏è<br> `a?api=xxx&r=path` $\to$ `xxx.b/path`

It's possible that the website is making requests to multiple APIs according to what the user wants. For instance, an API for Pok√©mon, and another for foods. Let's say, for food, the request will be made to `foods.thebestapi.com`, and for Pok√©mon, il will be `pokemon.thebestapi.com`. At first glance, the developer might think that's as we are always calling a subdomain of `thebestapi.com`, it's "safe". But, a hacker may use a trick like giving the following value `api=malicious_website.com&ignore=&r=path`. If so, the request will be made to `malicious_website.com?ignore=thebestapi.com/path`, as we gave the following value to `api`:`malicious_website.com&ignore=`. The goal of such redirect to another website is stealing the API keys stored in the headers.

**Mapping ports/services** üó∫Ô∏è

You could enter a URL such as `http://localhost:22` to test if the port `22` is open. You could also make the server call `http://ifconfig.pro/` to get some information (IP, DNS...).

**Steal files** üí∞

You might be able to steal files too, using URLs such as `file://some/file/on/the/target`.
</div></div>

<hr class="sep-both">

## Mitigations

<div class="row row-cols-md-2"><div>

**Allow List/Whitelist**

It's usually the better way. But, if there is condition is something like `URL is starting with https://example.com`, then it can be easily bypassed with `https://example.com.malicious.website`.

**Others**

* Check that the resource type is what was expected
* ...

</div><div>

**Deny list/Blacklist**

You may allow every IP aside from some such as localhost (127.0.0.1), or 169.254.169.254 in cloud environment, but there is usually a lot of way to bypass such filters. For instance, `0`, `00`, `000[...]0`, `0.0.0.0`, `127.1` (IP shortening), `2130706433` (decimal), `017700000001` (octal) and many more such as [127.0.0.1.nip.io](http://127.0.0.1.nip.io)/[localtest.me](http://localtest.me) are all resolving to `127.0.0.1`.
</div></div>